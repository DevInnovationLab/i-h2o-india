---
title: "Spatially Disaggregated Analysis Odisha "
author: Alex Lehner, April2023
#bibliography: alex_india.bib
#output: html_notebook
output:
  pdf_document: default
  dev: cairo_pdf
---

This script constructs census data for Odisha at the village level and merges it with geographic information to spatially visualize the data. The data come from the SHRUG. These data were later merged with information on stunting and wasting from the Geographic Insights project of Harvard.

In July 2023 we added data on U6 children which was collected/downloaded by Michelle in the form of .xls sheets for each of the target districts.

The data is then saved into the `odisha_interactive` folder such that it can display in the Odisha shinyapp as well.

Power calculations are done in the `power_odisha.Rmd` notebook.

```{r setup, include=FALSE}
# the baseline structure of this was taken over from the Nigeria git (prepared a report for MK et al - no shiny app, however)
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, include = FALSE, warning = FALSE, message = FALSE)
rm(list = ls())
library(sf)
library(rnaturalearth)
library(tmap)
library(stars)
library(tidyverse)

```

# DATA CONSTRUCTION

### Bring in Census + Geographic Insights Data

```{r vilpredictions}
# FILENAME CHANGE IN THE KENYA FOLDER
india.vil <- readstata13::read.dta13("/Users/alexanderlehner/Library/CloudStorage/Box-Box/Chlorine Coupons Kenya/1_Data/3_Secondary Data/Harvard_Geographic_Insights/village_predictions_census2011_share.dta")
# what is the unit for the three variables?

```

### SHRUG plus merging

```{r shrug}


vil.sf <- sf::st_read("/Users/alexanderlehner/Library/CloudStorage/Box-Box/Chlorine Coupons Kenya/1_Data/3_Secondary Data/Harvard_Geographic_Insights/geometries_shrug-v1/village.gpkg")
distr.sf <- sf::st_read("/Users/alexanderlehner/Library/CloudStorage/Box-Box/Chlorine Coupons Kenya/1_Data/3_Secondary Data/Harvard_Geographic_Insights/geometries_shrug-v1/district.gpkg")

census11 <- read_csv("/Users/alexanderlehner/Library/CloudStorage/Box-Box/Chlorine Coupons Kenya/1_Data/3_Secondary Data/Harvard_Geographic_Insights/csv_shrug-v1/shrug-v1.5.samosa-pop-econ-census-csv/shrug_pc11.csv")
census11.distrkey <- read_csv("/Users/alexanderlehner/Library/CloudStorage/Box-Box/Chlorine Coupons Kenya/1_Data/3_Secondary Data/Harvard_Geographic_Insights/csv_shrug-v1/shrug-v1.5.samosa-keys-csv/shrug_pc11_subdistrict_key.csv") # load the SUBdistrict keys (which also includes state keys and names), you never know, maybe we need the subdistrict at some point as a unit of aggregation (the geographic data for it we have)

# add population
#census11.pop <- 

census11 <- left_join(census11, census11.distrkey, by = "shrid")

# now we need to match the shrug geofile onto that
# create the shrid for the geofile (no documentation found, AL eyeballed this from cross-checking)

vil.sf$shrid <- paste0("11-", vil.sf$pc11_state_id, "-", vil.sf$pc11_town_village_id)

census11 <- left_join(census11, vil.sf, by = "shrid", suffix=c("",".y")) %>%
  select(-ends_with(".y")) # drop duplicate columns

# create the census identifier by concatenating strings
census11$census_2011 <- stringr::str_c(census11$pc11_state_id, census11$pc11_district_id, census11$pc11_subdistrict_id, census11$pc11_town_village_id)

census11 <- left_join(census11, india.vil, by = "census_2011")

# need to (re)set the geometry for Census11
census11 <- st_set_geometry(census11, census11$geom)
# takes a bit, not super elegant (should have done the filter by odisha before to save time):
census11 <- st_set_geometry(census11, st_geometry(st_centroid(census11)))

census11.odisha <- census11 |> dplyr::filter(state_name == "Odisha")

# create new variables
census11.odisha$share_scst <- (census11.odisha$pc11_pca_p_sc+census11.odisha$pc11_pca_p_st) / census11.odisha$pc11_pca_tot_p
census11.odisha$share_lit <- (census11.odisha$pc11_pca_p_lit) / census11.odisha$pc11_pca_tot_p

summary(census11.odisha$share_scst)
summary(census11.odisha$pc11_vd_tar_road)

# some funnels
plot(census11.odisha$pc11_pca_tot_p, census11.odisha$share_lit)
plot(census11.odisha$pc11_pca_tot_p, census11.odisha$share_scst)

census11.odisha <- census11.odisha |> dplyr::select(pc11_district_id, pc11_subdistrict_id, pc11_town_village_id,
                                                    town_village_name, census_2011, state_name, dist_name, village_name,
                                                    pc11_pca_tot_p, pc11_pca_no_hh, share_scst, share_lit,
                                                    stunting, underweight, wasting)
st_geometry(census11.odisha)
#write_rds(census11.odisha, "Odisha2011_points.rds")
```

### Primar Census Abstract - blockwise

Load this data downloaded from census india (variables not available in the SHRUG)

```{r}

crosscheck <- census11.odisha |> filter(dist_name == "Kalahandi")
path <- "../data/census/2011_primary_census_abstract_blockwise"
distrfiles <- list.files(path)

# do it for first
temp.dist <- readxl::read_xlsx(paste0(path, "/", distrfiles[[1]]))
# do it for the rest, appending to the existing container
for (i in 2:length(distrfiles)) {
  #print(i)
  temp.dist1 <- readxl::read_xlsx(paste0(path, "/", distrfiles[[i]]))
  temp.dist <- bind_rows(temp.dist, temp.dist1)
}
rm(temp.dist1)

temp.dist <- temp.dist[temp.dist$Level %in% c("VILLAGE", "TOWN"), ] # kick out the districts and wards (not needed strictly speaking bc should be dropped automatically if no match on the ID)

temp.dist$census_2011 <- do.call(paste0, temp.dist[, 1:4]) # create census ID by concatenating the single identifiers

temp.dist <- temp.dist |> select(census_2011, Level, No_HH, TOT_P, TOT_M, TOT_F, P_06, M_06, F_06) #extract the relevant variables

census11.odisha <- left_join(census11.odisha, temp.dist, by = "census_2011") # merge onto existing dataframe
is.na(census11.odisha$No_HH) |> sum() 

#View(census11.odisha |> filter(dist_name == "Kalahandi"))

write_rds(census11.odisha, "odisha_interactive/Odisha2011_points.rds") # print out the new dataframe as rds directly into the app (for powercalcs I load out of there)

```



# ANALYSIS

```{r}
# CHUNCK NOT NEEDED ANYMORE I THINK
vil.sf$town_village_name


# THIS IS ONLY the harvard geodata on vil:
# create the census identifier by concatenating strings
vil.sf$census_2011 <- stringr::str_c(vil.sf$pc11_state_id, vil.sf$pc11_district_id, vil.sf$pc11_subdistrict_id, vil.sf$pc11_town_village_id)


vil.sf <- left_join(vil.sf, india.vil, by = "census_2011")

# select ODISHA
vil.odisha <- vil.sf |> dplyr::filter(state_name == "Odisha") #|> st_drop_geometry()
vil.odisha.means <- vil.odisha %>% group_by(dist_name) %>%
  summarize(underweight = mean(underweight),
            stunting = mean(stunting),
            wasting = mean(wasting))

vil.odisha.means %>% arrange(desc(underweight))

# get in data from akanksha and astha (nfhs)
# odisha.u5mr <- read.csv("CHANGEODISHANEWDATAup_districts_u5mr.csv")
# str_detect(str_to_lower(vil.odisha.means$dist_name), odisha.u5mr$District)
# # merge with summary from the harvard geographic
# vil.odisha.means$dist_name <- str_to_lower(vil.odisha.means$dist_name)
# odisha.u5mr.merge <- merge(vil.odisha.means, up.u5mr, by.x = "dist_name", by.y = "District")
# 
# # do some correlation checks
# 
# names(up.u5mr.merge)[5] <- "child.births"
# names(up.u5mr.merge)[6] <- "child.nosurvive"
# names(up.u5mr.merge)[8] <- "diarrhea"
# names(up.u5mr.merge)[9] <- "tap.water"
# corrplot::corrplot(cor(up.u5mr.merge[,-1], use="complete.obs"), method = "number")
# 
# ggplot(data = up.u5mr.merge, aes(x = tap.water, y = U5MR)) + geom_point() + stat_smooth(method = "lm")
# ggplot(data = up.u5mr.merge, aes(x = stunting, y = U5MR)) + geom_point() + stat_smooth(method = "lm")
```

```{r}
tmap_mode("view")
tm_shape(st_centroid(vil.odisha)) + tm_dots()
```
