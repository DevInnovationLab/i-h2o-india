---
title: "Power Considerations for Village RCT Odisha"
author: Alex Lehner, May2023
#bibliography: alex_india.bib
#output: html_notebook
output:
  pdf_document: default
  dev: cairo_pdf
---


```{r}
#' Logit
#' @param x numeric
#' @return
#' @export
logit <- function(x) log(x/(1-x))

#' Inverse logit
#' @param x numeric
#' @return
#' @export
inv_logit <- function(x) {exp(x)/(1+exp(x))}
# THIS IS JUST plogis()

```



Questions unresolved:
- which villages have the SVS scheme?
- district mortality from latest DHS
- U2MR goes from 120 to 90 in Kano (from U5), so 
- eyeball U2MR as 65 now

Based on early back-of-the-envelope I recommended 1 to 3k villages needed for randomization. Then I did more sophisticated calculations where I showed what happens if we go to all villages in one district



```{r setup, include=FALSE}
# the raw data is first extracted and transformed in the dataclean file
# the code for the analysis was first tested in the nigeria_DHS_extraction_analysis.R script
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, include = FALSE, warning = FALSE, message = FALSE)
rm(list = ls())
library(sf)
library(rnaturalearth)
library(tmap)
library(stars)
library(tidyverse)

# from meta_helpers.R file:
back_out_MDE_reduction_2proptest_cluster <- function(n_cluster, n_per_cluster, MR, power_choice = .8, ICC_choice = .01, ...) {
  # i wanna get out the MDE, like in the individual case
  # first i compute the proportion that I can detect, given parameters
  # https://rdrr.io/cran/clusterPower/man/cpa.binary.html
  # we could also build in a CV for clustersize if wanted
  # BUG IN EARLY VERSIONS IN NOVEMBER: ncluster is PER condition, so it has to be divided 2
  # Jun2023: passed over the power_choice correctly into the cpa.binary (never wanted to do anything else than 80% before)
  power.out <- clusterPower::cpa.binary(nclusters = n_cluster/2, nsubjects = n_per_cluster, ICC = ICC_choice, p1 = MR, p1inc = TRUE, power = power_choice,
                                        tol = .Machine$double.eps^.5, ...)
  # just back out the MDE now
  (1 - power.out[[1]] / MR) * 1e2
}

# loading and selecting of variables + subsetting
odisha2011 <- readRDS("odisha_interactive/Odisha2011_points.rds")
odisha2011 <- odisha2011 |> dplyr::select(-(1:3))
odisha.dists <- unique(odisha2011$dist_name) |> sort()
namesselect <- names(odisha2011)[6:12]
odisha2011$dist_name <- str_to_lower(odisha2011$dist_name)

dhs19 <- read_csv("odisha_interactive/astha_dhs2019.csv")
dhs19 <- dhs19[1:(nrow(dhs19)-3), ]

selected_distr <- c("Rayagada", "Kandhamal", "nabarangapur", "Kalahandi") |> str_to_lower()
dhs19 <- dhs19[dhs19$District %in% selected_distr, ]
dhs19 <- dhs19 |> select(District, `Percentage of preg women in district`)
names(dhs19)[2] <- "perc_preg"

# do the adjustment for pop growth and u6 -> u5
odisha2011$P_05_approx <- odisha2011$P_06 * (5/6) * 1.1

# compute aggregates
odishasum <- odisha2011 |> st_drop_geometry() |> group_by(dist_name) |> 
  summarise(avg_hh_per_vil = mean(pc11_pca_no_hh),
            avg_u5_approx = mean(P_05_approx), # July 3rd, add U6 from village census abstract
            CV_u5_approx  = sd(P_05_approx) / mean(P_05_approx),
            num_hh = sum(pc11_pca_no_hh),
            tot_pop = sum(pc11_pca_tot_p),
            num_vil = n())
# select relevant districts
odishasum <- odishasum[odishasum$dist_name %in% selected_distr, ]

odishasum <- left_join(odishasum, dhs19, by = c("dist_name" = "District")) # merge
# pregnant women - levels
odishasum$avg_preg_per_vil <- round(odishasum$avg_hh_per_vil * (odishasum$perc_preg/100), 2)
odishasum$ss_if_all_vil_visited <- odishasum$avg_preg_per_vil * odishasum$num_vil

# add U2 U5MR, perc water cover and perc SVS
# ... first, reorder to the order in one of the GDocs (https://docs.google.com/spreadsheets/d/1876Ut6NbNp-tCwECXbtC4v6JQ0V_GG1F/edit#gid=1567497203)
# ... so that I can 
odishasum <- odishasum[order(match(odishasum$dist_name, c("rayagada", "kandhamal", "nabarangapur", "kalahandi"))), ]

# put that in by hand from astha's sheet
odishasum$U5MR_23        <- c(83.67, 59.68, 55.16, 48.86)
odishasum$perc_tapwater  <- c(47.31, 41.36, 62.94, 49.89)
odishasum$perc_SVS_solar <- c(22.8, 58.7, 54, 74.8)
odishasum$perc_SVS       <- c(11.4, 35.4, 54, 60.6)

odishasum$U2MR_23 <- odishasum$U5MR_23 * 0.914 # rough approximation to get at U2MR from Akito

# reorder alphabetically
odishasum <- odishasum[order(odishasum$dist_name), ]


# calculate APPROXIMATE number of households that would qualify
odishasum$num_hh_SVS <- odishasum$num_hh * (odishasum$perc_SVS_solar / 100)
odishasum$num_vil_SVS <- odishasum$num_vil * (odishasum$perc_SVS_solar / 100)

# want to plug in the number of mothers per  [[1]]

# this is an approximate first shot, what would be the MDE, if the whole district would be visitied
odishasum_SVSsubs <- odishasum |> dplyr::select(dist_name, num_vil_SVS, avg_preg_per_vil, U2MR_23, avg_u5_approx, CV_u5_approx)
odishasum_SVSsubs$MDE_fulldistr <- NA
# this should be either 2 or 5:
studylength <- 2 # in years
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_fulldistr[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = odishasum_SVSsubs$num_vil_SVS[[i]], 
    n_per_cluster = odishasum_SVSsubs$avg_preg_per_vil[[i]] * studylength,  # MULTIPLY BY TWO FOR A TWO YEAR STUDY (very approx!!)
    MR = odishasum_SVSsubs$U2MR_23[[i]]/1e3, 
    ICC = 0.01) |> round(2)
}

odishasum_SVSsubs$num_vil_SVS <- round(odishasum_SVSsubs$num_vil_SVS)

# now we do the same for 800 villages
odishasum_SVSsubs$MDE_800vil <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_800vil[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = 800, 
    n_per_cluster = odishasum_SVSsubs$avg_preg_per_vil[[i]] * studylength,  # MULTIPLY BY TWO FOR A TWO YEAR STUDY (very approx!!)
    MR = odishasum_SVSsubs$U2MR_23[[i]]/1e3, 
    ICC = 0.01) |> round(2)
}

odishasum_SVSsubs$MDE_800vil[odishasum_SVSsubs$num_vil_SVS < 800] <- NA

knitr::kable(odishasum_SVSsubs, format = "simple")

```


# full MDEs

now we want the weighted U2 MR

```{r}
# can we get a number of villages in india to match the c. 9% raw MDE from the gw proposal?

odishasum_SVSsubs$num_vil_weighted <- odishasum_SVSsubs$U2MR_23 * (odishasum_SVSsubs$num_vil_SVS / sum(odishasum_SVSsubs$num_vil_SVS))

# do a uniform weighted U2MR and add villages

# do a 2 year and a 5 year, take into account the older kids at initial?

# now we take kalahandi and nabarangpur

odishasum_SVSsubs_2dist <- odishasum_SVSsubs[odishasum_SVSsubs$dist_name %in% c("kalahandi", "nabarangapur"), ]

vil_agg <- sum(odishasum_SVSsubs_2dist$num_vil_SVS)
n_preg_weighted <- weighted.mean(odishasum_SVSsubs_2dist$avg_preg_per_vil, odishasum_SVSsubs_2dist$num_vil_SVS)
U2MR_weighted <- weighted.mean(odishasum_SVSsubs_2dist$U2MR_23, odishasum_SVSsubs_2dist$num_vil_SVS)


# then do the calc
 back_out_MDE_reduction_2proptest_cluster(
    n_cluster = vil_agg, 
    n_per_cluster = n_preg_weighted * studylength,  # MULTIPLY BY TWO FOR A TWO YEAR STUDY (very approx!!)
    MR = U2MR_weighted/1e3, 
    ICC = 0.01) |> round(2)

```


# Diarrhea Powercalculations for Odisha Pilot

We have district level diarrhea incidence from an NFHS survey. Not for the geolocalised DHS clusters yet (h11 variable), this would allow us to do simulations and see how much variation we can partial out with a block fixed effect.

```{r}
# CONVERSATION ON SLACK on Jun 27th (evening) + Jun 28th (morning)

# the Amy Pickering paper on Bandladesh is here: https://www.thelancet.com/journals/langlo/article/PIIS2214-109X(19)30315-8/fulltext#seccestitle150

# @Alex Lehner
#  Michael would like to see power calculations for India for Phase 1 RCT. Can you re-run those as powered for diarrhea at 90% power? My understanding is that in the past you use UP data, but we are now working on Odisha. This is quite urgent just to have a sense whether what we proposed (150 villages, 75 T, 75 C) will be enough. CC-ing 
# @Akito
#  
# @Akanksha Saletore
#  
# @Michelle Cherian
#  FYI
# 
# Alex Lehner
# :airplane:  21 hours ago
# Hi 
# @Elisa Maffioli
# , I never did power calculations on diarrhea, only mortality. I found district wise diarrhea rates in this sheet, they are roughly 5% - which seems very low. Probably this is because the question asked is “did your child have diarrhea in the last two weeks” or something. So which baseline diarrhea rate to pick depends now on how often you plan to survey or how far back to include diarrhea incidence. Do you have a sense for that? Also, do you know details about randomization, e.g. stratification by block etc? (cc 
# @Witold Więcek
# ) Edit: I did have a conversation with Michael on that a while back and we concluded that the best would be to go just above the level of where we can implement ILC (the village?) and then stratify at that level (i.e. having a block of 2 or more villages and randomize within that. The question is whether these villages can be adjacent to each other (spillovers, IRB concerns, etc?) or there have been any other updates on that due to field visits etc? (edited) 
#                                                                                                                                                                                                                      
# Hi 
# @Alex Lehner
#  thanks! Can you do power calcs on 3 separate districts (Rayagada, Khandamal, and Kalahandi and then a mean between those) - even tough basically is either 4 or 5% all the time? Level of randomization is village level. Lets assume no stratification for now. We usually ask diarrhea in 2 weeks prior (or even 1 week) but whatever we have the data for is OK right now. Right now we are planning to follow-up 3 times? 
# @Akanksha Saletore
#  can you confirm this is correct and consistent with JPAL assumptions? 
# @Michelle Cherian
#  
# @Akanksha Saletore
#  
# @Astha Vohra
#  do you remember how we come up with 150 villages (I remember originally was 80, then 100 and then to be saved 150 for IRB) but I do not remember how we started at 80 if no one has run power calcs. Thanks a lot! (edited) 
# 
# 
# Elisa Maffioli
#   19 hours ago
# Can someone look in Amy's paper on Bangladesh and share what is the reduction she found? We can assume that as MDE. 
# @Michelle Cherian
#  
# @Akanksha Saletore
# 
# 
# Michelle Cherian
#   17 hours ago
# Hi 
# @Alex Lehner
#  
# @Elisa Maffioli
#  yes the diarrhea estimates from NFHS are prevalence rates 2 weeks before the survey. We unfortunately don't have annual estimates. The Odisha state govt does have such data but we're waiting for approvals to come through so that we can have access to that data. I just checked Amy Pickering's paper from Bangladesh and the reduction in diarrhea among children who get chlorinated water is 2.5 pp (7.5% treatment vs 10.0% in control). The paper is linked here
# 
# 
# Michelle Cherian
#   17 hours ago
# I can confirm that we are planning to follow-up 3 times during the Phase 1 RCT (i.e once every 4 months over a period of 12 months)
# :pray:
# 1
# 
# 
# 
# Michelle Cherian
#   17 hours ago
# @Akanksha Saletore
#  might have a better idea as to how we went from 80 to 100 to 150 villages. I think it was mostly because we were looking at either UP data or Bihar's data from the Ananya dataset. 
# @Alex Lehner
#  not sure if you remember but can you confirm if you do? (edited) 
# 
# 
# Alex Lehner
# :airplane:  17 hours ago
# Their paper has “all children younger than 5 years residing in households accessing enrolled water points were measured every 2–3 months during a 14-month follow-up period (children could migrate into or out of the cluster). The primary outcome was caregiver-reported child diarrhoea (≥3 loose or watery stools in a 24-h period [WHO criteria]) with a 1-week recall, including all available childhood observations in the analyses.” Do we have a sense for what the NFHS estimate for diarrhea in these areas of Bangladesh are? I am asking because if it turns out that they are similarly somewhere around 5% but Amy finds 10% in control with more frequent surveying, then it seems save to assume a similar scaling up for this rate also for Odisha - which will greatly help with power.
# Also, I checked in the India DHS data for diarrhea but I somehow could not find it, these are the “h11_” columns (in the Nigeria DHS that I checked they are there). If we had that in combination with the geolocalized DHS data, I could check roughly how much residual variation we could partial out with a stratum fixed-effect at some higher geographic level. (edited) 
# 
# 
# Michelle Cherian
#   17 hours ago
# @Alex Lehner
#  We don't have NFHS data for Bangladesh but I checked the DHS 2017-18 data for Bangladesh. The h11 column is available there. But I think Amy surveyed a part of Dhaka and a place called Tongi. Data in DHS is available at the district level so we won't have data for the communities she surveyed.
# Let me check the India DHS data and get back to you
# 
# 
# Michelle Cherian
#   17 hours ago
# @Alex Lehner
#  I have saved the data for child diarrhea for India here- https://drive.google.com/open?id=1emdNi8rt9AMi1uN94_0ncgYg5ihR1n_E&usp=drive_fs
# The h11 variable should now be available. The geocoded data from DHS is also added there
# :raised_hands:
# 1
# 
# 
# 
# Alex Lehner
# :airplane:  16 hours ago
# Thanks a lot Michelle. Will have a look in a bit when I am back on my computer
# 
# 
# Akanksha Saletore
#   10 hours ago
# Hi all,
# Confirming that we will do one baseline and then 3 follow-up surveys in the RCT
# Amy mentioned that in her previous project they ask about diarrhea incidence in the last one week. In previous projects I have worked on, we have asked for the last two weeks. So it will be approximately the same as NFHS
# @Elisa Maffioli
#  the number was initially 80 when we were considering UP. It increased to 100 when we moved to Odisha. In the IRB, I had written this number as 150 to allow for som buffer in case our plans change. But this was purely to give us some slack -- I think we should be considering 100 as the number unless Michael, Amy, and you have discussed otherwise
# 
# 
# 
# 
# 
# Alex Lehner
# :airplane:  10 hours ago
# @Michelle Cherian
# , I saw that it is the raw data which still needs some merging and transformation. I don’t have the capacity right now to do that myself. If you could help create a file that contains the observations for Odisha with the diarrhea outcome + lon & lat coordinates and cluster descriptives, that would be great. If not, no problem. For now, I do the simple randomization only, as Elisa suggested.
# 
# 
# 
# 
# 
# Elisa Maffioli
#   3 hours ago
# @Alex Lehner
#  thanks all. If you could just run a simple randomization at village level that would be great. If you can just send me one paragraph on assumptions/scenarios and results, that would be very helpful to inform our decisions forward on budget. Then, yes, we will have to do some adjustments and I am sure MK will have opinions :slightly_smiling_face: thanks a lot!
# 
# 
# 
# 
# 
# Elisa Maffioli
#   2 hours ago
# @Alex Lehner
#  MK just asked in the call if you can run simple Stata power calcs (No simulations yet), so if you can send us some numbers today, that would be super helpful! Thank you so much!
# 
# 
# 
# 
# 
# Elisa Maffioli
#   2 hours ago
# Just also a note that you will receive a request to join Berkely-Slack so we can have this conversation on the India channel with our collaborators at Berkely. Amy should be part of this conversation so she can advice on assumptions :slightly_smiling_face:                                                                                                                                                                                                     
```


Based on the above we assume a diarrhea rate of 5% with a potential effectsize of 25%.
Number of villages will be 100 (doing also 150) [some average over districts]

```{r}

odishasum_SVSsubs$avg_u5_per_vil <- odishasum_SVSsubs$avg_preg_per_vil * 5
# load estimates from Michelle
#u5distr <- readstata13::read.dta13("under5_districtwise_odisha.dta")
odishasum_SVSsubs$diarrhea_incidence <- c(0.04, 0.05, 0.04, 0.05) # districts alphabetically kalahandi, kandhamal, nabarang, rayagad

# diarrhea comes from this sheet https://docs.google.com/spreadsheets/d/1876Ut6NbNp-tCwECXbtC4v6JQ0V_GG1F/edit#gid=1567497203
num_vil_2_visit <- 100 # acc to Akanksha, 150 from IRB was just to have some slack
odishasum_SVSsubs$MDE_diarrhea_100vil <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_diarrhea_100vil[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = num_vil_2_visit,
    n_per_cluster = odishasum_SVSsubs$avg_u5_per_vil[[i]],
    MR = odishasum_SVSsubs$diarrhea_incidence[[i]], 
    ICC = 0.01) |> round(2)
}

odishasum_SVSsubs$MDE_diarrhea_100vil_90pc <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_diarrhea_100vil_90pc[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = num_vil_2_visit,
    n_per_cluster = odishasum_SVSsubs$avg_u5_per_vil[[i]],
    MR = odishasum_SVSsubs$diarrhea_incidence[[i]], 
    ICC = 0.01,
    power_choice = .9) |> round(2)
}

# ALSO DO FOR 150 villages

odishasum_SVSsubs$avg_u5_per_vil <- odishasum_SVSsubs$avg_preg_per_vil * 5
num_vil_2_visit <- 150 # acc to Akanksha, 150 from IRB was just to have some slack
odishasum_SVSsubs$MDE_diarrhea_150vil <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_diarrhea_150vil[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = num_vil_2_visit,
    n_per_cluster = odishasum_SVSsubs$avg_u5_per_vil[[i]],
    MR = odishasum_SVSsubs$diarrhea_incidence[[i]], 
    ICC = 0.01) |> round(2)
}

odishasum_SVSsubs$MDE_diarrhea_150vil_90pc <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_diarrhea_150vil_90pc[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = num_vil_2_visit,
    n_per_cluster = odishasum_SVSsubs$avg_u5_per_vil[[i]],
    MR = odishasum_SVSsubs$diarrhea_incidence[[i]], 
    ICC = 0.01,
    power_choice = .9) |> round(2)
}


odishasum_SVSsubs




```


Text to be shared with Elisa et. al. and Amy's team:
Hi All, here are the powercalculations on diarrhea I was asked to do. I am out of office and in transit but try to be responsive on slack if there are any questions. The R code is lying on the DIL github (h20-india/reports/power_odisha).
For the four target districts I computed separate, independent MDEs. They all assume that 100 villages are being visited (and the last two columns 150). If you wanted to split across districts, the MDE would then roughly be a weighted average. The variation in MDE comes mostly from the variation in the village sizes across the different districts (have a look at this small app that I wrote to explore some of the village characteristics in more detail).
The assumption on the number of U5 children per village comes from an estimate that we have for the average number of pregnant women per village (out of an NFHS survey). I had no access to an estimate for the number of U5 children, I therefore took the estimate for pregnant women and multiplied it by 5. Please not that this introduces quite a bit of noise in the MDE computations. The MDE here refers to a percent reduction. For example, an MDE of 50 means that we are powered to detect a diarrhea reduction from 5 to 2.5 percent.
The calculations just use standard cluster randomization formulas for simple randomization (clusterPower::cpa.binary() in R). With block-randomization, stratum fixed effects would of course reduce the residual variation and therefore increase power.


```{r}
final_table_print <- odishasum_SVSsubs |> select(dist_name, num_vil_SVS, avg_preg_per_vil, avg_u5_per_vil, diarrhea_incidence, MDE_diarrhea_100vil, MDE_diarrhea_100vil_90pc, MDE_diarrhea_150vil, MDE_diarrhea_150vil_90pc)
final_table_print
```


### NEXT ITERATION: ADD THE TRUE U5 population from the census

We had a population growth in Odisha of roughly 10% since the last census. So without augmenting, we have a conservative estimate. The distribution of U5 children should be roughly the same in 2023 as in 2021.


Above we took the average expected pregnant women and multiplied that by 5. Now I have the actual U5 from the census. People - especially on Amy's team - were worried that this is not a good approximation.



```{r}
# keeping all the rest from above
# now using the actual distribution across villages and using the CV to account for the dispersion (before we just had means)
# so we do the u6 here with pop from 2011 but do not account for population growth. this should kind of give an ok approximation then

# update with an upscaling based on BGD
odishasum_SVSsubs$diarrhea_incidence <- c(0.09, 0.1, 0.09, 0.1) # districts alphabetically kalahandi, kandhamal, nabarang, rayagad

num_vil_2_visit <- 100 # acc to Akanksha, 150 from IRB was just to have some slack
odishasum_SVSsubs$MDE_diarrhea_100vil <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_diarrhea_100vil[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = num_vil_2_visit,
    n_per_cluster = odishasum_SVSsubs$avg_u5_approx[[i]],
    MR = odishasum_SVSsubs$diarrhea_incidence[[i]],
    CV = odishasum_SVSsubs$CV_u5_approx[[i]],
    ICC = 0.01) |> round(2)
}

odishasum_SVSsubs$MDE_diarrhea_100vil_90pc <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_diarrhea_100vil_90pc[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = num_vil_2_visit,
    n_per_cluster = odishasum_SVSsubs$avg_u5_approx[[i]],
    MR = odishasum_SVSsubs$diarrhea_incidence[[i]],
    CV = odishasum_SVSsubs$CV_u5_approx[[i]],
    ICC = 0.01,
    power_choice = .9) |> round(2)
}

# ALSO DO FOR 150 villages

odishasum_SVSsubs$avg_u5_per_vil <- odishasum_SVSsubs$avg_preg_per_vil * 5
num_vil_2_visit <- 150 # acc to Akanksha, 150 from IRB was just to have some slack
odishasum_SVSsubs$MDE_diarrhea_150vil <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_diarrhea_150vil[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = num_vil_2_visit,
    n_per_cluster = odishasum_SVSsubs$avg_u5_approx[[i]],
    MR = odishasum_SVSsubs$diarrhea_incidence[[i]],
    CV = odishasum_SVSsubs$CV_u5_approx[[i]],
    ICC = 0.01) |> round(2)
}

odishasum_SVSsubs$MDE_diarrhea_150vil_90pc <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  print(i)
  odishasum_SVSsubs$MDE_diarrhea_150vil_90pc[[i]] <- back_out_MDE_reduction_2proptest_cluster(
    n_cluster = num_vil_2_visit,
    n_per_cluster = odishasum_SVSsubs$avg_u5_approx[[i]],
    MR = odishasum_SVSsubs$diarrhea_incidence[[i]],
    CV = odishasum_SVSsubs$CV_u5_approx[[i]],
    ICC = 0.01,
    power_choice = .9) |> round(2)
}

# HOW MANY VILLAGES TO BE POWERED FOR 25% reduction?
odishasum_SVSsubs$nvil_for_MDE25 <- NA
for (i in 1:nrow(odishasum_SVSsubs)) {
  nclus.out <- clusterPower::cpa.binary(nsubjects = odishasum_SVSsubs$avg_u5_approx[[i]], 
                                        CV = odishasum_SVSsubs$CV_u5_approx[[i]],
                                        ICC = 0.01, 
                                        p1 = odishasum_SVSsubs$diarrhea_incidence[[i]], 
                                        p2 = odishasum_SVSsubs$diarrhea_incidence[[i]] * .75, 
                                        power = 0.8,
                                          tol = .Machine$double.eps^.5)

  # this is per condition, so we need to double
  odishasum_SVSsubs$nvil_for_MDE25[[i]] <- round(nclus.out) * 2
}

odishasum_SVSsubs

```


Now we print a final table here as well (like above)

Hi All, here are the updated diarrhea power calculations. Instead of the approximation via the number of pregnant women from the NFHS data, I used the number of under 6 children from the Indian census from 2011. This allowed me to incorporate the distribution of villages for every district (using the CV for every district in the formula). The share of children in each village should not have changed much in the last c. 10 years. To account for the fact that population grew by roughly 10% since then and we are interested in U5 and not U6, I transformed the "P_06" variable of every village by multiplying by `(5/6) * 1.1`. Again, this is simple randomization and a more sophisticated randomization strategy (such as block-randomization) will further improve power. To visually inspect the distribution of villages, please have a look at this app (the U6 population is available for the target districts only): https://lehner.shinyapps.io/odisha_interactive/. See the screenshot below and the DIL h20-india repository for the R code.



```{r}
final_table_print <- odishasum_SVSsubs |> select(dist_name, num_vil_SVS, avg_u5_approx, CV_u5_approx, diarrhea_incidence, MDE_diarrhea_100vil, MDE_diarrhea_100vil_90pc, MDE_diarrhea_150vil, MDE_diarrhea_150vil_90pc, nvil_for_MDE25)
final_table_print
```


# Repeat measurments across units (children)


### NEXT ITERATION: multiple rounds / autocorrelation

There is also a dataset for a project that Akanksha worked on [linked here](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/VAFYV1&widget=dataverse@harvard).

Here we use the data from Amy's 2019 Lancet paper.


```{r}
# find real world data from Amy's Bangladesh study in the Lancet
amy_lancet <- readstata13::read.dta13("../data/amypickering_lancet_BGD/chlorine_diarrhea_public.dta")
amy_lancet <- amy_lancet[!is.na(amy_lancet$uniqueid_entered), ]
# in paper we have 3142 and 3063 child-observations
(3142 + 3063) # number matches
table(amy_lancet$tr) # is the treatment variable

# POWER WORDING
# We	powered	the	study	to	detect	a	25%	reduction	in	the	WHO	case	definition	of	diarrhea;	our	sample	size	calculations	assumed,	based	on	prior	work,	that	diarrhea	prevalence	would	be	10%	among	children	<5	years	of	age	in	the	study	area.	We	conducted	the	power	calculations	using	a	cluster-level	means	approach	(comparing	the	mean	diarrhea	prevalence	by	cluster-time-point	between	groups)	because	we	did	not	have	a	good	estimate	for	the	intracluster	correlation	coefficient	for	diarrhea	by	water	point.	This	approach	treats	repeated	measures	at	one	point	in	time	the	same	as	repeated	measures	over	time.	Using	this	approach,	we	calculated	that	we	would	have	96%	power	with	the	study	design	(50	clusters	per	arm,	10	children	per	cluster)

table(amy_lancet$child_diarrhea)
amy_lancet$child_diarrhea1 <- ifelse(amy_lancet$child_diarrhea == "Yes", 1, 0) # make 01
table(amy_lancet$child_diarrhea1) # check
amy_lancet |> group_by(tr) |> summarise(meandia = mean(child_diarrhea1, na.rm = T))

# counts
amy_lancet |> count(round, tr, child_diarrhea1)

# ICC
fixest::feols(child_diarrhea1 ~ 0 | Block, data = amy_lancet)
fixest::feols(child_diarrhea1 ~ 0 | pumpid, data = amy_lancet) # 0.021 as compared to 0.025 in paper


logitamy <- glm(child_diarrhea1 ~ tr + round + Block, data = amy_lancet, family = "binomial")
summary(logitamy)


olsamy <- fixest::feols(child_diarrhea1 ~ tr | Block + round, data = amy_lancet)
summary(olsamy)
meanctrl <- mean(amy_lancet$child_diarrhea1[amy_lancet$tr != "trchlorine"]) 
(meanctrl + olsamy$coefficients) / meanctrl


# AUTOCORRELATION
# check how the lag works
data.frame(id = c(1,1,1,2,2,2), val = rep(1:3, 2)) |> group_by(id) |> 
  mutate(lagged = lag(val, n = 1, default = NA, order_by = id))

# sort by id and round first (is sorted by default? no but the order_By does the job):
amy_lancet <- amy_lancet %>%                           
  group_by(childidfull) %>%
  dplyr::mutate(laggedval = lag(child_diarrhea1, n = 1, default = NA, order_by = round))
View(amy_lancet |> select(round, child_diarrhea1, laggedval, diarrhea_count))

amy_lancet |> group_by(round) |> summarise(corr = cor(child_diarrhea1, laggedval, use = "complete.obs"))

lm(child_diarrhea1 ~ laggedval + childidfull, data = amy_lancet) |> summary()




# wanna see ICC + block effect
# wanna do the calc with how many unique 1's in the diarrhea case
# run the regression with indiv FE and error
olsamy <- fixest::feols(child_diarrhea1 ~ tr | round + Block, data = amy_lancet)
summary(olsamy)
summary(olsamy, vcov = ~ Block)
summary(olsamy, vcov = ~ pumpid)
summary(olsamy, vcov = ~ childidfull)
summary(olsamy, vcov = ~ Block + childidfull)

# get the means per round
amy_lancet |> group_by(round) |> summarise(meandiarrhea = mean(child_diarrhea1))

roundreg <- amy_lancet |> group_by(round) |> summarise(ols = fixest::feols(child_diarrhea1 ~ tr | Block, data = cur_data())$coefficients,
                                           tstats = summary(fixest::feols(child_diarrhea1 ~ tr | Block, data = cur_data()))$coeftable[1,3],
                                           nobs = fixest::feols(child_diarrhea1 ~ tr | Block, data = cur_data())$nobs)

roundreg$ols |> weighted.mean(w = roundreg$nobs)

test <- fixest::feols(child_diarrhea1 ~ tr | round, data = amy_lancet)
fixest::fixef(test) # |> plot()
```



```{r}


# checking diarrhea frequency

amy_lancet <- amy_lancet |> group_by(childidfull) |> mutate(diarrhea_count = sum(child_diarrhea1))

table(amy_lancet$diarrhea_count)
table(amy_lancet$diarrhea_count[amy_lancet$tr == "chlorine"])
table(amy_lancet$diarrhea_count[amy_lancet$tr != "chlorine"])


# UNIQUE CHILDREN
amy_lancet$diarrhea_ever <- ifelse(amy_lancet$diarrhea_count > 0, 1, 0) # assign a 1 if a child ever had diarrhea at some point
amy_lancet_unique <- amy_lancet[!duplicated(amy_lancet$childidfull), ]
table(amy_lancet_unique$diarrhea_ever[amy_lancet_unique$tr == "chlorine"])
table(amy_lancet_unique$diarrhea_ever[amy_lancet_unique$tr != "chlorine"])
mean(amy_lancet_unique$diarrhea_ever[amy_lancet_unique$tr == "chlorine"])
mean(amy_lancet_unique$diarrhea_ever[amy_lancet_unique$tr != "chlorine"])
# effect on unique
mean(amy_lancet_unique$diarrhea_ever[amy_lancet_unique$tr == "chlorine"]) / mean(amy_lancet_unique$diarrhea_ever[amy_lancet_unique$tr != "chlorine"])

logitever <- glm(diarrhea_ever ~ tr, data = amy_lancet_unique, family = "binomial")
summary(logitever)
exp(logitever$coefficients[2])
# effsize
olsever<- fixest::feols(diarrhea_ever ~ tr, data = amy_lancet_unique)
summary(olsever)
meanctrl <- mean(amy_lancet_unique$diarrhea_ever[amy_lancet_unique$tr != "chlorine"])
(meanctrl + olsever$coefficients[2]) / meanctrl

# effect is lower

# now we do a final thing and see how many new, independent cases get added with each round
amy_lancet$diarrhea_first <- 0

amy_lancet <- amy_lancet %>%
  #select(childidfull, round, child_diarrhea1, diarrhea_count) |> 
  group_by(childidfull) %>%
  arrange(round) |> # need to arrange by round here, otherwise the first assignment would not work - it rests on the thing being orderd
  mutate(first_1 = child_diarrhea1 == 1 & !duplicated(child_diarrhea1 == 1))  %>%
  arrange(childidfull)


amy_lancet$diarrhea_first <- ifelse(amy_lancet$first_1 == TRUE, 1, 0)


# get the percentage point add per round
roundsummary <- amy_lancet |> group_by(round) |> summarise(diarrheanew = mean(diarrhea_first)) 
roundsummary$diarrheanew |> sum()
amy_lancet |> group_by(round) |> summarise(diarrheanew = mean(diarrhea_first)) 

mean(amy_lancet$child_diarrhea1)
mean(amy_lancet$diarrhea_first)
mean(amy_lancet_unique$diarrhea_ever)
# THIS DOES NOT WORK BECAUSE NOT EVERY CHILD HAS SAME NUMBER OF ROUNDS

```


```{r}
# 100 villages with roughly 50
# broken down also by trt now
amy_lancet |> group_by(round, tr) |> summarise(diarrheanew = mean(diarrhea_first)) 
amy_lancet |> group_by(round) |> summarise(corr = cor(child_diarrhea1, laggedval, use = "complete.obs"))
amy_lancet |> group_by(round, tr) |> summarise(corr = cor(child_diarrhea1, laggedval, use = "complete.obs"))
# ICC
fixest::feols(child_diarrhea1 ~ 0 | Block, data = amy_lancet)
fixest::feols(child_diarrhea1 ~ 0 | pumpid, data = amy_lancet) |> fixest::r2()# 0.021 as compared to 0.025 in paper
ICC::ICCest(pumpid, child_diarrhea1, data = amy_lancet)$ICC
22#ICCbin::iccbin(pumpid, child_diarrhea1, data = amy_lancet, method = "aov")

# period ICCs a bit more severe
amy_lancet |> group_by(round) |> summarise(ICC = ICC::ICCest(pumpid, child_diarrhea1, data = cur_data())$ICC)


# ICC for the block randomization
amy_lancet$residual4ICC <- lm(child_diarrhea1 ~ Block, data = amy_lancet)$resid

ICC::ICCest(pumpid, residual4ICC, data = amy_lancet)$ICC


```


### Checking counts per cluster (suggested by WW)


```{r}

amy_counts <- amy_lancet |> group_by(pumpid) |> summarise(n_people = n(),
                                                          diarrh_n = sum(child_diarrhea1),
                                                          tr = tr[1])

# diarrhea counts per pump
pois_lamb <- mean(amy_counts$diarrh_n)
sd(amy_counts$diarrh_n) # not too bad, looks like pois (obviously since it is counts)
library(ggh4x); library(fitdistrplus) # had troubles to fit the dpoits without these
ggplot(data = amy_counts, aes(diarrh_n)) + geom_histogram(aes(y = stat(density))) + geom_density()
#ggplot(data = amy_counts, aes(diarrh_n)) + geom_histogram(aes(y = stat(density))) +  geom_density(aes(dpois(1:25, lambda = pois_lamb)))
ggplot(data = amy_counts, aes(diarrh_n)) + geom_histogram(aes(y = stat(density))) + geom_density() + stat_theodensity(distri = "pois", col = "red")


ggplot(data = amy_counts) + geom_histogram(aes(diarrh_n)) + facet_grid(~ tr)


plot(dpois(1:25, lambda = pois_lamb))
```



## SIMULATE MULTIPLE ROUNDS


```{r}


set.seed(123)  # Set seed for reproducibility
nV <- 550 # number of villages
nJ <- 50 # cluster size - COULD bake in variation in cluster size to match a CV
p_diar <- .05
vil <- rep(1:nV, each = nJ) # creating cluster variable
vil_frame <- data.frame(childid = 1:(nV*nJ), vilid = vil)
MDEdia <- .20
nrounds <- 5
ICCval <- .015

# do a regular powercalc
clusterPower::cpa.binary(nsubjects = nJ, 
                         nclusters = nV,
                                        CV = 1,
                                        ICC = ICCval, 
                                        p1 = p_diar, 
                                        p2 = p_diar * (1-MDEdia), 
                                          tol = .Machine$double.eps^.5)
# with one round in the simulation, you should get roughly this power number
# test <- ICCbin::rcbin(prop = p_diar, prvar = 0, noc = nV, csize = nJ, csvar = 0, rho = .01)
# mean(test$y)
# ICC::ICCest(cid, y, data = test)$ICC
# ICCbin dominates fabricatr?

nsim <- 500
runframe <- data.frame(runid = 1:nsim, pointest = NA, tstat = NA, cor12 = NA, cor23 = NA,
                       meantr = NA, meanctrl = NA,
                       ICC = NA) # container to hold the simulation runs

for (i in 1:nrow(runframe)) {
  # assign treated
  vil_frame_sim <- vil_frame # copy over because we grow the frame in every iteration
  treated <- sample(1:nV, nV/2)
  vil_frame_sim$tr <- ifelse(vil_frame_sim$vilid %in% treated, 1, 0)
  # Original binary vector, split for treated / untreated
  vil_frame_sim$round <- NA
  # replicate frame to match number of rounds
  vil_frame_sim <- bind_rows(replicate(nrounds, vil_frame_sim, simplify = FALSE))
  vil_frame_sim$round <- rep(1:nrounds, each = nV*nJ)
  # MDE reduction
  p_diartr <- p_diar * (1 - MDEdia)
  vil_frame_sim$diarrhea <- NA
  
  # ----------------------------------------------------------------------------
  # INDIVIDUAL LEVEL probabilities
  clust_e    <- rnorm(nV, 0, 0) # cluster level error
  clust_beta <- rnorm(nV, 0, .4) # random effect (.5 gave an ICC of .15-.02)
  b1 <- 1 # keep it 1 if you dont want to scale up
  # add a random effect / cluster component + an error term (can switch off by setting the rnorm 0,0)
  pr_ctr <- inv_logit(logit(p_diar)   + b1*clust_beta[vil_frame_sim$vilid[vil_frame_sim$tr == 0]] + clust_e[vil_frame_sim$vilid[vil_frame_sim$tr == 0]])
  pr_tr  <- inv_logit(logit(p_diartr) + b1*clust_beta[vil_frame_sim$vilid[vil_frame_sim$tr == 1]] + clust_e[vil_frame_sim$vilid[vil_frame_sim$tr == 1]])
  vil_frame_sim$diarrhea[vil_frame_sim$tr == 0 &
                           vil_frame_sim$round == 1] <- rbinom((nV*nJ)/2, 1, pr_ctr)
  vil_frame_sim$diarrhea[vil_frame_sim$tr == 1 &
                           vil_frame_sim$round == 1] <- rbinom((nV*nJ)/2, 1, pr_tr)
  
  # ----------------------------------------------------------------------------
  # POPULATION LEVEL with ICCbinary
  # vil_frame_sim$diarrhea[vil_frame_sim$tr == 0 & 
  #                          vil_frame_sim$round == 1] <- fabricatr::draw_binary_icc(p_diar, clusters = vil_frame_sim$vilid[vil_frame_sim$tr == 0], ICC = ICCval)
  # vil_frame_sim$diarrhea[vil_frame_sim$tr == 1 & 
  #                          vil_frame_sim$round == 1] <- fabricatr::draw_binary_icc(p_diartr, clusters = vil_frame_sim$vilid[vil_frame_sim$tr == 1], ICC = ICCval)
  
  # ICCBIN APPROACH:
  # vil_frame_sim$diarrhea[vil_frame_sim$tr == 0 &
  #                          vil_frame_sim$round == 1] <- ICCbin::rcbin(prop = p_diar, prvar = 0, noc = nV, csize = nJ, csvar = 0, rho = ICCval)$y
  # vil_frame_sim$diarrhea[vil_frame_sim$tr == 1 &
  #                          vil_frame_sim$round == 1] <- ICCbin::rcbin(prop = p_diartr, prvar = 0, noc = nV, csize = nJ, csvar = 0, rho = ICCval)$y
  
  # ----------------------------------------------------------------------------
  # assign diarrhea cases - "population level", i.e. just 0,1 draws according to the probabilities
  # vil_frame_sim$diarrhea[vil_frame_sim$tr == 0 & 
  #                          vil_frame_sim$round == 1] <- sample(c(0, 1), prob = c(1-p_diar, p_diar), (nV*nJ)/2, replace = TRUE)
  # vil_frame_sim$diarrhea[vil_frame_sim$tr == 1 & 
  #                          vil_frame_sim$round == 1] <- sample(c(0, 1), prob = c(1-p_diartr, p_diartr), (nV*nJ)/2, replace = TRUE)
  if(nrounds > 1) { # this allows me to build on top of the round with an AR process
    for (t in 2:nrounds) {
      # ----------------------------------------------------------------------------
      # POPULATION PLAIN VANILLA
      # vil_frame_sim$diarrhea[vil_frame_sim$tr == 0 &
      #                      vil_frame_sim$round == t] <- sample(c(0, 1), prob = c(1-p_diar, p_diar), (nV*nJ)/2, replace = TRUE)
      # vil_frame_sim$diarrhea[vil_frame_sim$tr == 1 &
      #                          vil_frame_sim$round == t] <- sample(c(0, 1), prob = c(1-p_diartr, p_diartr), (nV*nJ)/2, replace = TRUE)
      # ----------------------------------------------------------------------------
      # POPULATION WITH ICC
      # vil_frame_sim$diarrhea[vil_frame_sim$tr == 0 & 
      #                      vil_frame_sim$round == t] <- fabricatr::draw_binary_icc(p_diar, clusters = vil_frame_sim$vilid[vil_frame_sim$tr == 0], ICC = ICCval)
      # vil_frame_sim$diarrhea[vil_frame_sim$tr == 1 & 
      #                      vil_frame_sim$round == t] <- fabricatr::draw_binary_icc(p_diartr, clusters = vil_frame_sim$vilid[vil_frame_sim$tr == 1], ICC = ICCval)
      # ----------------------------------------------------------------------------
      # INDIVIDUAL ADDONS
      vil_frame_sim$diarrhea[vil_frame_sim$tr == 0 &
                           vil_frame_sim$round == t] <- rbinom((nV*nJ)/2, 1, pr_ctr)
      vil_frame_sim$diarrhea[vil_frame_sim$tr == 1 &
                           vil_frame_sim$round == t] <- rbinom((nV*nJ)/2, 1, pr_tr)
    }
  }
  
  # run the regression, cluster at treatment assignment level to get SEs right
  # ... no block randomization (don't know how much variation we would explain with a block FE as of now)
  regobj <- summary(fixest::feols(diarrhea ~ tr | round, data = vil_frame_sim), vcov = ~ vilid)
  runframe$pointest[i] <- regobj$coeftable[1,1] # point estimate
  runframe$tstat[i]    <- regobj$coeftable[1,3] # tstat
  #cat("done with run ", i)
  # some other info
  runframe$cor12[i] <- cor(vil_frame_sim$diarrhea[vil_frame_sim$round == 1], vil_frame_sim$diarrhea[vil_frame_sim$round == 2])
  runframe$cor23[i] <- cor(vil_frame_sim$diarrhea[vil_frame_sim$round == 2], vil_frame_sim$diarrhea[vil_frame_sim$round == 3])
  runframe$meantr[i]   <- vil_frame_sim$diarrhea[vil_frame_sim$tr == 1 & vil_frame_sim$round == 1] |> mean()
  runframe$meanctrl[i] <- vil_frame_sim$diarrhea[vil_frame_sim$tr == 0 & vil_frame_sim$round == 1] |> mean()
  
  runframe$ICC[i] <- ICC::ICCest(vilid, diarrhea, data = vil_frame_sim)$ICC
}

mean(abs(runframe$tstat) > 1.96)
mean(runframe$ICC)

ICC::ICCest(vilid, diarrhea, data = vil_frame_sim)$ICC
ICC::ICCest(vilid, diarrhea, data = vil_frame_sim[vil_frame_sim$tr == 0, ])$ICC

vil_frame_sim <- vil_frame_sim |> group_by(childid) |> mutate(diarrhea_count = sum(diarrhea))
table(vil_frame_sim$diarrhea_count)


# analysis / checking
vil_frame_sim <- vil_frame_sim %>%                           
  group_by(childid) %>%
  dplyr::mutate(laggedval = lag(diarrhea, n = 1, default = NA, order_by = round))
vil_frame_sim |> group_by(round, tr) |> summarise(diarrhea = mean(diarrhea)) 
cor(vil_frame_sim$diarrhea[vil_frame_sim$round == 1], vil_frame_sim$diarrhea[vil_frame_sim$round == 2])
vil_frame_sim |> filter(round > 1) |> group_by(round) |> summarise(corr = cor(diarrhea, laggedval, use = "complete.obs"))


# checking how the correlation compounds over time (if there is some snowballing going on)
round1 <- sample(c(0, 1), prob = c(1-p_diar, p_diar), (nV*nJ), replace = TRUE)
round1 <- c(round1, round1tr)
# Compute the correlation
round2 <- add_round(round1)
cor(round1, round2)
mean(round1)
mean(round2[1:2500])
mean(round2[2500:5000])
round3 <- add_round(round2)
cor(round3, round2)
mean(round3)
round4 <- add_round(round3)
cor(round3, round4)
mean(round4)
mean(round4[1:2500])
mean(round4[2500:5000])


```



# Next Round - Michael responds to e-mail

```{r}
# then on July12th there was a response by MK

# Hi, 
# 
# Thanks so much for your email. Sone quick reactions
# 
# I think we need to pick up smaller than 25% reductions in diarrhea. 
# 
# I don't think we can afford three rounds of data collection within our current budget. Can we get cost estimates? These calculations suggest the ratio of cost of mortality to diarrhea power is high for ILC India relative to individually randomizable treatments.
# 
# what ICC is being used?
# 
# I think it's critical to take into account intra-cluster correlation. 
# 
#  Can you share all the parameters that are assumed? 
# 
# Does this involve any baseline data collection? 
# 
# IIt would be great if you could share the code that you're using as well. 
# 
# I'm a little confused because I thought there was supposed to be 150 villages rather than 100. 
# 
# Best Wishes,
# Michael

# ------------------------
 # Akankhsa then said in Person on July 13th at Booth during DIL teamweek that they only put 150 to have buffer (befoer it was 80 and they put 100 to have buffer). She also said that new village numbers will be based on outcome of power calculations


# ------------------------
# later the same day, Elisa wrote on the pickering slack
# Hi 
# @Alex Lehner
#  can you calculate how many villages we need if we want to do 1 data collection for U2 mortality with ICC NOT zero (we considered 0.01 in the past right?). What MK wants to know is the trade-off to do 1 data collection with 3 times the sample or 3 rounds of data collection with less sample. We are going to ask for additional funds to GiveWell so we would like to budget for both scenarios after we know the required sample size for a MDE < 25% (maybe 20%? or maybe 15%, but with 95% power, NO less). Then we can put together the budget and think about the trade-offs 0 Thanks a lot!



# -----------
# Not included in response to Elisa: Just as a quick back of the envelope to anticipate: for just having one round, given 50 U5children per village, a 95% powered MDE of 20% would require 550 villages



```




