---
title: "India ILC -- WQ Data Checks"
author: "Jeremy Lowe"
date: "2023-10-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, warning = FALSE)

```

# Introduction

This report summarizes key water quality variables for the India ILc Pilot. It summarizes data collected during the baseline, follow-up, and monitoring data collection rounds. Key variables include free and total chlorine concentration and E. coli concentration.

```{r package loading, include=FALSE}

library(rsurveycto)
library(httr)
library(tidyverse)
library(lubridate)
library(quantitray)
library(sjmisc)
library(knitr)
library(kableExtra)
library(readxl)
library(experiment)
library(stargazer)
library(readxl)
library(haven)
library(googlesheets4)



```


```{r dataset loading}

#from Box

#Jeremy's file path
bl_raw <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/Baseline follow up survey_WIDE.csv")

bl <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/2_deidentified/1_2_Followup_cleaned.dta")

census <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/3_final/Final_HH_Odisha_consented_Full.dta")

r1 <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/2_deidentified/1_5_followup_R1_cleaned.dta")


mon <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/Daily Chlorine Monitoring Form_WIDE.csv")

mon_full <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/india_ilc_pilot_monitoring_WIDE.csv")

gv <- read_sheet(ss = "https://docs.google.com/spreadsheets/d/1OvZT-yk52h58-dpnSfBkXyEFR_Kb-p7O6PmQ8io4n-s/edit#gid=0", )

idx <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/_India ILC_IDEXX_data_MASTER.xlsx")

abr <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/_India ILC_ABR_data_MASTER.xlsx", skip = 1)

village_details <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/India_ILC_Pilot_Rayagada_Village_Tracking.xlsx")

```






\newpage
# Baseline Data Cleaning
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\


```{r baseline data cleaning, include=FALSE}

###GENERAL DATA CLEANING##################################################
#Filtering out test data from training, based on village IDs
unique(bl$R_FU_unique_id_1)
bl <- bl%>%
  filter(!(R_FU_unique_id_1 == 88888 |
           R_FU_unique_id_1 == 99999)) # Clean data doesn't require this step


#Selecting bl data key variables for WQ testing
bl <- bl%>%
  dplyr::select(R_FU_unique_id_1, R_FU_unique_id_2, R_FU_unique_id_3, unique_id_num, R_FU_r_cen_village_name_str, R_FU_consent, R_FU_water_source_prim, R_FU_primary_water_label, R_FU_water_qual_test, R_FU_wq_stored_bag, R_FU_stored_bag_source, R_FU_sample_ID_stored, R_FU_bag_ID_stored, R_FU_fc_stored, R_FU_wq_chlorine_storedfc_again, R_FU_tc_stored, R_FU_wq_chlorine_storedtc_again, R_FU_sample_ID_tap, R_FU_bag_ID_tap, R_FU_fc_tap, R_FU_wq_tap_fc_again, R_FU_tc_tap, R_FU_wq_tap_tc_again, R_FU_instancename)

#Assigning more meaningful variable names
bl <- bl%>%
  rename_all(~stringr::str_replace(.,"R_FU_",""))%>%
  rename(village = "r_cen_village_name_str")%>%
  rename(village_ID = "unique_id_1")%>%
  rename(unique_id = "unique_id_num")%>%
  rename(tc_stored_2 = "wq_chlorine_storedtc_again")%>%
  rename(fc_stored_2 = "wq_chlorine_storedfc_again")%>%
  rename(fc_tap_2 = "wq_tap_fc_again")%>%
  rename(tc_tap_2 = "wq_tap_tc_again")

#Pairing village information
bl$village_ID <- as.character(bl$village_ID)
bl <- left_join(bl, village_details, by = "village_ID")

xx <- bl%>%
  filter(is.na(block) == TRUE)

#Filtering out Bada Alubadi village since it has been replaced
bl <- bl%>%
  filter(!(village == "Badaalubadi"))

#Filtering out HHs that did not consent
bl <- bl%>%
  filter(is.na(consent) == FALSE)
  
#Other way:
  #rename(fc_stored = R_FU_fc_stored)%>%
  #rename(tc_stored = R_FU_tc_stored)%>%
  #rename(fc_tap = R_FU_fc_tap)%>%
  #rename(tc_tap = R_FU_tc_tap)%>%
  #rename(sample_ID_stored = R_FU_sample_ID_stored)

#Correcting one sample ID in BL dataset
for(i in (1:length(bl$unique_id))){
  if(bl$unique_id[i] == 50301106013){
    bl$sample_ID_stored[i] = 20290
  }
}


#Averaging chlorine data across two tests
bl <- bl%>%
  mutate(fc_stored_avg = rowMeans(dplyr::select(bl, starts_with("fc_stored")), na.rm = TRUE))%>%
  mutate(fc_tap_avg = rowMeans(dplyr::select(bl, starts_with("fc_tap")), na.rm = TRUE))%>%
  mutate(tc_stored_avg = rowMeans(dplyr::select(bl, starts_with("tc_stored")), na.rm = TRUE))%>%
  mutate(tc_tap_avg = rowMeans(dplyr::select(bl, starts_with("tc_tap")), na.rm = TRUE))
  
bl$fc_stored_avg <- round(bl$fc_stored_avg, digits = 3)
bl$fc_tap_avg <- round(bl$fc_tap_avg, digits = 3)
bl$tc_stored_avg <- round(bl$tc_stored_avg, digits = 3)
bl$tc_tap_avg <- round(bl$tc_tap_avg, digits = 3)

  

```


```{r baseline data cleaning - idexx, include = FALSE}

#Storing idx dataset to idexx -- just to have a dataset for BL data. Lazy coding.
idexx <- idx

#PREPARING IDEXX DATA##########################################################
#Pivoting dataset to be longer for pairing IDEXX data to sample IDs
bl_idexx <- bl%>%
  pivot_longer(cols = c(sample_ID_stored, sample_ID_tap), values_to = "sample_ID", names_to = "sample_type")

#Noting duplicate samples
idexx <- idexx%>%
  mutate(duplicate = ifelse(comments == "DUPLICATE", 1, 0))%>%
  replace_na(duplicate, value = 0)

#Dropping lab blanks, field blanks, and duplicates
idexx <- idexx%>%
  filter(sample_ID != "Lab Blank",
         sample_ID != "Field Blank")%>%
  filter(duplicate < 1)

#Checking IDs which do not match between survey data and lab data
idexx_ids <- idexx$sample_ID
bl_sample_ids <- bl_idexx$sample_ID
idexx_id_check <- idexx%>%
  filter(!(sample_ID %in% bl_sample_ids))

#combining idexx results to survey results
bl_idexx$sample_ID <- as.character(bl_idexx$sample_ID)
idexx <- inner_join(idexx, bl_idexx, by = "sample_ID")
abr$sample_ID <- as.character(abr$sample_ID)
abr <- inner_join(abr, bl_idexx, by = "sample_ID")


#creating new variable to tell the sample type
idexx$sample_type <- idexx$sample_type%>%
  factor()%>%
  fct_recode("Stored" = "sample_ID_stored",
             "Tap" = "sample_ID_tap")
abr$sample_type <- abr$sample_type%>%
  factor()%>%
  fct_recode("Stored" = "sample_ID_stored",
             "Tap" = "sample_ID_tap")

#Calculating MPN for each IDEXX test
idexx <- idexx%>%
  mutate(cf_95lo = quantify_95lo(y_large, y_small, "qt-2000"),
         cf_mpn  = quantify_mpn(y_large, y_small, "qt-2000"),
         cf_95hi = quantify_95hi(y_large, y_small, "qt-2000"))%>%
  mutate_at(vars(cf_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))
  

idexx <- idexx%>%
  mutate(ec_95lo = quantify_95lo(f_large, f_small, "qt-2000"),
         ec_mpn  = quantify_mpn(f_large, f_small, "qt-2000"),
         ec_95hi = quantify_95hi(f_large, f_small, "qt-2000"))%>%
  mutate_at(vars(ec_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))


abr <- abr%>%
  mutate(cf_95lo = quantify_95lo(y_large, y_small, "qt-2000"),
         cf_mpn  = quantify_mpn(y_large, y_small, "qt-2000"),
         cf_95hi = quantify_95hi(y_large, y_small, "qt-2000"))

abr <- abr%>%
  mutate(ec_95lo = quantify_95lo(f_large, f_small, "qt-2000"),
         ec_mpn  = quantify_mpn(f_large, f_small, "qt-2000"),
         ec_95hi = quantify_95hi(f_large, f_small, "qt-2000"))

#Checking cases of NA for total coliform and e coli
#xx <- idexx%>%
 # filter(is.na(cf_mpn) == TRUE)
#xxx <- idexx%>%
 # filter(y_large == 49 & y_small == 48)


#Adding presence/absence data
idexx <- idexx%>%
  mutate(cf_pa = case_when(
    is.na(cf_mpn) == TRUE ~ "Presence",
    cf_mpn > 0 ~ 'Presence',
    cf_mpn == 0 ~ 'Absence'))

idexx <- idexx%>%
  mutate(ec_pa = case_when(
    is.na(ec_mpn) == TRUE ~ "Presence",
    ec_mpn > 0 ~ 'Presence',
    ec_mpn == 0 ~ 'Absence'))

idexx <- idexx%>%
  mutate(cf_pa_binary = case_when(
    cf_mpn > 0 ~ 1,
    cf_mpn == 0 ~ 0))

idexx <- idexx%>%
  mutate(ec_pa_binary = case_when(
    ec_mpn > 0 ~ 1,
    ec_mpn == 0 ~ 0))


abr <- abr%>%
  mutate(cf_pa = case_when(
    cf_mpn > 0 ~ 'Presence',
    cf_mpn == 0 ~ 'Absence'))

abr <- abr%>%
  mutate(ec_pa = case_when(
    ec_mpn > 0 ~ 'Presence',
    ec_mpn == 0 ~ 'Absence'))

abr <- abr%>%
  mutate(cf_pa_binary = case_when(
    cf_mpn > 0 ~ 1,
    cf_mpn == 0 ~ 0))

abr <- abr%>%
  mutate(ec_pa_binary = case_when(
    ec_mpn > 0 ~ 1,
    ec_mpn == 0 ~ 0))

#log transforming data
idexx <- idexx%>%
  mutate(ec_log = log(ec_mpn, base = 10))%>%
  mutate(cf_log = log(cf_mpn, base = 10))

abr <- abr%>%
  mutate(ec_log = log(ec_mpn, base = 10))%>%
  mutate(cf_log = log(cf_mpn, base = 10))



```

\newpage
# Followup R1 Data Cleaning
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\




```{r followup r1 data cleaning, include=FALSE}

###GENERAL DATA CLEANING##################################################
#Filtering out test data from training, based on village IDs
unique(r1$R_FU1_unique_id_1)
r1 <- r1%>%
  filter(!(R_FU1_unique_id_1 == 88888 |
           R_FU1_unique_id_1 == 99999)) # Clean data doesn't require this step


#Selecting r1 data key variables for WQ testing
r1 <- r1%>%
  dplyr::select(R_FU1_unique_id_1, R_FU1_unique_id_2, R_FU1_unique_id_3, unique_id_num, R_FU1_r_cen_village_name_str, R_FU1_consent, R_FU1_water_source_prim, R_FU1_primary_water_label, R_FU1_water_qual_test, R_FU1_wq_stored_bag, R_FU1_stored_bag_source, R_FU1_sample_ID_stored, R_FU1_bag_ID_stored, R_FU1_fc_stored, R_FU1_wq_chlorine_storedfc_again, R_FU1_tc_stored, R_FU1_wq_chlorine_storedtc_again, R_FU1_sample_ID_tap, R_FU1_bag_ID_tap, R_FU1_fc_tap, R_FU1_wq_tap_fc_again, R_FU1_tc_tap, R_FU1_wq_tap_tc_again, R_FU1_instancename)

#Assigning more meaningful variable names
r1 <- r1%>%
  rename_all(~stringr::str_replace(.,"R_FU1_",""))%>%
  rename(village = "r_cen_village_name_str")%>%
  rename(village_ID = "unique_id_1")%>%
  rename(unique_id = "unique_id_num")%>%
  rename(tc_stored_2 = "wq_chlorine_storedtc_again")%>%
  rename(fc_stored_2 = "wq_chlorine_storedfc_again")%>%
  rename(fc_tap_2 = "wq_tap_fc_again")%>%
  rename(tc_tap_2 = "wq_tap_tc_again")

#Pairing village information
r1$village_ID <- as.character(r1$village_ID)
r1 <- left_join(r1, village_details, by = "village_ID")


#Filtering out HHs that did not consent
r1 <- r1%>%
  filter(is.na(consent) == FALSE)
  
#Other way:
  #rename(fc_stored = R_FU_fc_stored)%>%
  #rename(tc_stored = R_FU_tc_stored)%>%
  #rename(fc_tap = R_FU_fc_tap)%>%
  #rename(tc_tap = R_FU_tc_tap)%>%
  #rename(sample_ID_stored = R_FU_sample_ID_stored)

#Correcting sample IDs in R1 dataset? Need to check
#for(i in (1:length(r1$unique_id))){
 # if(r1$unique_id[i] == 50301106013){
  #  r1$sample_ID_stored[i] = 20290
#  }
#}

#Renamed control vs treatment assignment
r1$assignment <- factor(r1$assignment)%>%
  fct_recode("Control" = "C",
             "Treatment" = "T")

#Removing cases of "999" being reported in a measurement. Replacing with NA values for now.
xx <- r1%>%
  filter(fc_stored > 2.0 |
           fc_stored_2 > 2.0 |
           fc_tap > 2.0 |
           fc_tap_2 > 2.0 |
           tc_stored > 2.0 |
           tc_stored_2 > 2.0 |
           tc_tap > 2.0 |
           tc_tap_2 > 2.0)

#write_csv(xx, "C:/Users/jerem/Box/India Water project/2_Pilot/Data/0-data cleaning/chlorine_data_review_20240229.csv")

r1 <- r1 %>%
  mutate_at(vars(fc_stored_2, tc_stored, fc_tap, tc_tap, tc_tap_2), ~ifelse(. > 100, 0, .))

#Averaging chlorine data across two tests
r1 <- r1%>%
  mutate(fc_stored_avg = rowMeans(dplyr::select(r1, starts_with("fc_stored")), na.rm = TRUE))%>%
  mutate(fc_tap_avg = rowMeans(dplyr::select(r1, starts_with("fc_tap")), na.rm = TRUE))%>%
  mutate(tc_stored_avg = rowMeans(dplyr::select(r1, starts_with("tc_stored")), na.rm = TRUE))%>%
  mutate(tc_tap_avg = rowMeans(dplyr::select(r1, starts_with("tc_tap")), na.rm = TRUE))
  
r1$fc_stored_avg <- round(r1$fc_stored_avg, digits = 3)
r1$fc_tap_avg <- round(r1$fc_tap_avg, digits = 3)
r1$tc_stored_avg <- round(r1$tc_stored_avg, digits = 3)
r1$tc_tap_avg <- round(r1$tc_tap_avg, digits = 3)






```


```{r r1 data cleaning - idexx, include = FALSE}

#Storing raw idx data to idexx_r1. Lazy coding. Much of this should be processed once.
#Will update more later
idexx_r1 <- idx

#PREPARING IDEXX DATA##########################################################
#Pivoting dataset to be longer for pairing IDEXX data to sample IDs
r1_for_idexx <- r1%>%
  pivot_longer(cols = c(sample_ID_stored, sample_ID_tap), values_to = "sample_ID", names_to = "sample_type")

#Noting duplicate samples
idexx_r1 <- idexx_r1%>%
  mutate(duplicate = ifelse(comments == "DUPLICATE", 1, 0))%>%
  replace_na(duplicate, value = 0)

#Dropping lab blanks, field blanks, and duplicates
idexx_r1 <- idexx_r1%>%
  filter(sample_ID != "Lab Blank",
         sample_ID != "Field Blank")%>%
  filter(duplicate < 1)

#Checking IDs which do not match between survey data and lab data
idexx_ids <- idexx_r1$sample_ID
r1_sample_ids <- r1_for_idexx$sample_ID
idexx_id_check <- idexx_r1%>%
  filter(!(sample_ID %in% r1_sample_ids))

#combining idexx results to survey results
r1_for_idexx$sample_ID <- as.character(r1_for_idexx$sample_ID)
idexx_r1 <- inner_join(idexx_r1, r1_for_idexx, by = "sample_ID")
#abr$sample_ID <- as.character(abr$sample_ID)
#abr <- inner_join(abr, bl_idexx, by = "sample_ID")


#creating new variable to tell the sample type
idexx_r1$sample_type <- idexx_r1$sample_type%>%
  factor()%>%
  fct_recode("Stored" = "sample_ID_stored",
             "Tap" = "sample_ID_tap")
#abr$sample_type <- abr$sample_type%>%
 # factor()%>%
  #fct_recode("Stored" = "sample_ID_stored",
   #          "Tap" = "sample_ID_tap")

#Calculating MPN for each IDEXX test
idexx_r1 <- idexx_r1%>%
  mutate(cf_95lo = quantify_95lo(y_large, y_small, "qt-2000"),
         cf_mpn  = quantify_mpn(y_large, y_small, "qt-2000"),
         cf_95hi = quantify_95hi(y_large, y_small, "qt-2000"))%>%
  mutate_at(vars(cf_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))

idexx_r1 <- idexx_r1%>%
  mutate(ec_95lo = quantify_95lo(f_large, f_small, "qt-2000"),
         ec_mpn  = quantify_mpn(f_large, f_small, "qt-2000"),
         ec_95hi = quantify_95hi(f_large, f_small, "qt-2000"))%>%
  mutate_at(vars(ec_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))



#Adding presence/absence data
idexx_r1 <- idexx_r1%>%
  mutate(cf_pa = case_when(
    is.na(cf_mpn) == TRUE ~ "Presence",
    cf_mpn > 0 ~ 'Presence',
    cf_mpn == 0 ~ 'Absence'))

idexx_r1 <- idexx_r1%>%
  mutate(ec_pa = case_when(
    is.na(ec_mpn) == TRUE ~ "Presence",
    ec_mpn > 0 ~ 'Presence',
    ec_mpn == 0 ~ 'Absence'))

idexx_r1 <- idexx_r1%>%
  mutate(cf_pa_binary = case_when(
    cf_mpn > 0 ~ 1,
    cf_mpn == 0 ~ 0))

idexx_r1 <- idexx_r1%>%
  mutate(ec_pa_binary = case_when(
    ec_mpn > 0 ~ 1,
    ec_mpn == 0 ~ 0))


#log transforming data
idexx_r1 <- idexx_r1%>%
  mutate(ec_log = log(ec_mpn, base = 10))%>%
  mutate(cf_log = log(cf_mpn, base = 10))



```




\newpage
# Analysis
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\



```{r baseline chlorine data desc stats}

###Displaying chlorine test data for each village
#Arranging data so chlorine test data is in one column
chlorine <- bl%>%
  pivot_longer(cols = c(fc_tap_avg, fc_stored_avg, tc_tap_avg, tc_stored_avg), values_to = "chlorine_concentration", names_to = "chlorine_test_type")

#Removing NAs from no respondent being available
chlorine <- chlorine%>%
  filter(is.na(chlorine_concentration) == FALSE)

p1 <- chlorine%>%
  ggplot() +
  geom_point(aes(x = chlorine_test_type, y = chlorine_concentration)) +
    geom_hline(yintercept=0.14, linetype="dashed", color = "red") + 
  annotate("text", x = 1.5, y = .25, size = 2, color = "red",
           label = "Detection Limit = 0.14 mg/L") +
  facet_wrap(~ block) + 
  scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0),
                     limits = c(0, 2.0),
                     expand = c(0,0)) +
  labs(x = "Chlorine Test", y = "Chlorine Concentration (mg/L)") +
  theme_bw()

p1


#Selecting for data that are > 0.10 mg/L
chlorine_check <- chlorine%>%
  filter(chlorine_concentration > 0.14)%>%
  dplyr::select(unique_id, unique_id_2, village, chlorine_test_type, chlorine_concentration)

#Writing csv
#write_csv(chlorine_check, "C:/Users/jerem/Box/India Water project/2_Pilot/Data Checks/baseline_survey/20231108_chlorine_data_check.csv")

#Creating table
chlorine_check%>%
  kbl(
    #col.names = linebreak(column_names, align = "l"),
    #escape = FALSE
    )%>%
  kable_styling(position = "center",
                bootstrap_options = "striped",
                latex_options = c("scale_down"))%>%
  add_header_above(c("Free and Total Chlorine Concentrations - Positive Samples (mg/L) " =5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE)%>%
  column_spec(2, width = "75px")

#Creating table
#stargazer(chlorine_check)
  
```



```{r Baseline IDEXX Data Desc Stats}

#Removing NA result
idexx <- idexx%>%
  filter(is.na(ec_mpn) == FALSE)

# Calculate descriptive statistics by village
village_stats <- idexx%>%
  group_by(village, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

tc_stats <- idexx%>%
  group_by(assignment, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )


all_stats <- idexx%>%
  group_by(sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )


# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(all_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


#Plotting chlorine concentrations against e. coli presence/absence
# p1 <- ggplot(data = idexx) + 
#   geom_boxplot(aes(x = ec_pa, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Presence/Absence of E. coli", 
#        y = "Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps and Detection of E. coli")+
#   theme_bw()
# 
# p1


#need to correct
# #p2 <- ggplot(data = idexx) + 
#   geom_col(aes(x = village, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Sample ID", 
#        y = "Average Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps in each village in Odisha")+
#   theme_bw()
# 
# p2


#Plotting IDEXX E. coli data per village
p3 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p3



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = sample_type, y = ec_log)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p4


#Plotting IDEXX E. coli data per village
p5 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = block, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Block", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Sample Type",
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p5



```



```{r Baseline ABR IDEXX Desc Stats}

# Calculate descriptive statistics by village
village_stats <- abr%>%
  group_by(village, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

abr_stats <- abr%>%
  group_by(sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )





# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(abr_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Water Quality Test Results " = 5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")



# p4 <- ggplot(data = abr) + 
#   geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
#   scale_y_continuous(
#                      limits = c(0, 4),
#                      expand = c(0,0))+
#   labs(x = "Village", 
#        y = "log(MPN E. coli/100 mL)",
#        title = "E. coli Presence in Tap and Stored Drinking Water in Odisha (N = 56)")+
#   theme_bw()
# 
# p4


# p5 <- ggplot(data = abr) + 
#   geom_bar(aes(y = ec_pa, fill = village))+
#   labs(x = "Village", 
#        y = "log(MPN E. coli/100 mL)",
#        title = "E. coli Presence in Tap and Stored Drinking Water in Odisha (N = 56)")+
#   theme_bw()
# p5


```


```{r R1 IDEXX Data Desc Stats}

#Removing NA result
idexx_r1 <- idexx_r1%>%
  filter(is.na(ec_mpn) == FALSE)

# Calculate descriptive statistics by village
village_stats <- idexx_r1%>%
  group_by(village, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

tc_stats <- idexx_r1%>%
  group_by(assignment, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

all_stats <- idexx_r1%>%
  group_by(sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )


# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


kbl(all_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


#Plotting chlorine concentrations against e. coli presence/absence
# p1 <- ggplot(data = idexx_r1) + 
#   geom_boxplot(aes(x = ec_pa, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Presence/Absence of E. coli", 
#        y = "Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps and Detection of E. coli")+
#   theme_bw()
# 
# p1


#need to correct
# #p2 <- ggplot(data = idexx_r1) + 
#   geom_col(aes(x = village, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Sample ID", 
#        y = "Average Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps in each village in Odisha")+
#   theme_bw()
# 
# p2


#Plotting IDEXX E. coli data per village
p3 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p3



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = sample_type, y = ec_log)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " R1 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p4


#Plotting IDEXX E. coli data per village
p5 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = block, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Block", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Sample Type",
       title = expression(paste(italic("E. coli"), " R1 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p5



```




\newpage

# Longitudinal Chlorine Monitoring
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

```{r JPAL Chlorine monitoring data cleaning}

#Assigning more meaningful variable names
mon <- mon%>%
  rename(village_ID = "village_name")

mon_full <- mon_full%>%
  rename(village_ID = "village_name")

#Pairing village information
mon$village_ID <- as.character(mon$village_ID)
mon <- left_join(mon, village_details, by = "village_ID")

mon_full$village_ID <- as.character(mon_full$village_ID)
mon_full <- left_join(mon_full, village_details, by = "village_ID")

#Averaging chlorine data
mon <- mon%>%
  mutate(nearest_tap_fc = (first_nearest_tap_fc + second_nearest_tap_fc)/2)%>%
  mutate(nearest_tap_tc = (first_nearest_tap_tc + second_nearest_tap_tc)/2)%>%
  mutate(farthest_tap_fc = (first_farthest_tap_fc + second_farthest_tap_fc)/2)%>%
  mutate(farthest_tap_tc = (first_farthest_tap_tc + second_farthest_tap_tc)/2)%>%
  mutate(nearest_stored_fc = (first_stored_water_fc + second_stored_water_fc)/2)%>%
  mutate(nearest_stored_tc = (first_stored_water_tc + second_stored_water_tc)/2)%>%
  mutate(farthest_stored_fc = (far_first_stored_water_fc + far_second_stored_water_fc)/2)%>%
  mutate(farthest_stored_tc = (far_first_stored_water_tc + far_second_stored_water_tc)/2)

mon_full <- mon_full%>%
  mutate(nearest_tap_fc = (first_nearest_tap_fc + second_nearest_tap_fc)/2)%>%
  mutate(nearest_tap_tc = (first_nearest_tap_tc + second_nearest_tap_tc)/2)%>%
  mutate(farthest_tap_fc = (first_farthest_tap_fc + second_farthest_tap_fc)/2)%>%
  mutate(farthest_tap_tc = (first_farthest_tap_tc + second_farthest_tap_tc)/2)%>%
  mutate(nearest_stored_fc = (first_stored_water_fc + second_stored_water_fc)/2)%>%
  mutate(nearest_stored_tc = (first_stored_water_tc + second_stored_water_tc)/2)%>%
  mutate(farthest_stored_fc = (far_first_stored_water_fc + far_second_stored_water_fc)/2)%>%
  mutate(farthest_stored_tc = (far_first_stored_water_tc + far_second_stored_water_tc)/2)


#Getting date of test
mon$valve_open_time <- mdy_hms(mon$valve_open_time)
mon <- mon%>%
  mutate(test_date = date(valve_open_time))

mon_full$valve_open_time <- mdy_hms(mon_full$valve_open_time)
mon_full <- mon_full%>%
  mutate(test_date = date(valve_open_time))

#Selecting for variables only in the shorter daily monitoring form
mon <- bind_rows(mon, mon_full)


### Cleaning and formatting datasets ### 
mon_villages <- unique(mon$village_name)


#Pivoting to make datasets only have a single column for chlorine concentration measurement
mon <- mon%>%
  pivot_longer(cols = c(nearest_tap_fc, nearest_tap_tc, farthest_tap_fc, farthest_tap_tc, nearest_stored_fc, nearest_stored_tc, farthest_stored_fc, farthest_stored_tc), names_to = "chlorine_test", values_to = "chlorine_concentration")
mon

#Subsetting for nearest and farthest tap connections
mon_near <- mon%>%
  filter(chlorine_test %in% c("nearest_tap_fc", "nearest_stored_fc", "nearest_tap_tc", "nearest_stored_tc"))

mon_far <- mon%>%
  filter(chlorine_test %in% c("farthest_tap_fc", "farthest_stored_fc", "farthest_tap_tc", "farthest_stored_tc"))






```


```{r Gram Vikas chlorine monitoring data cleaning}

#Assigning more meaningful variable names
gv <- gv%>%
  rename_all(~stringr::str_replace(.,"Sample ","sample_"))%>%
  rename_all(~stringr::str_replace(.," - Free Chlorine (mg/L)","_fc"))%>%
  rename_all(~stringr::str_replace(.," - Total Chlorine (mg/L)","_tc"))%>%
  rename_all(~stringr::str_replace(.," - Location","_location"))
  

  #rename(village = "r_cen_village_name_str")%>%
  


```


## JPAL Chlorine Monitoring Results



```{r JPAL Chlorine Monitoring Data Analysis}


#Creating time series plot of the data for each village

for (i in mon_villages){
  x_near <- mon_near%>%
    filter(village_name == i)
  x_far <- mon_far%>%
    filter(village_name == i)
  
  p1 <- ggplot(data = x_near) + 
    geom_jitter(aes(x = test_date, y = chlorine_concentration, color = chlorine_test), width = 0.05, height = 0.001) +
    scale_y_continuous(
                     limits = c(0, 1),
                     expand = c(0,0))+
    labs(x = "Date", 
       y = "Chlorine Concentration (mg/L)",
       fill = "Sample Type",
       title = (paste("Chlorine Concentration for", i,"for 2023-2024")))+
    theme_bw() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))
  
  print(p1)
  
  p2 <- ggplot(data = x_far) + 
    geom_jitter(aes(x = test_date, y = chlorine_concentration, color = chlorine_test), width = 0.05, height = 0.001) +
    scale_y_continuous(
                     limits = c(0, 1),
                     expand = c(0,0))+
    labs(x = "Date", 
       y = "Chlorine Concentration (mg/L)",
       fill = "Sample Type",
       title = (paste("Chlorine Concentration for", i,"for 2023-2024")))+
    theme_bw() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))
  
  print(p2)

  
}

```




## Gram Vikas Chlorine Monitoring Results

```{r Gram Vikas Chlorine Monitoring Results}

#Selecting for Karnapadu results

karn <- gv%>%
  filter(Village == "Karnapadu")%>%
  pivot_longer(cols = c("sample_1 - Free Chlorine (mg/L)",
                        "sample_2 - Free Chlorine (mg/L)",
                        "sample_3 - Free Chlorine (mg/L)",
                        "sample_4 - Free Chlorine (mg/L)",
                        "sample_5 - Free Chlorine (mg/L)",
                        "sample_6 - Free Chlorine (mg/L)",
                        "sample_7 - Free Chlorine (mg/L)",
                        "sample_8 - Free Chlorine (mg/L)",
                        "sample_9 - Free Chlorine (mg/L)",
                        "sample_10 - Free Chlorine (mg/L)",
                        "sample_11 - Free Chlorine (mg/L)",
                        "sample_12 - Free Chlorine (mg/L)"), names_to = "sample_fc", values_to = "free_chlorine")
#pivot_longer(cols = c("sample_1_location", "sample_2_location", "sample_3_location",
 #                       "sample_4_location", "sample_5_location", "sample_6_location",
  #                      "sample_7_location", "sample_8_location", "sample_9_location", 
   #                     "sample_10_location", "sample_11_location", "sample_12_location"),
    #         names_to = "sample_location_number",
     #          values_to = "sample_location")


# karn_results <- karn%>%
#   group_by(sample_location) %>%
#   summarize(
#     "Number of Samples" = n(),
#     "Average Free Chlorine Concentration" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
#     "Median MPN E. coli/100 mL" = median(ec_mpn),
#     "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
#   )



```

