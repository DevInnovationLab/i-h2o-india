---
title: "India ILC -- WQ Data Checks"
author: "Jeremy Lowe"
date: "2023-10-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, warning = FALSE)

```

# Introduction

This report summarizes key water quality variables for the India ILc Pilot. It summarizes data collected during the baseline, follow-up, and monitoring data collection rounds. Key variables include free and total chlorine concentration and E. coli concentration.

```{r package loading, include=FALSE}

library(rsurveycto)
library(expss)
library(labelled)
library(httr)
library(tidyverse)
library(lubridate)
library(quantitray)
library(sjmisc)
library(knitr)
library(kableExtra)
library(readxl)
library(experiment)
library(stargazer)
library(readxl)
library(haven)
library(googlesheets4)
library(ggsignif)
library(patchwork)
library(table1)
library(gtsummary)
library(gt)
library(clubSandwich)




```


```{r dataset loading}

#from Box

#Jeremy's file path
bl_raw <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/Baseline follow up survey_WIDE.csv")

bl <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/2_deidentified/1_2_Followup_cleaned.dta")

#el <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/1_8_Endline_Census.dta")



cen <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/3_final/Final_HH_Odisha_consented_Full.dta")

r1 <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/2_deidentified/1_5_followup_R1_cleaned.dta")

r2 <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/2_deidentified/1_6_followup_R2_cleaned.dta")

r3 <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/2_deidentified/1_7_followup_R3_cleaned.dta")

mon <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/Daily Chlorine Monitoring Form_WIDE.csv")

mon_full <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/india_ilc_pilot_monitoring_WIDE.csv")

#gv <- read_sheet(ss = "https://docs.google.com/spreadsheets/d/1OvZT-yk52h58-dpnSfBkXyEFR_Kb-p7O6PmQ8io4n-s/edit#gid=0", )

gv <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/6_Gram Vikas/India ILC - Gram Vikas Chlorine Monitoring_current.csv")

idx <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/raw/_India ILC_IDEXX_data_MASTER.xlsx")

abr <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/raw/_India ILC_ABR_data_MASTER.xlsx", skip = 1)

idexx_r2 <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/raw/_India ILC_IDEXX_data_R2.csv")

idexx_r3 <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/raw/_India ILC_IDEXX_data_R3.csv")

village_details <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/India_ILC_Pilot_Rayagada_Village_Tracking.xlsx")

```



```{r profile}
#------------------------ setting user path ----------------------------------------#


user_path <- function() {
  # Return a hardcoded path that depends on the current user, or the current 
  # working directory for an unrecognized user. If the path isn't readable,
  # stop.
  #
  
  user <- Sys.info()["user"]
  
  if (user == "asthavohra") { 
    path = "/Users/asthavohra/Library/CloudStorage/Box-Box/India Water project/2_Pilot/Data/"
  } 
  else if (user=="akitokamei"){
    path = "/Users/akitokamei/Box Sync/India Water project/2_Pilot/Data/"
  } 
  else if (user == "jerem"){
    path = "C:/Users/jerem/Box/India Water project/2_Pilot/Data/"
  } 
  else {
    warning("No path found for current user (", user, ")")
    path = getwd()
  }
  
  stopifnot(file.exists(path))
  return(path)
}

# set working directory
knitr::opts_knit$set(root.dir = user_path())

# setting github directory
github_path <- function() {
  user <- Sys.info()["user"]
  if (user == "asthavohra") {
    github = "/Users/asthavohra/Documents/GitHub/i-h2o-india/Code/2_Pilot/0_pilot logistics/"
  } 
  else if (user=="akitokamei"){
    github = "/Users/akitokamei/Library/CloudStorage/Dropbox/Mac/Documents/GitHub/i-h2o-india/Code/2_Pilot/0_pilot logistics/"
  } 
  else if (user == "jerem") {
    github = "C:/Users/jerem/Documents/i-h2o-india/Code/1_profile_ILC"
  } 
  else {
    warning("No path found for current user (", user, ")")
    github = getwd()
  }
  
  stopifnot(file.exists(github))
  return(github)
}



```



```{r loading endline data}
#------------------------ Load the data ----------------------------------------#

#el <- read_stata(paste0(user_path(),"1_raw/1_8_Endline/1_8_Endline_Census.dta" ))

df.preload <- read_stata(paste0(user_path(),"99_Preload/1_8_Endline_XXX.dta"))


#Loading/saving most recent cleaned data
#Lazy coding, didn't want to change Astha's Stata code and break it yet

el <- read_stata(paste0(user_path(),"1_raw/1_8_Endline/1_8_Endline_Census_cleaned.dta" ))



```



```{r defining functions}

labelmaker <- function(x){
  z <- colnames(x)
  for(i in z){
    labels <-  val_labels(x[i])
    if(is.na(labels) == FALSE){
      x[i] <- to_label(x[i])
      
    }
  }
  return(x)
}

```



\newpage
# Baseline Census Data Cleaning


```{r baseline data cleaning - changing variable names}

#------------------------ Apply the labels for variables---------------------#

temp.labels <- lapply(cen, var_lab)

#create a data with labels
#Code from Astha
df.label <- as.data.frame(t(as.data.frame(do.call(cbind, temp.labels)))) 
df.label<- tibble::rownames_to_column(df.label) 
df.label <- df.label %>% rename(variable = rowname, label = V1)  
auto_generated_labels <- c(df.label$variable)

#include labels given manually 
df.label.manual <- read_xlsx(paste0(user_path(),"4_other/R_code_HH_Survey_labels.xlsx"))

df.var <- as.data.frame(names(cen)) #List of variables in the data

# assign labels to variable that were generated
#df.label.manual <- df.label.manual %>% 
 # mutate(new_var = ifelse(Variable %in% auto_generated_labels, 0,1)) %>% 
  #filter(new_var == 1) %>% 
  #select(-new_var) %>% 
  #rename(variable = Variable, label = Label)

#df.label <- rbind(df.label, df.label.manual)
# create a function that assigns the label to appropriate variable

#Changing variable names
cen <- cen%>%
  rename_all(~stringr::str_replace(.,"R_Cen_",""))%>%
  rename_all(~stringr::str_replace(.,"a1_",""))%>%
  rename_all(~stringr::str_replace(.,"a2_",""))%>%
  rename_all(~stringr::str_replace(.,"a3_",""))%>%
  rename_all(~stringr::str_replace(.,"a4_",""))%>%
  rename_all(~stringr::str_replace(.,"a5_",""))%>%
  rename_all(~stringr::str_replace(.,"a6_",""))%>%
  rename_all(~stringr::str_replace(.,"a7_",""))%>%
  rename_all(~stringr::str_replace(.,"a8_",""))%>%
  rename_all(~stringr::str_replace(.,"a9_",""))%>%
  rename_all(~stringr::str_replace(.,"a10_",""))%>%
  rename_all(~stringr::str_replace(.,"a11_",""))%>%
   rename_all(~stringr::str_replace(.,"a12_",""))%>%
   rename_all(~stringr::str_replace(.,"a13_",""))%>%
  rename_all(~stringr::str_replace(.,"a14_",""))%>%
  rename_all(~stringr::str_replace(.,"a15_",""))%>%
  rename_all(~stringr::str_replace(.,"a16_",""))%>%
  rename_all(~stringr::str_replace(.,"a17_",""))%>%
  #rename_all(~stringr::str_replace(.,"a18_",""))%>%
  rename_all(~stringr::str_replace(.,"a19_",""))%>%
  rename_all(~stringr::str_replace(.,"a20_",""))%>%
  rename_all(~stringr::str_replace(.,"a21_",""))%>%
  rename_all(~stringr::str_replace(.,"a22_",""))%>%
  rename_all(~stringr::str_replace(.,"a23_",""))%>%
  rename_all(~stringr::str_replace(.,"a24_",""))
  #rename_all(~stringr::str_replace(.,"a25_",""))


#create a date variable
cen$datetime <- strptime(cen$starttime, format = "%Y-%m-%d %H:%M:%S")

cen$date <- as_date(cen$datetime) 




```


```{r baseline census data cleaning - cleaning data}


#------------------------ Keep consented cases ----------------------------------------#

#cen.consent <- cen[which(cen$consent==1) ,]

cen <- cen%>%
  filter(consent == 1)


#------------ Assign the correct treatment to villages---------------------------#

cen <- cen %>% mutate(assignment = ifelse(village_str %in%
                                                                   c("Birnarayanpur","Nathma", "Badabangi","Naira", "Bichikote", "Karnapadu","Mukundpur", "Tandipur", "Gopi Kankubadi", "Asada"), "Treatment", "Control"))

#Changing village variable name
cen <- cen%>%
  mutate(village_name = village_str)


#Using labelmaker to make transfer labels for the whole dataset
cen <- labelmaker(cen)



#Recoding factor levels for ws_prim
cen <- cen%>%
  mutate(prim_source = NA)
cen$prim_source <- cen$ws_prim%>%
  fct_recode(
    "Government-provided Tap" = "PWS: JJM Taps",
  "Community Tap" = "PWS: Govt. community standpipe",
  "Community Tap" = "PWS: GP/Other community standpipe",
  "Surface Water"  = "PWS: Surface water",
  "Surface Water" = "PWS: Private surface well",
  "Covered Dug Well" = "PWS: Covered dug well",
  "Borehole" = "PWS: Manual handpump",
  "Other" = "PWS: Other"
)

#recoding secondary source
cen$water_sec_yn <- cen$water_sec_yn%>%
  fct_recode(
    "No" = "SWS: No secondary water source",
  "Yes" = "SWS: Yes"
)



```



\newpage
# Baseline Survey Data Cleaning
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\


```{r baseline data cleaning, include=FALSE}

###GENERAL DATA CLEANING##################################################
#Filtering out test data from training, based on village IDs
unique(bl$R_FU_unique_id_1)
bl <- bl%>%
  filter(!(R_FU_unique_id_1 == 88888 |
           R_FU_unique_id_1 == 99999)) # Clean data doesn't require this step


#Selecting bl data key variables for WQ testing
bl <- bl%>%
  dplyr::select(R_FU_unique_id_1, R_FU_unique_id_2, R_FU_unique_id_3, unique_id_num, R_FU_r_cen_village_name_str, R_FU_consent, R_FU_water_source_prim, R_FU_primary_water_label, R_FU_water_qual_test, R_FU_wq_stored_bag, R_FU_stored_bag_source, R_FU_sample_ID_stored, R_FU_bag_ID_stored, R_FU_fc_stored, R_FU_wq_chlorine_storedfc_again, R_FU_tc_stored, R_FU_wq_chlorine_storedtc_again, R_FU_sample_ID_tap, R_FU_bag_ID_tap, R_FU_fc_tap, R_FU_wq_tap_fc_again, R_FU_tc_tap, R_FU_wq_tap_tc_again, R_FU_instancename)

#Assigning more meaningful variable names
bl <- bl%>%
  rename_all(~stringr::str_replace(.,"R_FU_",""))%>%
  rename(village = "r_cen_village_name_str")%>%
  rename(village_ID = "unique_id_1")%>%
  rename(unique_id = "unique_id_num")%>%
  rename(tc_stored_2 = "wq_chlorine_storedtc_again")%>%
  rename(fc_stored_2 = "wq_chlorine_storedfc_again")%>%
  rename(fc_tap_2 = "wq_tap_fc_again")%>%
  rename(tc_tap_2 = "wq_tap_tc_again")

#Pairing village information
bl$village_ID <- as.character(bl$village_ID)
bl <- left_join(bl, village_details, by = "village_ID")

xx <- bl%>%
  filter(is.na(block) == TRUE)

#Filtering out Bada Alubadi village since it has been replaced
bl <- bl%>%
  filter(!(village == "Badaalubadi"))

#Filtering out HHs that did not consent
bl <- bl%>%
  filter(is.na(consent) == FALSE)
  
#Other way:
  #rename(fc_stored = R_FU_fc_stored)%>%
  #rename(tc_stored = R_FU_tc_stored)%>%
  #rename(fc_tap = R_FU_fc_tap)%>%
  #rename(tc_tap = R_FU_tc_tap)%>%
  #rename(sample_ID_stored = R_FU_sample_ID_stored)

#Correcting one sample ID in BL dataset
for(i in (1:length(bl$unique_id))){
  if(bl$unique_id[i] == 50301106013){
    bl$sample_ID_stored[i] = 20290
  }
}


#Averaging chlorine data across two tests
bl <- bl%>%
  mutate(fc_stored_avg = rowMeans(dplyr::select(bl, starts_with("fc_stored")), na.rm = TRUE))%>%
  mutate(fc_tap_avg = rowMeans(dplyr::select(bl, starts_with("fc_tap")), na.rm = TRUE))%>%
  mutate(tc_stored_avg = rowMeans(dplyr::select(bl, starts_with("tc_stored")), na.rm = TRUE))%>%
  mutate(tc_tap_avg = rowMeans(dplyr::select(bl, starts_with("tc_tap")), na.rm = TRUE))
  
bl$fc_stored_avg <- round(bl$fc_stored_avg, digits = 3)
bl$fc_tap_avg <- round(bl$fc_tap_avg, digits = 3)
bl$tc_stored_avg <- round(bl$tc_stored_avg, digits = 3)
bl$tc_tap_avg <- round(bl$tc_tap_avg, digits = 3)


#Renaming assignment names
bl$assignment <- factor(bl$assignment)
bl$assignment <- fct_recode(bl$assignment,
                                  "Control" = "C", 
                                  "Treatment" = "T")

#Using labelmaker function to change variable answer labels
bl <- labelmaker(bl)


#Changing primary source labels
bl <- bl%>%
  mutate(prim_source = NA)
bl$prim_source <- bl$water_source_prim%>%
  fct_recode(
    "Government-provided Tap" = "Government provided household Taps (supply paani)",
  "Community Tap" = "Household tap connections not connected to RWSS/Basudha/JJM tank",
  "Community Tap" = "Government provided community standpipe (connected to piped system, through Vasu",
  "Community Tap" = "Gram Panchayat/Other Community Standpipe (e.g. solar pump, PVC tank)",
  "Surface Water"  = "Directly fetched by surface water (river/dam/lake/pond/stream/canal/irrigation c",
  "Surface Water" = "Private Surface well",
  "Surface Water" = "Uncovered dug well",
  "Borehole"  = "Borewell operated by electric pump",
  "Covered Dug Well" = "Covered dug well",
  "Borehole" = "Manual handpump",
  "Other" = "Other"
)


  

```


```{r baseline data cleaning - idexx, include = FALSE}

#Storing idx dataset to idexx -- just to have a dataset for BL data. Lazy coding.
idexx <- idx

#PREPARING IDEXX DATA##########################################################
#Pivoting dataset to be longer for pairing IDEXX data to sample IDs
bl_idexx <- bl%>%
  pivot_longer(cols = c(sample_ID_stored, sample_ID_tap), values_to = "sample_ID", names_to = "sample_type")

#Noting duplicate samples
idexx <- idexx%>%
  mutate(duplicate = ifelse(comments == "DUPLICATE", 1, 0))%>%
  replace_na(duplicate, value = 0)

#Dropping lab blanks, field blanks, and duplicates
idexx <- idexx%>%
  filter(sample_ID != "Lab Blank",
         sample_ID != "Field Blank")%>%
  filter(duplicate < 1)

#Checking IDs which do not match between survey data and lab data
idexx_ids <- idexx$sample_ID
bl_sample_ids <- bl_idexx$sample_ID
idexx_id_check <- idexx%>%
  filter(!(sample_ID %in% bl_sample_ids))

#combining idexx results to survey results
bl_idexx$sample_ID <- as.character(bl_idexx$sample_ID)
idexx <- inner_join(idexx, bl_idexx, by = "sample_ID")
abr$sample_ID <- as.character(abr$sample_ID)
abr <- inner_join(abr, bl_idexx, by = "sample_ID")


#creating new variable to tell the sample type
idexx$sample_type <- idexx$sample_type%>%
  factor()%>%
  fct_recode("Stored" = "sample_ID_stored",
             "Tap" = "sample_ID_tap")
abr$sample_type <- abr$sample_type%>%
  factor()%>%
  fct_recode("Stored" = "sample_ID_stored",
             "Tap" = "sample_ID_tap")

#Calculating MPN for each IDEXX test
idexx <- idexx%>%
  mutate(cf_95lo = quantify_95lo(y_large, y_small, "qt-2000"),
         cf_mpn  = quantify_mpn(y_large, y_small, "qt-2000"),
         cf_95hi = quantify_95hi(y_large, y_small, "qt-2000"))%>%
  mutate_at(vars(cf_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))
  

idexx <- idexx%>%
  mutate(ec_95lo = quantify_95lo(f_large, f_small, "qt-2000"),
         ec_mpn  = quantify_mpn(f_large, f_small, "qt-2000"),
         ec_95hi = quantify_95hi(f_large, f_small, "qt-2000"))%>%
  mutate_at(vars(ec_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))


abr <- abr%>%
  mutate(cf_95lo = quantify_95lo(y_large, y_small, "qt-2000"),
         cf_mpn  = quantify_mpn(y_large, y_small, "qt-2000"),
         cf_95hi = quantify_95hi(y_large, y_small, "qt-2000"))

abr <- abr%>%
  mutate(ec_95lo = quantify_95lo(f_large, f_small, "qt-2000"),
         ec_mpn  = quantify_mpn(f_large, f_small, "qt-2000"),
         ec_95hi = quantify_95hi(f_large, f_small, "qt-2000"))

#Checking cases of NA for total coliform and e coli
#xx <- idexx%>%
 # filter(is.na(cf_mpn) == TRUE)
#xxx <- idexx%>%
 # filter(y_large == 49 & y_small == 48)


#Adding presence/absence data
idexx <- idexx%>%
  mutate(cf_pa = case_when(
    is.na(cf_mpn) == TRUE ~ "Presence",
    cf_mpn > 0 ~ 'Presence',
    cf_mpn == 0 ~ 'Absence'))

idexx <- idexx%>%
  mutate(ec_pa = case_when(
    is.na(ec_mpn) == TRUE ~ "Presence",
    ec_mpn > 0 ~ 'Presence',
    ec_mpn == 0 ~ 'Absence'))

idexx <- idexx%>%
  mutate(cf_pa_binary = case_when(
    cf_mpn > 0 ~ 1,
    cf_mpn == 0 ~ 0))

idexx <- idexx%>%
  mutate(ec_pa_binary = case_when(
    ec_mpn > 0 ~ 1,
    ec_mpn == 0 ~ 0))


abr <- abr%>%
  mutate(cf_pa = case_when(
    cf_mpn > 0 ~ 'Presence',
    cf_mpn == 0 ~ 'Absence'))

abr <- abr%>%
  mutate(ec_pa = case_when(
    ec_mpn > 0 ~ 'Presence',
    ec_mpn == 0 ~ 'Absence'))

abr <- abr%>%
  mutate(cf_pa_binary = case_when(
    cf_mpn > 0 ~ 1,
    cf_mpn == 0 ~ 0))

abr <- abr%>%
  mutate(ec_pa_binary = case_when(
    ec_mpn > 0 ~ 1,
    ec_mpn == 0 ~ 0))

#log transforming data
idexx <- idexx%>%
  mutate(ec_mpn_2 = case_when(ec_mpn <= 0 ~ 0.5, #half the detection limit
                            ec_mpn > 0 ~ ec_mpn))%>%
  mutate(cf_mpn_2 = case_when(cf_mpn <= 0 ~ 0.5,
                            cf_mpn > 0 ~ cf_mpn))%>%
  mutate(ec_log = log(ec_mpn_2, base = 10))%>%
  mutate(cf_log = log(cf_mpn_2, base = 10))


#Adding in WHO risk levels
idexx <- idexx%>%
  mutate(ec_risk = case_when(ec_mpn < 1 ~ "Very Low Risk - Nondetectable",
                             (ec_mpn >= 1 & ec_mpn <= 10) ~ "Low Risk",
                              (ec_mpn > 10 & ec_mpn <= 100) ~ "Intermediate Risk",
                                ec_mpn > 100 ~ "High Risk"))

#write_csv(idexx,"C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/cleaned/BL_idexx_master_cleaned.csv")

abr <- abr%>%
  mutate(ec_log = log(ec_mpn, base = 10))%>%
  mutate(cf_log = log(cf_mpn, base = 10))



```

\newpage
# Followup R1 Data Cleaning
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\




```{r followup r1 data cleaning, include=FALSE}

###GENERAL DATA CLEANING##################################################
#Filtering out test data from training, based on village IDs
unique(r1$R_FU1_unique_id_1)
r1 <- r1%>%
  filter(!(R_FU1_unique_id_1 == 88888 |
           R_FU1_unique_id_1 == 99999)) # Clean data doesn't require this step


#Selecting r1 data key variables for WQ testing
r1 <- r1%>%
  dplyr::select(R_FU1_unique_id_1, R_FU1_unique_id_2, R_FU1_unique_id_3, unique_id_num, R_FU1_r_cen_village_name_str, R_FU1_consent, R_FU1_water_source_prim, R_FU1_primary_water_label, R_FU1_water_qual_test, R_FU1_wq_stored_bag, R_FU1_stored_bag_source, R_FU1_sample_ID_stored, R_FU1_bag_ID_stored, R_FU1_fc_stored, R_FU1_wq_chlorine_storedfc_again, R_FU1_tc_stored, R_FU1_wq_chlorine_storedtc_again, R_FU1_sample_ID_tap, R_FU1_bag_ID_tap, R_FU1_fc_tap, R_FU1_wq_tap_fc_again, R_FU1_tc_tap, R_FU1_wq_tap_tc_again, R_FU1_instancename)

#Assigning more meaningful variable names
r1 <- r1%>%
  rename_all(~stringr::str_replace(.,"R_FU1_",""))%>%
  rename(village = "r_cen_village_name_str")%>%
  rename(village_ID = "unique_id_1")%>%
  rename(unique_id = "unique_id_num")%>%
  rename(tc_stored_2 = "wq_chlorine_storedtc_again")%>%
  rename(fc_stored_2 = "wq_chlorine_storedfc_again")%>%
  rename(fc_tap_2 = "wq_tap_fc_again")%>%
  rename(tc_tap_2 = "wq_tap_tc_again")

#Pairing village information
r1$village_ID <- as.character(r1$village_ID)
r1 <- left_join(r1, village_details, by = "village_ID")


#Filtering out HHs that did not consent
r1 <- r1%>%
  filter(is.na(consent) == FALSE)
  
#Other way:
  #rename(fc_stored = R_FU_fc_stored)%>%
  #rename(tc_stored = R_FU_tc_stored)%>%
  #rename(fc_tap = R_FU_fc_tap)%>%
  #rename(tc_tap = R_FU_tc_tap)%>%
  #rename(sample_ID_stored = R_FU_sample_ID_stored)

#Correcting sample IDs in R1 dataset? Need to check
#for(i in (1:length(r1$unique_id))){
 # if(r1$unique_id[i] == 50301106013){
  #  r1$sample_ID_stored[i] = 20290
#  }
#}

#Renamed control vs treatment assignment
r1$assignment <- factor(r1$assignment)%>%
  fct_recode("Control" = "C",
             "Treatment" = "T")

#Removing cases of "999" being reported in a measurement. Replacing with NA values for now.
xx <- r1%>%
  filter(fc_stored > 2.0 |
           fc_stored_2 > 2.0 |
           fc_tap > 2.0 |
           fc_tap_2 > 2.0 |
           tc_stored > 2.0 |
           tc_stored_2 > 2.0 |
           tc_tap > 2.0 |
           tc_tap_2 > 2.0)

#write_csv(xx, "C:/Users/jerem/Box/India Water project/2_Pilot/Data/0-data cleaning/chlorine_data_review_20240229.csv")

r1 <- r1 %>%
  mutate_at(vars(fc_stored_2, tc_stored, fc_tap, tc_tap, tc_tap_2), ~ifelse(. > 100, 0, .))

#Averaging chlorine data across two tests
r1 <- r1%>%
  mutate(fc_stored_avg = rowMeans(dplyr::select(r1, starts_with("fc_stored")), na.rm = TRUE))%>%
  mutate(fc_tap_avg = rowMeans(dplyr::select(r1, starts_with("fc_tap")), na.rm = TRUE))%>%
  mutate(tc_stored_avg = rowMeans(dplyr::select(r1, starts_with("tc_stored")), na.rm = TRUE))%>%
  mutate(tc_tap_avg = rowMeans(dplyr::select(r1, starts_with("tc_tap")), na.rm = TRUE))
  
r1$fc_stored_avg <- round(r1$fc_stored_avg, digits = 3)
r1$fc_tap_avg <- round(r1$fc_tap_avg, digits = 3)
r1$tc_stored_avg <- round(r1$tc_stored_avg, digits = 3)
r1$tc_tap_avg <- round(r1$tc_tap_avg, digits = 3)






```


```{r r1 data cleaning - idexx, include = FALSE}

#Storing raw idx data to idexx_r1. Lazy coding. Much of this should be processed once.
#Will update more later
idexx_r1 <- idx

#PREPARING IDEXX DATA##########################################################
#Pivoting dataset to be longer for pairing IDEXX data to sample IDs
r1_for_idexx <- r1%>%
  pivot_longer(cols = c(sample_ID_stored, sample_ID_tap), values_to = "sample_ID", names_to = "sample_type")

#Noting duplicate samples
idexx_r1 <- idexx_r1%>%
  mutate(duplicate = ifelse(comments == "DUPLICATE", 1, 0))%>%
  replace_na(duplicate, value = 0)

#Dropping lab blanks, field blanks, and duplicates
idexx_r1 <- idexx_r1%>%
  filter(sample_ID != "Lab Blank",
         sample_ID != "Field Blank")%>%
  filter(duplicate < 1)

#Checking IDs which do not match between survey data and lab data
idexx_ids <- idexx_r1$sample_ID
r1_sample_ids <- r1_for_idexx$sample_ID
idexx_id_check <- idexx_r1%>%
  filter(!(sample_ID %in% r1_sample_ids))

#combining idexx results to survey results
r1_for_idexx$sample_ID <- as.character(r1_for_idexx$sample_ID)
idexx_r1 <- inner_join(idexx_r1, r1_for_idexx, by = "sample_ID")
#abr$sample_ID <- as.character(abr$sample_ID)
#abr <- inner_join(abr, bl_idexx, by = "sample_ID")


#creating new variable to tell the sample type
idexx_r1$sample_type <- idexx_r1$sample_type%>%
  factor()%>%
  fct_recode("Stored" = "sample_ID_stored",
             "Tap" = "sample_ID_tap")
#abr$sample_type <- abr$sample_type%>%
 # factor()%>%
  #fct_recode("Stored" = "sample_ID_stored",
   #          "Tap" = "sample_ID_tap")

#Calculating MPN for each IDEXX test
idexx_r1 <- idexx_r1%>%
  mutate(cf_95lo = quantify_95lo(y_large, y_small, "qt-2000"),
         cf_mpn  = quantify_mpn(y_large, y_small, "qt-2000"),
         cf_95hi = quantify_95hi(y_large, y_small, "qt-2000"))%>%
  mutate_at(vars(cf_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))

idexx_r1 <- idexx_r1%>%
  mutate(ec_95lo = quantify_95lo(f_large, f_small, "qt-2000"),
         ec_mpn  = quantify_mpn(f_large, f_small, "qt-2000"),
         ec_95hi = quantify_95hi(f_large, f_small, "qt-2000"))%>%
  mutate_at(vars(ec_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))



#Adding presence/absence data
idexx_r1 <- idexx_r1%>%
  mutate(cf_pa = case_when(
    is.na(cf_mpn) == TRUE ~ "Presence",
    cf_mpn > 0 ~ 'Presence',
    cf_mpn == 0 ~ 'Absence'))

idexx_r1 <- idexx_r1%>%
  mutate(ec_pa = case_when(
    is.na(ec_mpn) == TRUE ~ "Presence",
    ec_mpn > 0 ~ 'Presence',
    ec_mpn == 0 ~ 'Absence'))

idexx_r1 <- idexx_r1%>%
  mutate(cf_pa_binary = case_when(
    cf_mpn > 0 ~ 1,
    cf_mpn == 0 ~ 0))

idexx_r1 <- idexx_r1%>%
  mutate(ec_pa_binary = case_when(
    ec_mpn > 0 ~ 1,
    ec_mpn == 0 ~ 0))


#log transforming data
idexx_r1 <- idexx_r1%>%
  mutate(ec_mpn_2 = case_when(ec_mpn <= 0 ~ 0.5, #half the detection limit
                            ec_mpn > 0 ~ ec_mpn))%>%
  mutate(cf_mpn_2 = case_when(cf_mpn <= 0 ~ 0.5,
                            cf_mpn > 0 ~ cf_mpn))%>%
  mutate(ec_log = log(ec_mpn_2, base = 10))%>%
  mutate(cf_log = log(cf_mpn_2, base = 10))
#Make - inf values be 0


#Adding in WHO risk levels
idexx_r1 <- idexx_r1%>%
  mutate(ec_risk = case_when(ec_mpn < 1 ~ "Very Low Risk - Nondetectable",
                             (ec_mpn >= 1 & ec_mpn <= 10) ~ "Low Risk",
                              (ec_mpn > 10 & ec_mpn <= 100) ~ "Intermediate Risk",
                                ec_mpn > 100 ~ "High Risk"))

#write_csv(idexx_r1,"C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/cleaned/R1_idexx_master_cleaned.csv")


```



\newpage
# Followup R2 Data Cleaning
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\




```{r followup r2 data cleaning, include= FALSE}

###GENERAL DATA CLEANING##################################################
#Filtering out test data from training, based on village IDs
unique(r2$R_FU2_unique_id_1)
r2 <- r2%>%
  filter(!(R_FU2_unique_id_1 == 88888 |
           R_FU2_unique_id_1 == 99999)) # Clean data doesn't require this step


#Selecting r2 data key variables for WQ testing
r2 <- r2%>%
  dplyr::select(R_FU2_unique_id_1, R_FU2_unique_id_2, R_FU2_unique_id_3, unique_id_num, R_FU2_r_cen_village_name_str, R_FU2_consent, R_FU2_water_source_prim, R_FU2_primary_water_label, R_FU2_water_qual_test, R_FU2_wq_stored_bag, R_FU2_stored_bag_source, R_FU2_sample_ID_stored, R_FU2_bag_ID_stored, R_FU2_fc_stored, R_FU2_wq_chlorine_storedfc_again, R_FU2_tc_stored, R_FU2_wq_chlorine_storedtc_again, R_FU2_sample_ID_tap, R_FU2_bag_ID_tap, R_FU2_fc_tap, R_FU2_wq_tap_fc_again, R_FU2_tc_tap, R_FU2_wq_tap_tc_again, R_FU2_instancename)

#Assigning more meaningful variable names
r2 <- r2%>%
  rename_all(~stringr::str_replace(.,"R_FU2_",""))%>%
  rename(village = "r_cen_village_name_str")%>%
  rename(village_ID = "unique_id_1")%>%
  rename(unique_id = "unique_id_num")%>%
  rename(tc_stored_2 = "wq_chlorine_storedtc_again")%>%
  rename(fc_stored_2 = "wq_chlorine_storedfc_again")%>%
  rename(fc_tap_2 = "wq_tap_fc_again")%>%
  rename(tc_tap_2 = "wq_tap_tc_again")

#Pairing village information
r2$village_ID <- as.character(r2$village_ID)
r2 <- left_join(r2, village_details, by = "village_ID")


#Filtering out HHs that did not consent
r2 <- r2%>%
  filter(is.na(consent) == FALSE)
  
#Other way:
  #rename(fc_stored = R_FU_fc_stored)%>%
  #rename(tc_stored = R_FU_tc_stored)%>%
  #rename(fc_tap = R_FU_fc_tap)%>%
  #rename(tc_tap = R_FU_tc_tap)%>%
  #rename(sample_ID_stored = R_FU_sample_ID_stored)

#Correcting sample IDs in r2 dataset? Need to check
#for(i in (1:length(r2$unique_id))){
 # if(r2$unique_id[i] == 50301106013){
  #  r2$sample_ID_stored[i] = 20290
#  }
#}

#Renamed control vs treatment assignment
r2$assignment <- factor(r2$assignment)%>%
  fct_recode("Control" = "C",
             "Treatment" = "T")

#Removing cases of "999" being reported in a measurement. Replacing with NA values for now.
xx <- r2%>%
  filter(fc_stored > 2.0 |
           fc_stored_2 > 2.0 |
           fc_tap > 2.0 |
           fc_tap_2 > 2.0 |
           tc_stored > 2.0 |
           tc_stored_2 > 2.0 |
           tc_tap > 2.0 |
           tc_tap_2 > 2.0)

#write_csv(xx, "C:/Users/jerem/Box/India Water project/2_Pilot/Data/0-data cleaning/chlorine_data_review_20240229.csv")

r2 <- r2 %>%
  mutate_at(vars(fc_stored_2, tc_stored, fc_tap, tc_tap, tc_tap_2), ~ifelse(. > 100, 0, .))

#Averaging chlorine data across two tests
r2 <- r2%>%
  mutate(fc_stored_avg = rowMeans(dplyr::select(r2, starts_with("fc_stored")), na.rm = TRUE))%>%
  mutate(fc_tap_avg = rowMeans(dplyr::select(r2, starts_with("fc_tap")), na.rm = TRUE))%>%
  mutate(tc_stored_avg = rowMeans(dplyr::select(r2, starts_with("tc_stored")), na.rm = TRUE))%>%
  mutate(tc_tap_avg = rowMeans(dplyr::select(r2, starts_with("tc_tap")), na.rm = TRUE))
  
r2$fc_stored_avg <- round(r2$fc_stored_avg, digits = 3)
r2$fc_tap_avg <- round(r2$fc_tap_avg, digits = 3)
r2$tc_stored_avg <- round(r2$tc_stored_avg, digits = 3)
r2$tc_tap_avg <- round(r2$tc_tap_avg, digits = 3)

#






```


```{r r2 data cleaning - idexx, include = FALSE}

#PREPARING IDEXX DATA##########################################################
#Adding village name column
village_ID <- village_details%>%
  dplyr::select(village_name, village_ID, assignment)
idexx_r2 <- idexx_r2%>%
  mutate(village_ID = as.character(village))%>%
  mutate(sample_ID = unique_sample_id)

idexx_r2 <- left_join(idexx_r2, village_ID, by = "village_ID")


#Pivoting dataset to be longer for pairing IDEXX data to sample IDs
r2_for_idexx <- r2%>%
  pivot_longer(cols = c(sample_ID_stored, sample_ID_tap), values_to = "sample_ID", names_to = "sample_type")

#Noting duplicate samples
#idexx_r2 <- idexx_r2%>%
 # mutate(duplicate = ifelse(comments == "DUPLICATE", 1, 0))%>%
  #replace_na(duplicate, value = 0)

#Noting lab blank and field blanks
idexx_r2 <- idexx_r2%>%
  mutate(lab_blank = ifelse((end_comments == "Lab Blank" | 
                               end_comments == "Lab blank" |
                               end_comments == "This is LAB BLANK results")
                            & sample_ID == 0, 1, 0))%>%
  replace_na(lab_blank, value = 0)

idexx_r2 <- idexx_r2%>%
  mutate(field_blank = ifelse((end_comments == "Field Blank" | 
                                 end_comments == "Field blank" |
                                 end_comments == "This is FIELD BLANK")
                            & sample_ID == 0, 1, 0))%>%
  replace_na(field_blank, value = 0)


#Dropping lab blanks, field blanks, and duplicates
#idexx_r2 <- idexx_r2%>%
 # filter(sample_ID != "Lab Blank",
  #       sample_ID != "Field Blank")%>%
  #filter(duplicate < 1)

#Checking IDs which do not match between survey data and lab data
#idexx_ids <- idexx_r2$sample_ID
#r2_sample_ids <- r2_for_idexx$sample_ID
#idexx_id_check <- idexx_r2%>%
 # filter(!(sample_ID %in% r2_sample_ids))

#combining idexx results to survey results
#r2_for_idexx$sample_ID <- as.numeric(r2_for_idexx$sample_ID)
#idexx_r2 <- inner_join(idexx_r2, r2_for_idexx, by = "sample_ID")
#abr$sample_ID <- as.character(abr$sample_ID)
#abr <- inner_join(abr, bl_idexx, by = "sample_ID")


#creating new variable to tell the sample type
idexx_r2 <- idexx_r2%>%
  mutate(sample_type = ifelse((sample_ID < 11000 & sample_ID > 9000), "Tap", 
                        ifelse((sample_ID > 19000 & sample_ID < 21000), "Stored", "Blank")))


#Other way using survey data
#idexx_r2$sample_type <- idexx_r2$sample_type%>%
  #factor()%>%
  #fct_recode("Stored" = "sample_ID_stored",
             #"Tap" = "sample_ID_tap")

#abr$sample_type <- abr$sample_type%>%
 # factor()%>%
  #fct_recode("Stored" = "sample_ID_stored",
   #          "Tap" = "sample_ID_tap")

#Calculating MPN for each IDEXX test
idexx_r2 <- idexx_r2%>%
  mutate(cf_95lo = quantify_95lo(large_c_yellow, small_c_yellow, "qt-2000"),
         cf_mpn  = quantify_mpn(large_c_yellow, small_c_yellow, "qt-2000"),
         cf_95hi = quantify_95hi(large_c_yellow, small_c_yellow, "qt-2000"))%>%
  mutate_at(vars(cf_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))

idexx_r2 <- idexx_r2%>%
  mutate(ec_95lo = quantify_95lo(large_c_flurosce, small_c_flurosce, "qt-2000"),
         ec_mpn  = quantify_mpn(large_c_flurosce, small_c_flurosce, "qt-2000"),
         ec_95hi = quantify_95hi(large_c_flurosce, small_c_flurosce, "qt-2000"))%>%
  mutate_at(vars(ec_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))



#Adding presence/absence data
idexx_r2 <- idexx_r2%>%
  mutate(cf_pa = case_when(
    is.na(cf_mpn) == TRUE ~ "Presence",
    cf_mpn > 0 ~ 'Presence',
    cf_mpn == 0 ~ 'Absence'))

idexx_r2 <- idexx_r2%>%
  mutate(ec_pa = case_when(
    is.na(ec_mpn) == TRUE ~ "Presence",
    ec_mpn > 0 ~ 'Presence',
    ec_mpn == 0 ~ 'Absence'))

idexx_r2 <- idexx_r2%>%
  mutate(cf_pa_binary = case_when(
    cf_mpn > 0 ~ 1,
    cf_mpn == 0 ~ 0))

idexx_r2 <- idexx_r2%>%
  mutate(ec_pa_binary = case_when(
    ec_mpn > 0 ~ 1,
    ec_mpn == 0 ~ 0))


#log transforming data
idexx_r2 <- idexx_r2%>%
  mutate(ec_mpn_2 = case_when(ec_mpn <= 0 ~ 0.5, #half the detection limit
                            ec_mpn > 0 ~ ec_mpn))%>%
  mutate(cf_mpn_2 = case_when(cf_mpn <= 0 ~ 0.5,
                            cf_mpn > 0 ~ cf_mpn))%>%
  mutate(ec_log = log(ec_mpn_2, base = 10))%>%
  mutate(cf_log = log(cf_mpn_2, base = 10))
#Make - inf values be 0

#Adding in WHO risk levels
idexx_r2 <- idexx_r2%>%
  mutate(ec_risk = case_when(ec_mpn < 1 ~ "Very Low Risk - Nondetectable",
                             (ec_mpn >= 1 & ec_mpn <= 10) ~ "Low Risk",
                              (ec_mpn > 10 & ec_mpn <= 100) ~ "Intermediate Risk",
                                ec_mpn > 100 ~ "High Risk"))

#write_csv(idexx_r2,"C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/cleaned/R2_idexx_master_cleaned.csv")




```


\newpage

# Followup R3 Data Cleaning



```{r followup r3 data cleaning, include= FALSE}

###GENERAL DATA CLEANING##################################################
#Filtering out test data from training, based on village IDs
unique(r3$R_FU3_unique_id_1)
r3 <- r3%>%
  filter(!(R_FU3_unique_id_1 == 88888 |
           R_FU3_unique_id_1 == 99999)) # Clean data doesn't require this step


#Selecting r3 data key variables for WQ testing
r3 <- r3%>%
  dplyr::select(R_FU3_unique_id_1, R_FU3_unique_id_2, R_FU3_unique_id_3, unique_id_num, R_FU3_r_cen_village_name_str, submission_date, R_FU3_consent, R_FU3_water_source_prim, R_FU3_primary_water_label, R_FU3_water_qual_test, R_FU3_wq_stored_bag, R_FU3_stored_bag_source, R_FU3_sample_ID_stored, R_FU3_bag_ID_stored, R_FU3_fc_stored, R_FU3_wq_chlorine_storedfc_again, R_FU3_tc_stored, R_FU3_wq_chlorine_storedtc_again, R_FU3_sample_ID_tap, R_FU3_bag_ID_tap, R_FU3_fc_tap, R_FU3_wq_tap_fc_again, R_FU3_tc_tap, R_FU3_wq_tap_tc_again, R_FU3_instancename)

#Assigning more meaningful variable names
r3 <- r3%>%
  rename_all(~stringr::str_replace(.,"R_FU3_",""))%>%
  rename(village = "r_cen_village_name_str")%>%
  rename(village_ID = "unique_id_1")%>%
  rename(unique_id = "unique_id_num")%>%
  rename(tc_stored_2 = "wq_chlorine_storedtc_again")%>%
  rename(fc_stored_2 = "wq_chlorine_storedfc_again")%>%
  rename(fc_tap_2 = "wq_tap_fc_again")%>%
  rename(tc_tap_2 = "wq_tap_tc_again")

#Pairing village information
r3$village_ID <- as.character(r3$village_ID)
r3 <- left_join(r3, village_details, by = "village_ID")


#Filtering out HHs that did not consent
r3 <- r3%>%
  filter(is.na(consent) == FALSE)
  
#Other way:
  #rename(fc_stored = R_FU_fc_stored)%>%
  #rename(tc_stored = R_FU_tc_stored)%>%
  #rename(fc_tap = R_FU_fc_tap)%>%
  #rename(tc_tap = R_FU_tc_tap)%>%
  #rename(sample_ID_stored = R_FU_sample_ID_stored)


#Renamed control vs treatment assignment
r3$assignment <- factor(r3$assignment)%>%
  fct_recode("Control" = "C",
             "Treatment" = "T")

#Removing cases of "999" being reported in a measurement. Replacing with NA values for now.
xx <- r3%>%
  filter(fc_stored > 2.0 |
           fc_stored_2 > 2.0 |
           fc_tap > 2.0 |
           fc_tap_2 > 2.0 |
           tc_stored > 2.0 |
           tc_stored_2 > 2.0 |
           tc_tap > 2.0 |
           tc_tap_2 > 2.0)

#write_csv(xx, "C:/Users/jerem/Box/India Water project/2_Pilot/Data/0-data cleaning/chlorine_data_review_20240229.csv")

r3 <- r3 %>%
  mutate_at(vars(fc_stored_2, tc_stored, fc_tap, tc_tap, tc_tap_2), ~ifelse(. > 100, 0, .))

#Averaging chlorine data across two tests
r3 <- r3%>%
  mutate(fc_stored_avg = rowMeans(dplyr::select(r3, starts_with("fc_stored")), na.rm = TRUE))%>%
  mutate(fc_tap_avg = rowMeans(dplyr::select(r3, starts_with("fc_tap")), na.rm = TRUE))%>%
  mutate(tc_stored_avg = rowMeans(dplyr::select(r3, starts_with("tc_stored")), na.rm = TRUE))%>%
  mutate(tc_tap_avg = rowMeans(dplyr::select(r3, starts_with("tc_tap")), na.rm = TRUE))
  
r3$fc_stored_avg <- round(r3$fc_stored_avg, digits = 3)
r3$fc_tap_avg <- round(r3$fc_tap_avg, digits = 3)
r3$tc_stored_avg <- round(r3$tc_stored_avg, digits = 3)
r3$tc_tap_avg <- round(r3$tc_tap_avg, digits = 3)

#






```



```{r r3 data cleaning - idexx, include = FALSE}

#PREPARING IDEXX DATA##########################################################
#Adding village name column
village_ID <- village_details%>%
  dplyr::select(village_name, village_ID, assignment)
idexx_r3 <- idexx_r3%>%
  mutate(village_ID = as.character(village))%>%
  mutate(sample_ID = unique_sample_id)

idexx_r3 <- left_join(idexx_r3, village_ID, by = "village_ID")


#Pivoting dataset to be longer for pairing IDEXX data to sample IDs
r3_for_idexx <- r3%>%
  pivot_longer(cols = c(sample_ID_stored, sample_ID_tap), values_to = "sample_ID", names_to = "sample_type")

#Noting duplicate samples
#idexx_r3 <- idexx_r3%>%
 # mutate(duplicate = ifelse(comments == "DUPLICATE", 1, 0))%>%
  #replace_na(duplicate, value = 0)

#Noting lab blank and field blanks
idexx_r3 <- idexx_r3%>%
  mutate(lab_blank = ifelse((end_comments == "Lab Blank" | 
                               end_comments == "Lab blank" |
                               end_comments == "This is LAB BLANK results")
                            & sample_ID == 0, 1, 0))%>%
  replace_na(lab_blank, value = 0)

idexx_r3 <- idexx_r3%>%
  mutate(field_blank = ifelse((end_comments == "Field Blank" | 
                                 end_comments == "Field blank" |
                                 end_comments == "This is FIELD BLANK")
                            & sample_ID == 0, 1, 0))%>%
  replace_na(field_blank, value = 0)

#Noting solar tank water
idexx_r3 <- idexx_r3%>%
  mutate(solar_water = ifelse((end_comments == "Solar water" | 
                                 end_comments == "Solar Tank Water"), 1, 0))%>%
  replace_na(solar_water, value = 0)


#Dropping lab blanks, field blanks, and duplicates
#idexx_r3 <- idexx_r3%>%
 # filter(sample_ID != "Lab Blank",
  #       sample_ID != "Field Blank")%>%
  #filter(duplicate < 1)

#Checking IDs which do not match between survey data and lab data
 #idexx_ids <- idexx_r3$sample_ID
 #r3_sample_ids <- r3_for_idexx$sample_ID
 #idexx_id_check <- idexx_r3%>%
  # filter(!(sample_ID %in% r3_sample_ids))%>%
   #filter(sample_ID != 0)
 #x <- r3%>%
  # filter(village_ID == idexx_id_check$village)
#Checking which villages have missing IDEXX data
 #xx <- unique(idexx_r3$village_name.x)
 #village_check <- r3_for_idexx%>%
    #filter(!(village_name %in% xx))%>%
    #filter(sample_ID != 0)
 
#Updating sample ID for 10141


#combining idexx results to survey results
r3_for_idexx$sample_ID <- as.numeric(r3_for_idexx$sample_ID)
idexx_r3 <- left_join(idexx_r3, r3_for_idexx, by = "sample_ID")

#abr$sample_ID <- as.character(abr$sample_ID)
#abr <- inner_join(abr, bl_idexx, by = "sample_ID")


#creating new variable to tell the sample type
idexx_r3 <- idexx_r3%>%
  mutate(sample_type = ifelse((sample_ID < 11000 & sample_ID > 9000), "Tap", 
                        ifelse((sample_ID > 19000 & sample_ID < 21000), "Stored", "Blank")))


#Other way using survey data
#idexx_r3$sample_type <- idexx_r3$sample_type%>%
  #factor()%>%
  #fct_recode("Stored" = "sample_ID_stored",
             #"Tap" = "sample_ID_tap")

#abr$sample_type <- abr$sample_type%>%
 # factor()%>%
  #fct_recode("Stored" = "sample_ID_stored",
   #          "Tap" = "sample_ID_tap")

#Calculating MPN for each IDEXX test
idexx_r3 <- idexx_r3%>%
  mutate(cf_95lo = quantify_95lo(large_c_yellow, small_c_yellow, "qt-2000"),
         cf_mpn  = quantify_mpn(large_c_yellow, small_c_yellow, "qt-2000"),
         cf_95hi = quantify_95hi(large_c_yellow, small_c_yellow, "qt-2000"))%>%
  mutate_at(vars(cf_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))

idexx_r3 <- idexx_r3%>%
  mutate(ec_95lo = quantify_95lo(large_c_flurosce, small_c_flurosce, "qt-2000"),
         ec_mpn  = quantify_mpn(large_c_flurosce, small_c_flurosce, "qt-2000"),
         ec_95hi = quantify_95hi(large_c_flurosce, small_c_flurosce, "qt-2000"))%>%
  mutate_at(vars(ec_mpn), ~ifelse(is.na(.) == TRUE, 2419, .))



#Adding presence/absence data
idexx_r3 <- idexx_r3%>%
  mutate(cf_pa = case_when(
    is.na(cf_mpn) == TRUE ~ "Presence",
    cf_mpn > 0 ~ 'Presence',
    cf_mpn == 0 ~ 'Absence'))

idexx_r3 <- idexx_r3%>%
  mutate(ec_pa = case_when(
    is.na(ec_mpn) == TRUE ~ "Presence",
    ec_mpn > 0 ~ 'Presence',
    ec_mpn == 0 ~ 'Absence'))

idexx_r3 <- idexx_r3%>%
  mutate(cf_pa_binary = case_when(
    cf_mpn > 0 ~ 1,
    cf_mpn == 0 ~ 0))

idexx_r3 <- idexx_r3%>%
  mutate(ec_pa_binary = case_when(
    ec_mpn > 0 ~ 1,
    ec_mpn == 0 ~ 0))


#log transforming data
#Making nondetects == 0.5 MPN/100 mL so the data can be log-transformed#
idexx_r3 <- idexx_r3%>%
  mutate(ec_mpn_2 = case_when(ec_mpn <= 0 ~ 0.5, #half the detection limit
                            ec_mpn > 0 ~ ec_mpn))%>%
  mutate(cf_mpn_2 = case_when(cf_mpn <= 0 ~ 0.5,
                            cf_mpn > 0 ~ cf_mpn))%>%
  mutate(ec_log = log(ec_mpn_2, base = 10))%>%
  mutate(cf_log = log(cf_mpn_2, base = 10))
#Make - inf values be 0


#Adding in WHO risk levels
idexx_r3 <- idexx_r3%>%
  mutate(ec_risk = case_when(ec_mpn < 1 ~ "Very Low Risk - Nondetectable",
                             (ec_mpn >= 1 & ec_mpn <= 10) ~ "Low Risk",
                              (ec_mpn > 10 & ec_mpn <= 100) ~ "Intermediate Risk",
                                ec_mpn > 100 ~ "High Risk"))

#write_csv(idexx_r3,"C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/cleaned/R3_idexx_master_cleaned.csv")




```

\newpage
# Endline Data Cleaning

```{r Endline data cleaning - changing variable names}

#------------------------ Apply the labels for variables---------------------#

temp.labels <- lapply(el , var_lab)

#create a data with labels
#Code from Astha
df.label <- as.data.frame(t(as.data.frame(do.call(cbind, temp.labels)))) 
df.label<- tibble::rownames_to_column(df.label) 
df.label <- df.label %>% rename(variable = rowname, label = V1)  
auto_generated_labels <- c(df.label$variable)

#include labels given manually 
df.label.manual <- read_xlsx(paste0(user_path(),"4_other/R_code_HH_Survey_labels.xlsx"))

df.var <- as.data.frame(names(el)) #List of variables in the data

# assign labels to variable that were generated
#df.label.manual <- df.label.manual %>% 
 # mutate(new_var = ifelse(Variable %in% auto_generated_labels, 0,1)) %>% 
  #filter(new_var == 1) %>% 
  #select(-new_var) %>% 
  #rename(variable = Variable, label = Label)

#df.label <- rbind(df.label, df.label.manual)
# create a function that assigns the label to appropriate variable


#create a date variable
el$datetime <- strptime(el$R_E_starttime, format = "%Y-%m-%d %H:%M:%S")

el$date <- as_date(el$datetime) 

el$End_date <- as_date(el$End_date)



```


```{r Endline data cleaning - cleaning data}


#------------------------ Keep consented cases ----------------------------------------#

el.consent <- el[which(el$R_E_consent==1) ,]

el <- el%>%
  filter(R_E_consent == 1)


#------------ Assign the correct treatment to villages---------------------------#

el.consent <- el.consent %>% mutate(Treatment = ifelse(R_E_r_cen_village_name_str %in%
                                                                   c("Birnarayanpur","Nathma", "Badabangi","Naira", "Bichikote", "Karnapadu","Mukundpur", "Tandipur", "Gopi Kankubadi", "Asada"), "T", "C"))



#Using labelmaker to make transfer labels for the whole dataset
el <- labelmaker(el)
el.consent <- labelmaker(el.consent)


#Renaming all variables to remove prefixes
el <- el%>%
  rename_all(~stringr::str_replace(.,"R_E_",""))%>%
  rename(village_name = "r_cen_village_name_str")

#Pairing village information
#el$village_name <- as.character(el$village_name)
#el <- left_join(el, village_details, by = "village_name")

#Setting treatment vs control assignment
el <- el %>% mutate(assignment = ifelse(village_name %in% c("Birnarayanpur","Nathma", "Badabangi","Naira", "Bichikote", "Karnapadu","Mukundpur", "Tandipur", "Gopi Kankubadi", "Asada"), "Treatment", "Control"))



#Recoding factor levels for water_source_prim
el <- el%>%
  mutate(prim_source = NA)
el$prim_source <- el$water_source_prim%>%
  fct_recode(
    "Government-provided Tap" = "Government provided household Taps (supply paani) connected to RWSS/Basudha/JJM",
  "Community Tap" = "Household tap connections not connected to RWSS/Basudha/JJM tank",
  "Community Tap" = "Government provided community standpipe (connected to piped system, through Vasu",
  "Community Tap" = "Gram Panchayat/Other Community Standpipe (e.g. solar pump, PVC tank)",
  "Surface Water"  = "Directly fetched by surface water (river/dam/lake/pond/stream/canal/irrigation c",
  "Surface Water" = "Private Surface well",
  "Surface Water" = "Uncovered dug well",
  "Borehole"  = "Borewell operated by electric pump",
  "Covered Dug Well" = "Covered dug well",
  "Borehole" = "Manual handpump",
  "Other" = "Other"
)%>%
  fct_relevel("Government-provided Tap", "Community Tap", "Surface Water", 
              "Borehole", "Covered Dug Well", "Other")


```




\newpage

# Gram Vikas Data Cleaning

```{r Gram Vikas Data cleaning}


#creating test date
gv <- gv%>%
  filter(is.na(Village) == FALSE)%>%
  mutate(test_date = as_date(`valve_open (Time Answered)`))%>%
  mutate(visit_date_alt = as_date(`Drafted On`))%>%
  mutate(visit_date = as_date(`Date:`))

#Replacing missing date values
gv <- gv%>%
  mutate(visit_date = coalesce(visit_date, visit_date_alt))

#Selecting village names to repeat through in a for loop
mon_villages <- unique(gv$Village)

#Processing refill data
gv <- gv%>%
  mutate(refill = `Did you/the pump operator refill chlorine tablets since the last visit?`)%>%
  mutate(ilc_device = `What device is installed?`)%>%
  mutate(purall_cartridge_1 = `Did you provide a new PurAll chlorine cartridge? (1)`)



#Selecting nearest and farthest tap data to be displayed
mon_near <- gv%>%
  dplyr::select(test_date, Village, nearest_tap_fc, nearest_tap_tc, nearest_stored_fc, nearest_stored_tc)%>%
  pivot_longer(names_to = "chlorine_test", values_to = "chlorine_concentration",
               cols = c(nearest_tap_fc, nearest_tap_tc, nearest_stored_fc, nearest_stored_tc))

mon_far <- gv%>%
  dplyr::select(test_date, Village, farthest_tap_fc, farthest_tap_tc, farthest_stored_fc, farthest_stored_tc)%>%
  pivot_longer(names_to = "chlorine_test", values_to = "chlorine_concentration",
               cols = c(farthest_tap_fc, farthest_tap_tc, farthest_stored_fc, farthest_stored_tc))
  



#Selecting refill data
gv_refill <- gv%>%
  filter(refill == "Yes")

#Creating refill check dates - date-based method
#We ultimately want to get to a place where we can estimate tablet decay rate in each village
gv_refill <- gv_refill%>%
  mutate(refill_date_1 = visit_date + 14)%>%
  mutate(refill_date_2 = visit_date + 18)%>%
  mutate(refill_date_3 = visit_date + 20)%>%
  mutate(refill_date_0 = visit_date)
#Selecting dates
gv_refill <- gv_refill%>%
  dplyr::select(Village, refill_date_0, refill_date_1, refill_date_2, refill_date_3)
#making this dataset compatible with the plot below
gv_refill <- gv_refill%>%
  mutate(village_name = Village)%>%
  mutate(village_name = ifelse(village_name == "Gopikankubadi", "GopiKankubadi", village_name))

```















\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
\newpage
# Analysis
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

#BL Chlorine Results

```{r baseline chlorine data desc stats}

###Displaying chlorine test data for each village
#Arranging data so chlorine test data is in one column
chlorine <- bl%>%
  pivot_longer(cols = c(fc_tap_avg, fc_stored_avg, tc_tap_avg, tc_stored_avg), values_to = "chlorine_concentration", names_to = "chlorine_test_type")

#Removing NAs from no respondent being available
chlorine <- chlorine%>%
  filter(is.na(chlorine_concentration) == FALSE)

p1 <- chlorine%>%
  ggplot() +
  geom_point(aes(x = chlorine_test_type, y = chlorine_concentration)) +
    geom_hline(yintercept=0.14, linetype="dashed", color = "red") + 
  annotate("text", x = 1.5, y = .25, size = 2, color = "red",
           label = "Detection Limit = 0.14 mg/L") +
  facet_wrap(~ block) + 
  scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0),
                     limits = c(0, 2.0),
                     expand = c(0,0)) +
  labs(x = "Chlorine Test", y = "Chlorine Concentration (mg/L)") +
  theme_bw()

p1


#Selecting for data that are > 0.10 mg/L
chlorine_check <- chlorine%>%
  filter(chlorine_concentration > 0.14)%>%
  dplyr::select(unique_id, unique_id_2, village, chlorine_test_type, chlorine_concentration)

#Writing csv
#write_csv(chlorine_check, "C:/Users/jerem/Box/India Water project/2_Pilot/Data Checks/baseline_survey/20231108_chlorine_data_check.csv")

#Creating table
chlorine_check%>%
  kbl(
    #col.names = linebreak(column_names, align = "l"),
    #escape = FALSE
    )%>%
  kable_styling(position = "center",
                bootstrap_options = "striped",
                latex_options = c("scale_down"))%>%
  add_header_above(c("Free and Total Chlorine Concentrations - Positive Samples (mg/L) " =5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE)%>%
  column_spec(2, width = "75px")

#Creating table
#stargazer(chlorine_check)
  
```

\newpage

#BL IDEXX Results

```{r Baseline IDEXX Data Desc Stats}

#Removing NA result
idexx <- idexx%>%
  filter(is.na(ec_mpn) == FALSE)

#Renaming assignment names
idexx$assignment <- factor(idexx$assignment)
idexx$assignment <- fct_recode(idexx$assignment,
                                  "Control" = "C", 
                                  "Treatment" = "T")

idexx <- idexx%>%
  filter(is.na(assignment) == FALSE) #Removing results from Hathikamba

# Calculate descriptive statistics by village
village_stats <- idexx%>%
  group_by(village, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

tc_stats <- idexx%>%
  group_by(assignment, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "Lower CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "Upper CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    # "Lower CI - TC" = { #Robust standard errors accounting for clustering at villages
    #   model <- glm(cf_pa_binary ~ 1, family = binomial)
    #   vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
    #   se <- sqrt(vcov_cluster[1, 1])
    #   est <- (sum(cf_pa == "Presence") / n()) * 100
    #   est - qt(0.975, df.residual(model)) * se
    # },
    # "Upper CI - TC" = { #Robust standard errors accounting for clustering at villages
    #   model <- glm(cf_pa_binary ~ 1, family = binomial)
    #   vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
    #   se <- sqrt(vcov_cluster[1, 1])
    #   est <- (sum(cf_pa == "Presence") / n()) * 100
    #   est + qt(0.975, df.residual(model)) * se
    # },
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Lower CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Upper CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    # #"Lower CI - EC" = {
    #  # model <- glm(ec_pa_binary ~ 1, family = binomial)
    #   vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
    #   se <- sqrt(vcov_cluster[1, 1])
    #   est <- (sum(ec_pa == "Presence") / n()) * 100
    #   est - qt(0.975, df.residual(model)) * se
    # },
    # "Upper CI - EC" = {
    #   model <- glm(ec_pa_binary ~ 1, family = binomial)
    #   vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
    #   se <- sqrt(vcov_cluster[1, 1])
    #   est <- (sum(ec_pa == "Presence") / n()) * 100
    #   est + qt(0.975, df.residual(model)) * se
    # },
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

#Removing NAs from Assignment
tc_stats <- tc_stats%>%
  filter(is.na(assignment) == FALSE)


all_stats <- idexx%>%
  group_by(sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )



#Creating risk level stats for WHO Risk plot
risk_stats <- idexx%>%
  group_by(assignment, ec_risk)%>%
  summarize(count = n())%>%
  mutate("E. coli Risk Levels %" = round(count/sum(count) * 100, 2))


# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 7)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 11)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(all_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


#Plotting chlorine concentrations against e. coli presence/absence
# p1 <- ggplot(data = idexx) + 
#   geom_boxplot(aes(x = ec_pa, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Presence/Absence of E. coli", 
#        y = "Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps and Detection of E. coli")+
#   theme_bw()
# 
# p1


#need to correct
# #p2 <- ggplot(data = idexx) + 
#   geom_col(aes(x = village, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Sample ID", 
#        y = "Average Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps in each village in Odisha")+
#   theme_bw()
# 
# p2


#Plotting IDEXX E. coli data per village
p3 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p3



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = sample_type, y = ec_log)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p4


#Plotting IDEXX E. coli data per village
p5 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = block, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Block", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Sample Type",
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p5


#Plotting treatment/control stats on a bar plot
p_ec_bl <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "BL - Oct 2023"
       #title = expression(paste(italic("E. coli"), " BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_bl <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment",
       title = "BL - Oct 2023"
       #title = expression(paste(" BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_bl + p_ec_bl




#Making WHO risk plot
p_ec_risk_bl <- ggplot(data = risk_stats) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "BL - Oct 2023"
       #title = expression(paste(" BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))



```



```{r Baseline ABR IDEXX Desc Stats}

# Calculate descriptive statistics by village
village_stats <- abr%>%
  group_by(village, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

abr_stats <- abr%>%
  group_by(sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )





# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(abr_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Water Quality Test Results " = 5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")



# p4 <- ggplot(data = abr) + 
#   geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
#   scale_y_continuous(
#                      limits = c(0, 4),
#                      expand = c(0,0))+
#   labs(x = "Village", 
#        y = "log(MPN E. coli/100 mL)",
#        title = "E. coli Presence in Tap and Stored Drinking Water in Odisha (N = 56)")+
#   theme_bw()
# 
# p4


# p5 <- ggplot(data = abr) + 
#   geom_bar(aes(y = ec_pa, fill = village))+
#   labs(x = "Village", 
#        y = "log(MPN E. coli/100 mL)",
#        title = "E. coli Presence in Tap and Stored Drinking Water in Odisha (N = 56)")+
#   theme_bw()
# p5


```


\newpage
# R1 IDEXX Results

```{r R1 IDEXX Data Desc Stats}

#Removing NA result
idexx_r1 <- idexx_r1%>%
  filter(is.na(ec_mpn) == FALSE)

# Calculate descriptive statistics by village
village_stats <- idexx_r1%>%
  group_by(village, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

tc_stats <- idexx_r1%>%
  group_by(assignment, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "Lower CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "Upper CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Lower CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Upper CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )
#adjusting CI to be within 0-100
tc_stats <- tc_stats%>%
  mutate(`Lower CI - EC` = case_when(`Lower CI - EC` < 0 ~ 0,
                            `Lower CI - EC` >= 0 ~ `Lower CI - EC`))%>%
  mutate(`Upper CI - TC` = case_when(`Upper CI - TC` > 100 ~ 100,
                            `Upper CI - TC` <= 100 ~ `Upper CI - TC`))


all_stats <- idexx_r1%>%
  group_by(sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

#Creating risk level stats for WHO Risk plot
risk_stats <- idexx_r1%>%
  group_by(assignment, ec_risk)%>%
  summarize(count = n())%>%
  mutate("E. coli Risk Levels %" = round(count/sum(count) * 100, 2))

# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 11)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


kbl(all_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")




#Plotting chlorine concentrations against e. coli presence/absence
# p1 <- ggplot(data = idexx_r1) + 
#   geom_boxplot(aes(x = ec_pa, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Presence/Absence of E. coli", 
#        y = "Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps and Detection of E. coli")+
#   theme_bw()
# 
# p1


#need to correct
# #p2 <- ggplot(data = idexx_r1) + 
#   geom_col(aes(x = village, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Sample ID", 
#        y = "Average Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps in each village in Odisha")+
#   theme_bw()
# 
# p2


#Plotting IDEXX E. coli data per village
p3 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p3



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = sample_type, y = ec_log, fill = assignment)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Assignment",
       title = expression(paste(italic("E. coli"), " Follow-up 1 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p4


#Plotting IDEXX E. coli data per village
p5 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = block, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Block", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Sample Type",
       title = expression(paste(italic("E. coli"), " R1 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p5


#Plotting treatment/control stats on a bar plot
p_ec_r1 <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "R1 - February 2024"
       #title = expression(paste(italic("E. coli"), " R1 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r1 <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment",
       title = "R1 - February 2024"
       #title = expression(paste(" R1 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r1 + p_ec_r1

#Fisher's Exact Test for differences between control and treatment
idexx_r1_stored <- idexx_r1%>%
  filter(sample_type == "Stored")

idexx_r1_tap <- idexx_r1%>%
  filter(sample_type == "Tap")

stored_cf <- fisher.test(x = idexx_r1_stored$assignment, y=idexx_r1_stored$cf_pa)

stored_ec <- fisher.test(x = idexx_r1_stored$assignment, y=idexx_r1_stored$ec_pa)

tap_cf <- fisher.test(x = idexx_r1_tap$assignment, y=idexx_r1_tap$cf_pa)

tap_ec <- fisher.test(x = idexx_r1_tap$assignment, y=idexx_r1_tap$ec_pa)

idexx_r1_signif <- data.frame(stored_cf$p.value, stored_ec$p.value, tap_cf$p.value, tap_ec$p.value)



#Making WHO risk plot
p_ec_risk_r1 <- ggplot(data = risk_stats) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "R1 - February 2024"
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))


```

\newpage

# R2 IDEXX Results

```{r R2 IDEXX Results}


#Removing NA result
idexx_r2 <- idexx_r2%>%
  filter(is.na(ec_mpn) == FALSE)

#Changing assignment factor
idexx_r2$assignment <- factor(idexx_r2$assignment)
idexx_r2$assignment <- fct_recode(idexx_r2$assignment,
                                  "Control" = "C", 
                                  "Treatment" = "T")

# Calculate descriptive statistics by village
village_stats <- idexx_r2%>%
  group_by(village, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    #"Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

tc_stats <- idexx_r2%>%
  group_by(assignment, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "Lower CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "Upper CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Lower CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Upper CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    #"Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )%>%
  filter(sample_type != "Blank")

#adjusting CI to be within 0-100
tc_stats <- tc_stats%>%
  mutate(`Lower CI - EC` = case_when(`Lower CI - EC` < 0 ~ 0,
                            `Lower CI - EC` >= 0 ~ `Lower CI - EC`))%>%
  mutate(`Upper CI - TC` = case_when(`Upper CI - TC` > 100 ~ 100,
                            `Upper CI - TC` <= 100 ~ `Upper CI - TC`))


all_stats <- idexx_r2%>%
  group_by(sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    #"Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

#Creating risk level stats for WHO Risk plot
risk_stats <- idexx_r2%>%
  group_by(assignment, ec_risk)%>%
  summarize(count = n())%>%
  mutate("E. coli Risk Levels %" = round(count/sum(count) * 100, 2))


# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r2 - Water Quality Test Results " = 5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r2 - Water Quality Test Results " = 10)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


kbl(all_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r2 - Water Quality Test Results " = 4)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


idexx_r2 <- idexx_r2%>%
  filter(sample_type != "Blank")
table1(~ ec_pa + cf_pa | sample_type*assignment, data = idexx_r2)





#Plotting treatment/control stats on a bar plot
p_ec_r2 <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "R2 - March 2024"
       #title = expression(paste(italic("E. coli"), " R2 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r2 <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment",
       title = "R2 - March 2024"
       #title = expression(paste(" R2 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r2 + p_ec_r2




#Making WHO risk plot
p_ec_risk_r2 <- ggplot(data = risk_stats) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "R2 - March 2024"
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

```


\newpage

# R3 IDEXX Results

```{r R3 IDEXX Results}

#fixing village and assignment variable names - lazy way (but i promise i didn't have much time)
idexx_r3 <- idexx_r3%>%
  rename(village = village.y)%>%
  rename(assignment = assignment.x)

#Renaming assignment names
idexx_r3$assignment <- factor(idexx_r3$assignment)
idexx_r3$assignment <- fct_recode(idexx_r3$assignment,
                                  "Control" = "C", 
                                  "Treatment" = "T")

#Removing NA result
idexx_r3 <- idexx_r3%>%
  filter(is.na(ec_mpn) == FALSE)

## Removing Solar Tank Samples
idexx_r3 <- idexx_r3%>%
  filter(solar_water == 0)

## Selecting ABR data
idexx_r3_abr <- idexx_r3%>%
  filter(abr == 1)

# Removing ABR data
idexx_r3 <- idexx_r3%>%
  filter(abr == 0)

# Calculate descriptive statistics by village
village_stats <- idexx_r3%>%
  filter(sample_type == "Tap")%>%
  group_by(village, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

tc_stats <- idexx_r3%>%
  group_by(assignment, sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "Lower CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "Upper CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Lower CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Upper CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )
#adjusting CI to be within 0-100
tc_stats <- tc_stats%>%
  mutate(`Lower CI - EC` = case_when(`Lower CI - EC` < 0 ~ 0,
                            `Lower CI - EC` >= 0 ~ `Lower CI - EC`))%>%
  mutate(`Upper CI - TC` = case_when(`Upper CI - TC` > 100 ~ 100,
                            `Upper CI - TC` <= 100 ~ `Upper CI - TC`))


all_stats <- idexx_r3%>%
  group_by(sample_type) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

#Creating risk level stats for WHO Risk plot
risk_stats <- idexx_r3%>%
  group_by(assignment, ec_risk)%>%
  summarize(count = n())%>%
  mutate("E. coli Risk Levels %" = round(count/sum(count) * 100, 2))


# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R3 - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R3 - Water Quality Test Results " = 11)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


kbl(all_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R3 - Water Quality Test Results " = 5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


idexx_r3 <- idexx_r3%>%
  filter(sample_type != "Blank")
table1(~ ec_pa + cf_pa + fc_tap_avg | sample_type*assignment, data = idexx_r3)

#Noting samples per village
idexx_r3 <- idexx_r3%>%
  filter(sample_type != "Blank")
table1(~ village | sample_type, data = idexx_r3)


#removing lab blanks from tc_stats
tc_stats <- tc_stats%>%
  filter(sample_type != "Blank")

#Plotting treatment/control stats on a bar plot
p_ec_r3 <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "R3 - April 2024"
       #title = expression(paste(italic("E. coli"), " R3 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r3 <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment"
       ,
       title = "R3 - April 2024"
       #title = expression(paste(" R3 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r3 + p_ec_r3




#Making WHO risk plot
p_ec_risk_r3 <- ggplot(data = risk_stats) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "R3 - April 2024"
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))





#### ABR Results ####
table1(~ ec_pa + cf_pa | sample_type*assignment, data = idexx_r3_abr)





```



\newpage

# Overall IDEXX Results

```{r Overall IDEXX Results}

#Combining Presence/Absence plots from data collections rounds.
#Plots were coded above
p_ec_bl + p_ec_r1 + p_ec_r2 + p_ec_r3

p_cf_bl + p_cf_r1 + p_cf_r2 + p_cf_r3


#combining WHO risk plots from all data collection rounds

p_ec_risk_bl + p_ec_risk_r1 + p_ec_risk_r2 + p_ec_risk_r3



#Combining all 4 IDEXX datasets into 1
idexx_total_bl <- idexx%>%
  dplyr::select(assignment, village_name, sample_type, ec_mpn, ec_mpn_2, ec_pa, ec_pa_binary, ec_95lo, ec_95hi, ec_log, cf_mpn, cf_pa, cf_pa_binary, cf_95lo, cf_95hi, cf_log, fc_tap_avg)%>%
  mutate(data_round = "BL")

idexx_total_r1 <- idexx_r1%>%
  dplyr::select(assignment, village_name, sample_type, ec_mpn, ec_mpn_2, ec_pa, ec_pa_binary, ec_95lo, ec_95hi, ec_log, cf_mpn, cf_pa, cf_pa_binary, cf_95lo, cf_95hi, cf_log, fc_tap_avg)%>%
  mutate(data_round = "R1")

idexx_total_r2 <- idexx_r2%>%
  dplyr::select(assignment, village_name, sample_type, ec_mpn, ec_mpn_2, ec_pa, ec_pa_binary, ec_95lo, ec_95hi, ec_log, cf_mpn, cf_pa, cf_pa_binary, cf_95lo, cf_95hi, cf_log)%>%
  mutate(data_round = "R2")%>%
  mutate(fc_tap_avg = NA)

idexx_total_r3 <- idexx_r3%>%
  dplyr::select(assignment, village_name.x, sample_type, ec_mpn, ec_mpn_2, ec_pa, ec_pa_binary, ec_95lo, ec_95hi, ec_log, cf_mpn, cf_pa, cf_pa_binary, cf_95lo, cf_95hi, cf_log, fc_tap_avg)%>%
  mutate(data_round = "R3")%>%
  mutate(village_name = village_name.x)%>%
  dplyr::select(!(village_name.x))

#Combining
idexx_total <- rbind(idexx_total_bl, idexx_total_r1, idexx_total_r2, idexx_total_r3)




#Displaying boxplot results
p_total_boxplot <- ggplot(data = idexx_total) + 
  geom_boxplot(aes(x = data_round, y = ec_log, fill = assignment)) +
  facet_wrap(~sample_type)+
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Data Collection Round", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Presence in Tap and Stored Drinking Water in Odisha (N = 160 per round)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_total_boxplot



#Displaying boxplot results -- Log Scale
idexx_total <- idexx_total%>%
  filter(is.na(ec_mpn) == FALSE)%>%
  filter(is.na(data_round) == FALSE)%>%
  filter(is.na(assignment) == FALSE)

p_total_boxplot <- ggplot(data = idexx_total) + 
  geom_boxplot(aes(x = data_round, y = ec_mpn, fill = assignment)) +
  facet_wrap(~sample_type)+
  scale_y_continuous(trans = "log10")+
  labs(x = "Data Collection Round", 
       y = expression(paste("MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Presence in Tap and Stored Drinking Water in Odisha (N = 160 per round)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_total_boxplot



#Displaying total IDEXX results in a table
tap_total_stats <- idexx_total%>%
  filter(sample_type == "Tap")%>%
  group_by(assignment, data_round) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "Lower CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "Upper CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Lower CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Upper CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Median MPN E. coli/100 mL" = median(ec_mpn)#,
    #"Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

stored_total_stats <- idexx_total%>%
  filter(sample_type == "Stored")%>%
  group_by(assignment, data_round) %>%
  summarize(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "Lower CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "Upper CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Lower CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Upper CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Median MPN E. coli/100 mL" = median(ec_mpn)#,
    #"Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

#Creating table using gt summary
idexx_total$ec_pa_binary <- as.numeric(idexx_total$ec_pa_binary)
idexx_total$cf_pa_binary <- as.numeric(idexx_total$cf_pa_binary)

tab <- idexx_total%>%
  filter(sample_type == "Tap")%>%
  dplyr::select(assignment, data_round, cf_pa_binary, ec_pa_binary)%>%
  tbl_strata(
    strata = data_round,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = assignment, 
                    missing = "no", 
                    type = c(cf_pa_binary, ec_pa_binary) ~ "continuous",
                    statistic = list(
                      all_continuous() ~ "{mean} ({sd})",
                      all_categorical() ~ "{p}%"),
                    digits = list(all_continuous() ~ 2, 
                                  all_categorical() ~ 0),
                    label = list(ec_pa_binary ~ "Positive for E. coli",
                                 cf_pa_binary ~ "Positive for Total Coliform")
                    )%>%
     modify_footnote(all_stat_cols() ~ "Mean (SD)"),
    .header = "**{strata}**"
  )
tab



#tab <- table1(data = tap_total_stats, ~ `% Positive for Total Coliform` + `% Positive for E. coli` | data_round*assignment)


```




\newpage

# Overall Chlorine Monitoring Results
During survey rounds


```{r Overall chlorine monitoring results}

bl_cl <- bl%>%
  dplyr::select(village_name, assignment, fc_tap_avg, fc_stored_avg, tc_tap_avg,
                tc_stored_avg)%>%
  mutate(data_round = "BL")%>%
  filter(is.na(assignment) == FALSE)

r1_cl <- r1%>%
  dplyr::select(village_name, assignment, fc_tap_avg, fc_stored_avg, tc_tap_avg,
                tc_stored_avg)%>%
  mutate(data_round = "R1")

r2_cl <- r2%>%
  dplyr::select(village_name, assignment, fc_tap_avg, fc_stored_avg, tc_tap_avg, 
                tc_stored_avg)%>%
  mutate(data_round = "R2")

r3_cl <- r3%>%
  dplyr::select(village_name, assignment, fc_tap_avg, fc_stored_avg, tc_tap_avg,
                tc_stored_avg)%>%
  mutate(data_round = "R3")

#Combining data collection rounds
total_cl <- rbind(bl_cl, r1_cl, r2_cl, r3_cl)

#Renaming variables
total_cl <- total_cl%>%
  rename("Tap - Free Chlorine" = fc_tap_avg)%>%
  rename("Tap - Total Chlorine" = tc_tap_avg)%>%
  rename( "Stored - Free Chlorine" = fc_stored_avg)%>%
  rename("Stored - Total Chlorine" = tc_stored_avg)


#Summarizing in a table1 table
#Creating render
mean_render <- parse.abbrev.render.code(c("Mean (SD)"), 2)

tab <- table1(data = total_cl, ~ `Tap - Free Chlorine` + `Tap - Total Chlorine` + `Stored - Free Chlorine` + `Stored - Total Chlorine` | data_round*assignment, render = mean_render)
tab

#Summarizing in gt summary

# total_cl%>%
#   dplyr::select(assignment,`Tap - Free Chlorine` ,`Tap - Total Chlorine`, `Stored - Free Chlorine`, `Stored - Total Chlorine`)%>%
#   tbl_summary(
#     by = assignment,
#     statistic = list(
#       all_continuous() ~ "{mean} ({sd})",
#       all_categorical() ~ "{n} / {N} ({p}%)"
#     ),
#     digits = all_continuous() ~ 2
#   )


tab <- total_cl%>%
  dplyr::select(assignment, data_round, `Tap - Free Chlorine` ,`Tap - Total Chlorine`, `Stored - Free Chlorine`, `Stored - Total Chlorine`)%>%
  tbl_strata(
    strata = data_round,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = assignment, missing = "no", statistic = list(
      all_continuous() ~ "{mean} ({sd})")),
    .header = "**{strata}**, N = {n}"
  )
tab

kbl(tab)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Chlorine Monitoring " = 9)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")







```






\newpage

# Overall WASH Results

```{r Overall WASH results}

#Selecting bl and el variables
el_tab <- el%>%
  dplyr::select(assignment, prim_source, jjm_drinking, tap_issues, tap_issues_type_1,
                  quant, water_sec_yn, water_sec_freq)
cen_tab <- cen%>%
  dplyr::select(assignment, prim_source, jjm_yes,
                   water_sec_yn, water_sec_freq)

#Full list: jjm_drinking, jjm_yes,jjm_stored, jjm_use__77,  
                # jjm_use_999, tap_issues, tap_issues_type__77, tap_issues_type_1, 
                #  water_source_prim,  water_source_kids,  water_prim_source_kids,
                # water_source_preg,   water_prim_source_preg,  quant,
                # sec_source_reason_999, sec_source_reason__77, water_sec_yn, water_sec_freq,
                # water_treat,  water_treat_kids,  water_treat_type__77,  water_treat_type_999,
                # water_treat_freq__77,  water_stored


#summarizing in a table
tab <- el_tab%>%
  #tbl_strata(
   # strata = data_round,
    #.tbl_fun =
     # ~ .x %>%
        tbl_summary(by = assignment, 
                    missing = "no", 
                    #type = c(cf_pa_binary, ec_pa_binary) ~ "continuous",
                    statistic = list(
                      all_continuous() ~ "{mean} ({sd})",
                      all_categorical() ~ "{p}% ({n})"),
                    digits = list(all_continuous() ~ 2, 
                                  all_categorical() ~ 0),
                    label = list(prim_source ~ "Primary Drinking Water Source",
                                 jjm_drinking ~ "Use Government-provided Tap for Drinking",
                                 tap_issues ~ "Issues with Government-provided Tap (2 weeks)",
                                 tap_issues_type_1 ~ "Reported Taste/Odor/Cooking Issue",
                                 quant ~ "Primary Drinking Water Source Quantity",
                                 water_sec_yn ~ "Secondary Drinking Water Source",
                                 water_sec_freq ~ "Secondary Source Frequency")
                    )%>%
     modify_footnote(all_stat_cols() ~ "% (N)")%>%
  as_gt()%>%
  tab_options(table.font.size = pct(50))#,
    #.header = "**{strata}**"
  #)
tab





```






\newpage

# Longitudinal Chlorine Monitoring
\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

```{r JPAL Chlorine monitoring data cleaning}

#Assigning more meaningful variable names
mon <- mon%>%
  rename(village_ID = "village_name")

mon_full <- mon_full%>%
  rename(village_ID = "village_name")

#Pairing village information
mon$village_ID <- as.character(mon$village_ID)
mon <- left_join(mon, village_details, by = "village_ID")

mon_full$village_ID <- as.character(mon_full$village_ID)
mon_full <- left_join(mon_full, village_details, by = "village_ID")

#Averaging chlorine data
mon <- mon%>%
  mutate(nearest_tap_fc = (first_nearest_tap_fc + second_nearest_tap_fc)/2)%>%
  mutate(nearest_tap_tc = (first_nearest_tap_tc + second_nearest_tap_tc)/2)%>%
  mutate(farthest_tap_fc = (first_farthest_tap_fc + second_farthest_tap_fc)/2)%>%
  mutate(farthest_tap_tc = (first_farthest_tap_tc + second_farthest_tap_tc)/2)%>%
  mutate(nearest_stored_fc = (first_stored_water_fc + second_stored_water_fc)/2)%>%
  mutate(nearest_stored_tc = (first_stored_water_tc + second_stored_water_tc)/2)%>%
  mutate(farthest_stored_fc = (far_first_stored_water_fc + far_second_stored_water_fc)/2)%>%
  mutate(farthest_stored_tc = (far_first_stored_water_tc + far_second_stored_water_tc)/2)

mon_full <- mon_full%>%
  mutate(nearest_tap_fc = (first_nearest_tap_fc + second_nearest_tap_fc)/2)%>%
  mutate(nearest_tap_tc = (first_nearest_tap_tc + second_nearest_tap_tc)/2)%>%
  mutate(farthest_tap_fc = (first_farthest_tap_fc + second_farthest_tap_fc)/2)%>%
  mutate(farthest_tap_tc = (first_farthest_tap_tc + second_farthest_tap_tc)/2)%>%
  mutate(nearest_stored_fc = (first_stored_water_fc + second_stored_water_fc)/2)%>%
  mutate(nearest_stored_tc = (first_stored_water_tc + second_stored_water_tc)/2)%>%
  mutate(farthest_stored_fc = (far_first_stored_water_fc + far_second_stored_water_fc)/2)%>%
  mutate(farthest_stored_tc = (far_first_stored_water_tc + far_second_stored_water_tc)/2)


#Getting date of test
mon$valve_open_time <- mdy_hms(mon$valve_open_time)
mon <- mon%>%
  mutate(test_date = date(valve_open_time))

mon_full$valve_open_time <- mdy_hms(mon_full$valve_open_time)
mon_full <- mon_full%>%
  mutate(test_date = date(valve_open_time))

#Selecting for variables only in the shorter daily monitoring form
mon <- bind_rows(mon, mon_full)


### Cleaning and formatting datasets ### 
mon_villages <- unique(mon$village_name)


#Pivoting to make datasets only have a single column for chlorine concentration measurement
#saving wide format
mon_wide <- mon
mon <- mon%>%
  pivot_longer(cols = c(nearest_tap_fc, nearest_tap_tc, farthest_tap_fc, farthest_tap_tc, nearest_stored_fc, nearest_stored_tc, farthest_stored_fc, farthest_stored_tc), names_to = "chlorine_test", values_to = "chlorine_concentration")


#Subsetting for nearest and farthest tap connections
mon_near <- mon%>%
  filter(chlorine_test %in% c("nearest_tap_fc", "nearest_stored_fc", "nearest_tap_tc", "nearest_stored_tc"))

mon_far <- mon%>%
  filter(chlorine_test %in% c("farthest_tap_fc", "farthest_stored_fc", "farthest_tap_tc", "farthest_stored_tc"))






```




## JPAL Chlorine Monitoring Results



```{r JPAL Chlorine Monitoring Data Analysis, message=FALSE}


#Creating time series plot of the data for each village

for (i in mon_villages){
  x_near <- mon_near%>%
    filter(village_name == i)
  x_far <- mon_far%>%
    filter(village_name == i)
  
  p1 <- ggplot(data = x_near) + 
    geom_jitter(aes(x = test_date, y = chlorine_concentration, color = chlorine_test), width = 0.05, height = 0.001) +
    scale_y_continuous(
                     limits = c(0, 1),
                     expand = c(0,0))+
    labs(x = "Date", 
       y = "Chlorine Concentration (mg/L)",
       fill = "Sample Type",
       title = (paste("Chlorine Concentration for", i,"for 2023-2024")))+
    theme_bw() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))
  
  #print(p1) #Uncomment to run
  
  p2 <- ggplot(data = x_far) + 
    geom_jitter(aes(x = test_date, y = chlorine_concentration, color = chlorine_test), width = 0.05, height = 0.001) +
    scale_y_continuous(
                     limits = c(0, 1),
                     expand = c(0,0))+
    labs(x = "Date", 
       y = "Chlorine Concentration (mg/L)",
       fill = "Sample Type",
       title = (paste("Chlorine Concentration for", i,"for 2023-2024")))+
    theme_bw() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))
  
  #print(p2) #Uncomment to run

  
}

#Creating table of most 4 recent chlorine concentration measurements by JPAL team for each village
mon_wide <- mon_wide%>%
  dplyr::select(village_name, test_date, nearest_tap_fc, nearest_stored_fc, farthest_tap_fc, farthest_stored_fc)

#Removing NA value
mon_villages <- mon_villages[-11]

#initializing empty dataframe
y <- mon_wide[0,]

for (i in mon_villages){
  #Selecting each village in the loop
  x <- mon_wide%>%
    filter(village_name == i)
  #sorting and filtering for 4 most recent tests
  x <- x%>%
    arrange(desc(test_date))
  x <- x[1:4,]
  
  #binding rows to table dataframe
  y <- bind_rows(y,x)
  
}


# Printing kable with 4 most recent test results
  kbl(y)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("JPAL Chlorine Monitoring" = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")
  



```




```{r JPAL Chlorine Monitoring results - pt 2, message = FALSE, fig.height=8, fig.width=9}

  
#Representing them on facet_wrap()

#Selecting for chlorine data
mon_wide <- mon_wide%>%
  dplyr::select(test_date, village_name, nearest_tap_fc, farthest_tap_fc)%>%
  pivot_longer(names_to = "chlorine_test", values_to = "chlorine_concentration",
               cols = c(nearest_tap_fc, farthest_tap_fc))

#Making a plot for Karnapadu
#mon_karnapadu <- mon_wide%>%
 # filter(village_name == "Karnapadu")

# p1 <- ggplot(data = mon_karnapadu) + 
#     geom_point(aes(x = test_date, y = chlorine_concentration,
#                    color = chlorine_test))+
#     geom_line(aes(x = test_date, y = chlorine_concentration,
#                   color = chlorine_test))+
#     geom_hline(yintercept=0.20, linetype="dashed", color = "red")+
#     geom_hline(yintercept=0.60, linetype="dashed", color = "red")+
#     scale_y_continuous(
#                      limits = c(0, 2.0),
#                      expand = c(0,0))+
#     labs(x = "Date", 
#        y = "Chlorine Concentration (mg/L)",
#        fill = "Sample Type",
#        title = (paste("JPAL ILC Chlorine Monitoring in Karnapadu Village")))+
#     theme_bw() + 
#     theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))
#   
#   print(p1)


#Filtering for dates after April 5th for readability
mon_wide <- mon_wide%>%
  filter(test_date > "2024-04-05")%>%
  filter(village_name != "Karnapadu")%>% #and removing karnapadu
  filter(is.na(chlorine_concentration) == FALSE)

#Recoding chlorine concentration sample types
mon_wide$chlorine_test <- factor(mon_wide$chlorine_test)
mon_wide$chlorine_test <- fct_recode(mon_wide$chlorine_test,
                                  "Nearest Tap - Free Chlorine" = "nearest_tap_fc",
                                  "Farthest Tap - Free Chlorine" = "farthest_tap_fc")



  p1 <- ggplot(data = mon_wide) + 
    geom_point(aes(x = test_date, y = chlorine_concentration,
                   color = chlorine_test))+
    geom_line(aes(x = test_date, y = chlorine_concentration,
                  color = chlorine_test))+
    geom_hline(yintercept=0.20, linetype="dashed", color = "red")+
    geom_hline(yintercept=0.60, linetype="dashed", color = "red")+
    scale_y_continuous(
                     limits = c(0, 2.0),
                     expand = c(0,0))+
    labs(x = "Date", 
       y = "Chlorine Concentration (mg/L)",
       color = "Sample Type",
       title = (paste("JPAL ILC Chlorine Monitoring for 2024")))+
    theme_bw() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))+
    facet_wrap(~village_name, ncol = 3)+
    geom_vline(data = gv_refill, aes(xintercept = refill_date_0),
               linetype = "dashed", color = "darkgreen")+
      #annotate("text", x = as.Date("2024-04-08"), y = 0.1, label = "Refill",
       #        angle = 0, vjust = -0.5, size = 3, color = "darkgreen")
    #annotate("label", x = as.Date("2024-04-10"), y = 1.5, label = "         ", angle = 0, 
     #      vjust = -0.5, color = "black", size = 12, fill = "white", label.size = NA)+
    geom_text(data = filter(mon_wide, village_name == "Asada"), 
            aes(x = as.Date("2024-04-12"), y = 1.5), 
            label = "Refill", angle = 0, vjust = -0.5, color = "darkgreen", size = 3)+
    geom_text(data = filter(mon_wide, village_name == "Asada"), 
            aes(x = as.Date("2024-04-16"), y = 1.7), 
            label = "Target Range", angle = 0, vjust = -0.5, color = "red", size = 3)
  
  print(p1)



```




```{r JPAL HH survey chlorine monitoring data analysis}

#Creating table to represent data for each village across survey rounds
#Preparing data to bind into one dataframe
bl_cl <- bl%>%
  dplyr::select(village_name, assignment, fc_stored_avg, fc_tap_avg, tc_stored_avg, tc_tap_avg)%>%
  mutate(round = "bl")%>%
  filter(village_name != "Hatikhamba") #removing hatikhamba

bl_cl$assignment <- bl_cl$assignment%>%
  factor()%>%
  fct_recode("Control" = "C",
             "Treatment" = "T")
  

r1_cl <- r1%>%
  dplyr::select(village_name, assignment, fc_stored_avg, fc_tap_avg, tc_stored_avg, tc_tap_avg)%>%
  mutate(round = "r1")

r2_cl <- r2%>%
  dplyr::select(village_name, assignment, fc_stored_avg, fc_tap_avg, tc_stored_avg, tc_tap_avg)%>%
  mutate(round = "r2")

r3_cl <- r3%>%
  dplyr::select(village_name, assignment, fc_stored_avg, fc_tap_avg, tc_stored_avg, tc_tap_avg)%>%
  mutate(round = "r3")


hh_survey_cl <- bind_rows(bl_cl, r1_cl, r2_cl, r3_cl)



#Displaying results in a table
# Calculate descriptive statistics by village
village_stats <- hh_survey_cl%>%
  group_by(village_name, assignment, round) %>%
  summarize(
    "% taps positive for free chlorine (> 0.07 mg/L)" = round((sum(fc_tap_avg > 0.07) / n()) * 100, 1),
    "% taps above 0.2 mg/L" = round((sum(fc_tap_avg > 0.20) / n()) * 100, 1),
    "Tap Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap_avg), 3),
    "Stored Average Free Chlorine Concentration (mg/L)" = round(mean(fc_stored_avg), 3)
  )%>%
  filter(assignment == "Treatment")

all_stats <- hh_survey_cl %>%
  group_by(assignment, round) %>%
  summarize(
    "% taps positive for free chlorine (> 0.07 mg/L)" = round((sum(fc_tap_avg > 0.07) / n()) * 100, 1),
    "% taps above 0.2 mg/L" = round((sum(fc_tap_avg > 0.20) / n()) * 100, 1),
    "Tap Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap_avg), 3),
    "Stored Average Free Chlorine Concentration (mg/L)" = round(mean(fc_stored_avg), 3))

# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Household Survey Chlorine Results " = 7)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

# Print the table
kbl(all_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Household Survey Chlorine Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")



```





## Gram Vikas Chlorine Monitoring Results

```{r Gram Vikas chlorine monitoring data cleaning}

#OLD CODE for google sheet
#Assigning more meaningful variable names
#gv <- gv%>%
 # rename_all(~stringr::str_replace(.,"Sample ","sample_"))%>%
  #rename_all(~stringr::str_replace(.," - Free Chlorine (mg/L)","_fc"))%>%
  #rename_all(~stringr::str_replace(.," - Total Chlorine (mg/L)","_tc"))%>%
  #rename_all(~stringr::str_replace(.," - Location","_location"))
  #rename(village = "r_cen_village_name_str")%>%



### mWater Results ###

gv <- gv%>%
  filter(is.na(Village) == FALSE)%>%
  mutate(test_date = as_date(`valve_open (Time Answered)`))%>%
  filter(is.na(test_date) == FALSE)

mon_villages <- unique(gv$Village)

mon_near <- gv%>%
  dplyr::select(test_date, Village, nearest_tap_fc, nearest_tap_tc, nearest_stored_fc, nearest_stored_tc)%>%
  pivot_longer(names_to = "chlorine_test", values_to = "chlorine_concentration",
               cols = c(nearest_tap_fc, nearest_tap_tc, nearest_stored_fc, nearest_stored_tc))

mon_far <- gv%>%
  dplyr::select(test_date, Village, farthest_tap_fc, farthest_tap_tc, farthest_stored_fc, farthest_stored_tc)%>%
  pivot_longer(names_to = "chlorine_test", values_to = "chlorine_concentration",
               cols = c(farthest_tap_fc, farthest_tap_tc, farthest_stored_fc, farthest_stored_tc))
  


```


```{r Gram Vikas Chlorine Monitoring Results}



#Old Google Sheet results
#Selecting for Karnapadu results

# karn <- gv%>%
#   filter(Village == "Karnapadu")%>%
#   pivot_longer(cols = c("sample_1 - Free Chlorine (mg/L)",
#                         "sample_2 - Free Chlorine (mg/L)",
#                         "sample_3 - Free Chlorine (mg/L)",
#                         "sample_4 - Free Chlorine (mg/L)",
#                         "sample_5 - Free Chlorine (mg/L)",
#                         "sample_6 - Free Chlorine (mg/L)",
#                         "sample_7 - Free Chlorine (mg/L)",
#                         "sample_8 - Free Chlorine (mg/L)",
#                         "sample_9 - Free Chlorine (mg/L)",
#                         "sample_10 - Free Chlorine (mg/L)",
#                         "sample_11 - Free Chlorine (mg/L)",
#                         "sample_12 - Free Chlorine (mg/L)"), names_to = "sample_fc", values_to = "free_chlorine")
#pivot_longer(cols = c("sample_1_location", "sample_2_location", "sample_3_location",
 #                       "sample_4_location", "sample_5_location", "sample_6_location",
  #                      "sample_7_location", "sample_8_location", "sample_9_location", 
   #                     "sample_10_location", "sample_11_location", "sample_12_location"),
    #         names_to = "sample_location_number",
     #          values_to = "sample_location")


# karn_results <- karn%>%
#   group_by(sample_location) %>%
#   summarize(
#     "Number of Samples" = n(),
#     "Average Free Chlorine Concentration" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
#     "Median MPN E. coli/100 mL" = median(ec_mpn),
#     "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
#   )


  
# for (i in mon_villages){
#   x_near <- mon_near%>%
#     filter(Village == i)
#   x_far <- mon_far%>%
#     filter(Village == i)
#   
#   
#   p1 <- ggplot(data = x_near) + 
#     geom_point(aes(x = test_date, y = chlorine_concentration,
#                    color = chlorine_test))+
#     geom_line(aes(x = test_date, y = chlorine_concentration,
#                   color = chlorine_test))+
#     geom_hline(yintercept=0.14, linetype="dashed", color = "red")+
#     scale_y_continuous(
#                      limits = c(0, 1),
#                      expand = c(0,0))+
#     labs(x = "Date", 
#        y = "Chlorine Concentration (mg/L)",
#        fill = "Sample Type",
#        title = (paste("Chlorine Concentration for", i,"for 2023-2024")))+
#     theme_bw() + 
#     theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))
#   
#   print(p1)
#   
#   p2 <- ggplot(data = x_far) + 
#     geom_point(aes(x = test_date, y = chlorine_concentration,
#                    color = chlorine_test))+
#     geom_line(aes(x = test_date, y = chlorine_concentration,
#                   color = chlorine_test))+
#     geom_hline(yintercept=0.14, linetype="dashed", color = "red")+
#     scale_y_continuous(
#                      limits = c(0, 1),
#                      expand = c(0,0))+
#     labs(x = "Date", 
#        y = "Chlorine Concentration (mg/L)",
#        fill = "Sample Type",
#        title = (paste("Chlorine Concentration for", i,"for 2023-2024")))+
#     theme_bw() + 
#     theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))
#   
#   print(p2)
# 
#   
# }




```





