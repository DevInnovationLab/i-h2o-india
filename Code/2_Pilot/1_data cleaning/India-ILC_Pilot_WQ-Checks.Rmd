---
title: "India ILC -- WQ Data Checks"
author: "Jeremy Lowe"
date: "2023-10-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE)

```

```{r package loading, include=FALSE}

library(rsurveycto)
library(httr)
library(tidyverse)
library(lubridate)
library(quantitray)
library(sjmisc)
library(knitr)
library(kableExtra)
library(readxl)
library(experiment)
library(stargazer)
library(readxl)
library(haven)



```


```{r dataset loading}

#from Box

#Jeremy's file path
bl_raw <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/Baseline follow up survey_WIDE.csv")

bl <- read_stata("C:/Users/jerem/Box/India Water project/2_Pilot/Data/2_deidentified/1_2_Followup_cleaned.dta")

idexx <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/_India ILC_IDEXX_data_MASTER.xlsx")


```

```{r quick data cleaning}

#Filtering out test data from training, based on village IDs
unique(bl$R_FU_unique_id_1)
bl <- bl%>%
  filter(!(R_FU_unique_id_1 == 88888 |
           R_FU_unique_id_1 == 99999))#Clean data doesn't require this step


#Selecting bl data key variables for WQ testing
bl <- bl%>%
  dplyr::select(R_FU_unique_id_1, R_FU_unique_id_2, R_FU_unique_id_3, unique_id_num, R_FU_r_cen_village_name_str, R_FU_consent, R_FU_water_source_prim, R_FU_primary_water_label, R_FU_water_qual_test, R_FU_wq_stored_bag, R_FU_stored_bag_source, R_FU_sample_ID_stored, R_FU_bag_ID_stored, R_FU_fc_stored, R_FU_tc_stored, R_FU_sample_ID_tap, R_FU_bag_ID_tap, R_FU_fc_tap, R_FU_tc_tap, R_FU_instancename)

#Assigning more meaningful variable names
bl <- bl%>%
  rename_all(~stringr::str_replace(.,"R_FU_",""))
  #Other way:
  #rename(fc_stored = R_FU_fc_stored)%>%
  #rename(tc_stored = R_FU_tc_stored)%>%
  #rename(fc_tap = R_FU_fc_tap)%>%
  #rename(tc_tap = R_FU_tc_tap)%>%
  #rename(sample_ID_stored = R_FU_sample_ID_stored)

#Pivoting dataset to be longer for pairing IDEXX data to sample IDs
bl_idexx
  


```


```{r Data check -- Chlorine test data}

###Displaying chlorine test data for each village
#Arranging data so chlorine test data is in one column
chlorine <- bl%>%
  pivot_longer(cols = c(fc_tap, fc_stored, tc_tap, tc_stored), values_to = "chlorine_concentration", names_to = "chlorine_test_type")

#Removing NAs from no respondent being available
chlorine <- chlorine%>%
  filter(is.na(chlorine_concentration) == FALSE)

p1 <- chlorine%>%
  ggplot() +
  geom_point(aes(x = chlorine_test_type, y = chlorine_concentration)) +
  facet_wrap(~ R_Cen_village_name_str) + 
  labs(x = "Chlorine Test", y = "Chlorine Concentration (mg/L)") +
  theme_bw()

p1


#Selecting for data that are > 0.10 mg/L
chlorine_check <- chlorine%>%
  filter(chlorine_concentration > 0.10)%>%
  dplyr::select(unique_id, unique_id_2, R_Cen_village_name_str, chlorine_test_type, chlorine_concentration)


#Creating table
chlorine_check%>%
  kbl(
    #col.names = linebreak(column_names, align = "l"),
    #escape = FALSE
    )%>%
  kable_styling(position = "center",
                bootstrap_options = "striped",
                latex_options = c("scale_down"))%>%
  add_header_above(c("Free and Total Chlorine Concentrations - Positive Samples (mg/L) " =5)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE)%>%
  column_spec(2, width = "75px")

#Creating table
#stargazer(chlorine_check)
  



```
