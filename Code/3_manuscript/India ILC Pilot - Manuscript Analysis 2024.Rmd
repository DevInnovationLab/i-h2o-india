---
title: "India ILC - Pilot Manuscript 2024"
author: "Jeremy Lowe"
date: "`r Sys.Date()`"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, warning = FALSE)

```

# Introduction

This document details to be included in the India ILC Pilot manuscript. 

```{r package loading, include=FALSE}

library(rsurveycto)
library(expss)
library(labelled)
library(httr)
library(lubridate)
library(quantitray)
library(sjmisc)
library(knitr)
library(kableExtra)
library(readxl)
library(experiment)
library(stargazer)
library(readxl)
library(haven)
library(googlesheets4)
library(ggsignif)
library(patchwork)
library(table1)
library(gtsummary)
library(gt)
library(webshot2)
library(clubSandwich)
library(tidyverse)



```



```{r profile}
#------------------------ setting user path ----------------------------------------#


user_path <- function() {
  # Return a hardcoded path that depends on the current user, or the current 
  # working directory for an unrecognized user. If the path isn't readable,
  # stop.
  #
  
  user <- Sys.info()["user"]
  
  if (user == "asthavohra") { 
    path = "/Users/asthavohra/Library/CloudStorage/Box-Box/India Water project/2_Pilot/Data/"
  } 
  else if (user=="akitokamei"){
    path = "/Users/akitokamei/Box Sync/India Water project/2_Pilot/Data/"
  } 
  else if (user == "jerem"){
    path = "C:/Users/jerem/Box/India Water project/2_Pilot/Data/"
  } 
  else {
    warning("No path found for current user (", user, ")")
    path = getwd()
  }
  
  stopifnot(file.exists(path))
  return(path)
}

# set working directory
knitr::opts_knit$set(root.dir = user_path())

# setting github directory
github_path <- function() {
  user <- Sys.info()["user"]
  if (user == "asthavohra") {
    github = "/Users/asthavohra/Documents/GitHub/i-h2o-india/Code/2_Pilot/0_pilot logistics/"
  } 
  else if (user=="akitokamei"){
    github = "/Users/akitokamei/Library/CloudStorage/Dropbox/Mac/Documents/GitHub/i-h2o-india/Code/2_Pilot/0_pilot logistics/"
  } 
  else if (user == "jerem") {
    github = "C:/Users/jerem/Documents/i-h2o-india/Code"
  } 
  else {
    warning("No path found for current user (", user, ")")
    github = getwd()
  }
  
  stopifnot(file.exists(github))
  return(github)
}

github <- github_path()

#Setting overleaf
overleaf_path <- function() {
  # Return a hardcoded path to Overleaf that depends on the current user, or the current 
  # working directory for an unrecognized user. If the path isn't readable,
  # stop.
  #
  
  user <- Sys.info()["user"]
  
  if (user == "asthavohra") { 
    
  } 
  else if (user=="akitokamei"){
    
		overleaf = "/Users/akitokamei/Dropbox/Apps/Overleaf"

  } 
  else if (user == "jerem"){
		overleaf = "C:/Users/jerem/DropBox/Apps/Overleaf"
  } 
  else {
    warning("No path found for current user (", user, ")")
    path = getwd()
  }
  
  stopifnot(file.exists(overleaf))
  return(overleaf)
}

overleaf <- overleaf_path()


```




```{r dataset loading}

#Loading different final datasets from Box
#See Process Doc for details on cleaning code and clean datasets:
#https://docs.google.com/document/d/1Hpv5HF5ICO5FSVdQnPtDECCYORn2qy5S7C_KIx0pDuM/edit


#from Box

#bl_raw <- read_csv(paste0(user_path(), "/1_raw/Baseline follow up survey_WIDE.csv"))

#Baseline Survey
bl <- read_stata(paste0(user_path(), "/2_deidentified/1_2_Followup_cleaned.dta"))

#Baseline Census
cen <- read_stata(paste0(user_path(),"/3_final/Final_HH_Odisha_consented_Full.dta"))

#Round 1 survey
r1 <- read_stata(paste0(user_path(),"/2_deidentified/1_5_followup_R1_cleaned.dta"))

#Round 2 survey
r2 <- read_stata(paste0(user_path(),"/2_deidentified/1_6_followup_R2_cleaned.dta"))

#Round 3 survey
r3 <- read_stata(paste0(user_path(),"/2_deidentified/1_7_followup_R3_cleaned.dta"))

#Chlorine Monitoring Survey
mon <- read_stata(paste0(user_path(),"/2_deidentified/1_X_chlorine_monitoring.dta"))

#Longitudinal chlorine monitoring form
mon_full <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/india_ilc_pilot_monitoring_WIDE.csv")

#gv <- read_sheet(ss = "https://docs.google.com/spreadsheets/d/1OvZT-yk52h58-dpnSfBkXyEFR_Kb-p7O6PmQ8io4n-s/edit#gid=0", )

#Baseline IDEXX
idexx <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/BL_idexx_master_cleaned.csv"))

#Baseline ABR IDEXX
abr <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/raw/_India ILC_ABR_data_MASTER.xlsx", skip = 1)

#IDEXX Round 1
idexx_r1 <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/R1_idexx_master_cleaned.csv"))


#IDEXX Round 2
idexx_r2 <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/R2_idexx_master_cleaned.csv"))

#IDEXX Round 3
idexx_r3 <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/R3_idexx_master_cleaned.csv"))

#Village Details
village_details <- read_xlsx(paste0(user_path(),"/5_lab data/India_ILC_Pilot_Rayagada_Village_Tracking.xlsx"))


#endline census
el <- read_stata(paste0(user_path(),"1_raw/1_8_Endline/1_8_Endline_Census_cleaned.dta" ))


```


```{r defining misc functions}

labelmaker <- function(x){
  #Works best with Stata data to convert variable names to their labels
  z <- colnames(x)
  for(i in z){
    labels <-  val_labels(x[i])
    if(is.na(labels) == FALSE){
      x[i] <- to_label(x[i])
      
    }
  }
  return(x)
}

```



\newpage
# Data Cleaning


```{r Data cleaning R code}

source(paste0(github_path(),"/3_manuscript/India ILC Pilot - Manuscript Data Cleaning 2024.R"))


```




\newpage
#Analysis


## Household Characteristics

```{r}




```




## Chlorine Monitoring -- Household Surveys

```{r Chlorine Monitoring -- Surveys}




```


## Chlorine Monitoring -- Weekly

```{r Chlorine Monitoring -- Weekly}



```



## Microbiological Contamination


```{r Defining functions to calculate stats}

village_stats <- function(idexx_data){
  idexx_data%>%
  dplyr::group_by(village, sample_type) %>%
  dplyr::summarise(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

  
}



tc_stats <- function(idexx_data){
  
  idexx_data%>%
  group_by(assignment, sample_type) %>%
  summarise(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "Lower CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    "Upper CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
    # "Lower CI - TC" = { #Robust standard errors accounting for clustering at villages
    #   model <- glm(cf_pa_binary ~ 1, family = binomial)
    #   vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
    #   se <- sqrt(vcov_cluster[1, 1])
    #   est <- (sum(cf_pa == "Presence") / n()) * 100
    #   est - qt(0.975, df.residual(model)) * se
    # },
    # "Upper CI - TC" = { #Robust standard errors accounting for clustering at villages
    #   model <- glm(cf_pa_binary ~ 1, family = binomial)
    #   vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
    #   se <- sqrt(vcov_cluster[1, 1])
    #   est <- (sum(cf_pa == "Presence") / n()) * 100
    #   est + qt(0.975, df.residual(model)) * se
    # },
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Lower CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 - 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    "Upper CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 + 
      (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
    # #"Lower CI - EC" = {
    #  # model <- glm(ec_pa_binary ~ 1, family = binomial)
    #   vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
    #   se <- sqrt(vcov_cluster[1, 1])
    #   est <- (sum(ec_pa == "Presence") / n()) * 100
    #   est - qt(0.975, df.residual(model)) * se
    # },
    # "Upper CI - EC" = {
    #   model <- glm(ec_pa_binary ~ 1, family = binomial)
    #   vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
    #   se <- sqrt(vcov_cluster[1, 1])
    #   est <- (sum(ec_pa == "Presence") / n()) * 100
    #   est + qt(0.975, df.residual(model)) * se
    # },
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )
  
}




all_stats <- function(idexx_data){
  idexx_data%>%
  group_by(sample_type) %>%
  summarise(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )
}


risk_stats <- function(idexx_data){
  idexx_data%>%
  group_by(assignment, ec_risk)%>%
  summarise(count = n())%>%
  mutate("E. coli Risk Levels %" = round(count/sum(count) * 100, 2))
}


```


###Baseline

```{r Microbiological Contamination - Baseline}

# Calculate descriptive statistics by village
village_stats_bl <- village_stats(idexx)

tc_stats_bl <- tc_stats(idexx)

all_stats <- all_stats(idexx)




#Creating risk level stats for WHO Risk plot
risk_stats_bl <- risk_stats(idexx)


# Print the table
kbl(village_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 7)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 11)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(all_stats)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")



#Plotting IDEXX E. coli data per village
p1 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p1



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = sample_type, y = ec_log)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p4




#Plotting treatment/control stats on a bar plot
p_ec_bl <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "BL - Oct 2023"
       #title = expression(paste(italic("E. coli"), " BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_bl <- ggplot(data = tc_stats) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment",
       title = "BL - Oct 2023"
       #title = expression(paste(" BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_bl + p_ec_bl




#Making WHO risk plot
p_ec_risk_bl <- ggplot(data = risk_stats) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "BL - Oct 2023"
       #title = expression(paste(" BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))



```

###Follow-up Surveys

```{r Microbiological Contamination -- Follow-up Surveys}






```



## WASH Access




## Chlorination Perceptions







