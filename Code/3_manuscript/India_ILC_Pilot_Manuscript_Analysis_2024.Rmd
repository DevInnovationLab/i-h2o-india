---
title: "India ILC - Pilot Manuscript 2024"
author: "Jeremy Lowe"
date: "`r Sys.Date()`"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, warning = FALSE)

```

# Introduction

This document details to be included in the India ILC Pilot manuscript. 

```{r package loading, include=FALSE}

library(rsurveycto)
library(expss)
library(labelled)
library(httr)
library(lubridate)
library(quantitray)
library(sjmisc)
library(knitr)
library(kableExtra)
library(readxl)
library(experiment)
library(stargazer)
library(readxl)
library(haven)
library(googlesheets4)
library(ggsignif)
library(patchwork)
library(table1)
library(gtsummary)
library(gt)
library(webshot2)
library(clubSandwich)
library(sandwich)
library(lmtest)
library(broom)
library(tidyverse)



```



```{r profile}
#------------------------ setting user path ----------------------------------------#


user_path <- function() {
  # Return a hardcoded path that depends on the current user, or the current 
  # working directory for an unrecognized user. If the path isn't readable,
  # stop.
  #
  
  user <- Sys.info()["user"]
  
  if (user == "asthavohra") { 
    path = "/Users/asthavohra/Library/CloudStorage/Box-Box/India Water project/2_Pilot/Data/"
  } 
  else if (user=="akitokamei"){
    path = "/Users/akitokamei/Box Sync/India Water project/2_Pilot/Data/"
  } 
  else if (user == "jerem"){
    path = "C:/Users/jerem/Box/India Water project/2_Pilot/Data/"
  } 
  else {
    warning("No path found for current user (", user, ")")
    path = getwd()
  }
  
  stopifnot(file.exists(path))
  return(path)
}

# set working directory
knitr::opts_knit$set(root.dir = user_path())

# setting github directory
github_path <- function() {
  user <- Sys.info()["user"]
  if (user == "asthavohra") {
    github = "/Users/asthavohra/Documents/GitHub/i-h2o-india/Code/2_Pilot/0_pilot logistics/"
  } 
  else if (user=="akitokamei"){
    github = "/Users/akitokamei/Library/CloudStorage/Dropbox/Mac/Documents/GitHub/i-h2o-india/Code/2_Pilot/0_pilot logistics/"
  } 
  else if (user == "jerem") {
    github = "C:/Users/jerem/Documents/i-h2o-india/Code"
  } 
  else {
    warning("No path found for current user (", user, ")")
    github = getwd()
  }
  
  stopifnot(file.exists(github))
  return(github)
}

github <- github_path()

#Setting overleaf
overleaf_path <- function() {
  # Return a hardcoded path to Overleaf that depends on the current user, or the current 
  # working directory for an unrecognized user. If the path isn't readable,
  # stop.
  #
  
  user <- Sys.info()["user"]
  
  if (user == "asthavohra") { 
    
  } 
  else if (user=="akitokamei"){
    
		overleaf = "/Users/akitokamei/Dropbox/Apps/Overleaf"

  } 
  else if (user == "jerem"){
		overleaf = "C:/Users/jerem/DropBox/Apps/Overleaf"
  } 
  else {
    warning("No path found for current user (", user, ")")
    path = getwd()
  }
  
  stopifnot(file.exists(overleaf))
  return(overleaf)
}

overleaf <- overleaf_path()


```




```{r dataset loading}

#Loading different final datasets from Box
#See Process Doc for details on cleaning code and clean datasets:
#https://docs.google.com/document/d/1Hpv5HF5ICO5FSVdQnPtDECCYORn2qy5S7C_KIx0pDuM/edit


#from Box

#bl_raw <- read_csv(paste0(user_path(), "/1_raw/Baseline follow up survey_WIDE.csv"))

#Baseline Survey
bl <- read_stata(paste0(user_path(), "/3_final/1_2_Followup_cleaned.dta"))

#Baseline Census
cen <- read_stata(paste0(user_path(),"/3_final/Final_HH_Odisha_consented_Full.dta"))

#Round 1 survey
r1 <- read_stata(paste0(user_path(),"/3_final/1_5_followup_R1_cleaned.dta"))

#Round 2 survey
r2 <- read_stata(paste0(user_path(),"/3_final/1_6_followup_R2_cleaned.dta"))

#Round 3 survey
r3 <- read_stata(paste0(user_path(),"/3_final/1_7_followup_R3_cleaned.dta"))

#Chlorine Monitoring Survey
mon <- read_stata(paste0(user_path(),"/3_final/1_X_chlorine_monitoring.dta"))

#Longitudinal chlorine monitoring form
mon_full <- read_csv("C:/Users/jerem/Box/India Water project/2_Pilot/Data/1_raw/india_ilc_pilot_monitoring_WIDE.csv")

#gv <- read_sheet(ss = "https://docs.google.com/spreadsheets/d/1OvZT-yk52h58-dpnSfBkXyEFR_Kb-p7O6PmQ8io4n-s/edit#gid=0", )

#Baseline IDEXX
idexx <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/BL_idexx_master_cleaned.csv"))

#Baseline ABR IDEXX
#abr <- read_xlsx("C:/Users/jerem/Box/India Water project/2_Pilot/Data/5_lab data/idexx/raw/_India ILC_ABR_data_MASTER.xlsx", skip = 1)

#IDEXX Round 1
idexx_r1 <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/R1_idexx_master_cleaned.csv"))


#IDEXX Round 2
idexx_r2 <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/R2_idexx_master_cleaned.csv"))

#IDEXX Round 3
idexx_r3 <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/R3_idexx_master_cleaned.csv"))

#Pooled IDEXX Rounds
idexx_tab <- read_csv(paste0(user_path(),"/5_lab data/idexx/cleaned/POOLED_idexx_master_cleaned.csv"))

#Checking Michelle's cleaned IDEXX data
idexx_mc <- read_stata(paste0(user_path(),"/2_deidentified/Ecoli results followup_cleaned_WIDE.dta"))

#Village Details
#village_details_old <- read_xlsx(paste0(user_path(),"/5_lab data/India_ILC_Pilot_Rayagada_Village_Tracking.xlsx")) #Old method

village_details <- read_sheet("https://docs.google.com/spreadsheets/d/1iWDd8k6L5Ny6KklxEnwvGZDkrAHBd0t67d-29BfbMGo/edit?pli=1#gid=1710429467")

#Village Details
villages <- read_stata(paste0(user_path(),"4_other/India ILC_Pilot_Rayagada Village Tracking_clean_final.dta" ))


#Cen final
cen_info <- read_stata(paste0(user_path(),"3_final/Final_Population_Village.dta" ))


#endline census
el <- read_stata(paste0(user_path(),"3_final/1_8_Endline_Census_cleaned.dta" ))


```


# Defining Functions

```{r defining misc functions}

#labelmaker
#Converts stata formatted data to R datasets with labels
#x: .dta file from Stata
labelmaker <- function(x){
  #Works best with Stata data to convert variable names to their labels
  z <- colnames(x)
  for(i in z){
    labels <-  val_labels(x[i])
    if(is.na(labels) == FALSE){
      x[i] <- to_label(x[i])
      
    }
  }
  return(x)
}



#Microbiological contamination descriptive stats

village_stats <- function(idexx_data){
  idexx_data%>%
  dplyr::group_by(village, sample_type) %>%
  dplyr::summarise(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
    "Median MPN E. coli/100 mL" = median(ec_mpn),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )

  
}



tc_stats <- function(idexx_data){
  
  tc <- idexx_data%>%
        group_by(assignment, sample_type) %>%
        summarise(
            "Number of Samples" = n(),
            "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
            #"Lower CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 - 
             # (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
            #"Upper CI - TC" = (sum(cf_pa == "Presence") / n()) * 100 + 
             # (qt(0.975, n() - 1) * sd(cf_pa_binary*100)/sqrt(n())),
            "Lower CI - TC" = { #Robust standard errors accounting for clustering at villages
            model <- glm(cf_pa_binary ~ 1, family = binomial)
            vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
            se <- sqrt(vcov_cluster[1, 1])
            est <- (sum(cf_pa == "Presence") / n()) * 100
            est - qt(0.975, df.residual(model)) * se
          },
          "Upper CI - TC" = { #Robust standard errors accounting for clustering at villages
            model <- glm(cf_pa_binary ~ 1, family = binomial)
            vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
            se <- sqrt(vcov_cluster[1, 1])
            est <- (sum(cf_pa == "Presence") / n()) * 100
            est + qt(0.975, df.residual(model)) * se
          },
          "% Positive for E. coli" = round((sum(ec_pa == "Presence") / n()) * 100, 1),
          #"Lower CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 - 
          # (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
          #"Upper CI - EC" = (sum(ec_pa == "Presence") / n()) * 100 + 
          #  (qt(0.975, n() - 1) * sd(ec_pa_binary*100)/sqrt(n())),
          "Lower CI - EC" = {
            model <- glm(ec_pa_binary ~ 1, family = binomial)
            vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
            se <- sqrt(vcov_cluster[1, 1])
            est <- (sum(ec_pa == "Presence") / n()) * 100
            est - qt(0.975, df.residual(model)) * se
          },
          "Upper CI - EC" = {
            model <- glm(ec_pa_binary ~ 1, family = binomial)
            vcov_cluster <- vcovCR(model, cluster = village, type = "CR2")
            se <- sqrt(vcov_cluster[1, 1])
            est <- (sum(ec_pa == "Presence") / n()) * 100
            est + qt(0.975, df.residual(model)) * se
          },
          "Median MPN E. coli/100 mL" = median(ec_mpn),
          "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
        )
  
  tc <- tc%>%
    #Adjusting so the CI cannot be more or less than 0 or 100
    mutate(`Lower CI - EC` = case_when(`Lower CI - EC` < 0 ~ 0,
                            `Lower CI - EC` >= 0 ~ `Lower CI - EC`))%>%
  mutate(`Upper CI - TC` = case_when(`Upper CI - TC` > 100 ~ 100,
                            `Upper CI - TC` <= 100 ~ `Upper CI - TC`))
  return(tc)
}




all_stats <- function(idexx_data){
  idexx_data%>%
  group_by(sample_type) %>%
  summarise(
    "Number of Samples" = n(),
    "% Positive for Total Coliform" = round((sum(cf_pa == "Presence") / n()) * 100, 1),
    "% Positive for E. coli" = round(mean(ec_pa_binary), 3)*100,
    "Average MPN E. coli/100 mL" = round(mean(ec_mpn),3),
    "Average Free Chlorine Concentration (mg/L)" = round(mean(fc_tap), 3)
  )
}


risk_stats <- function(idexx_data){
  idexx_data%>%
  group_by(assignment, ec_risk)%>%
  summarise(count = n())%>%
  mutate("E. coli Risk Levels %" = round(count/sum(count) * 100, 2))
}


#Regression results functions

#ilc_glm
#Runs generalized linear model for comparing control and treatment group outcomes
#data: overall dataset to pull from
#var: vector containing binary outcome variable names in each dataset to model
ilc_glm <- function(data, var){
    
  #Specifying the formula
  formula <- as.formula(paste(var, "~ assignment + block + panchayat_village"))
  #Running model
  model <- glm(formula, data = data, family = binomial)
  
  #Storing N
  N <- length(model$y)
  
  # Adjust for clustering at the village level
  cluster_vcov <- vcovCL(model, cluster = data$village, type = "HC1")
  # Get the coefficients with clustered standard errors
  clustered_results <- coeftest(model, vcov. = cluster_vcov)
    
  #Tidying models -- need to understand how to use clustered results option
  tidy_results <- tidy(clustered_results)
  # Rename the columns for better readability
  colnames(tidy_results) <- c("covariate", "estimate", "std_error", "z_statistic", "p_value")
  
  #Adding N
  tidy_results <- tidy_results%>%
    mutate(N = N)

  #exponentiate the estimates/std errors to get Odds Ratio
  
  tidy_results$estimate <- exp(tidy_results$estimate)
  tidy_results$std_error <- exp(tidy_results$std_error)
  
  
  return(tidy_results)
}



#ilc_lm
#Runs LINEAR model for comparing control and treatment group outcomes
#data: overall dataset to pull from
#var: vector containing outcome variable names in each dataset to model
ilc_lm <- function(data, var){
    
  #Specifying the formula
  formula <- as.formula(paste(var, "~ assignment + block + panchayat_village"))
  
  #Running model
  model <- lm(formula, data = data)
  
  #Storing N
  N <- length(model$residuals)
  
  # Adjust for clustering at the village level
  cluster_vcov <- vcovCL(model, cluster = data$village, type = "HC1")
  # Get the coefficients with clustered standard errors
  clustered_results <- coeftest(model, vcov. = cluster_vcov)
    
  #Tidying models -- need to understand how to use clustered results option
  tidy_results <- tidy(clustered_results)
  # Rename the columns for better readability
  colnames(tidy_results) <- c("covariate", "estimate", "std_error", "z_statistic", "p_value")
  
  #Adding N
  tidy_results <- tidy_results%>%
    mutate(N = N)

  return(tidy_results)
}





#ilc_model_table
#Converts model outputs to an organized latex table output using Kable()
#models: regression models to pull information from
ilc_model_table <- function(models = all_models){
  #Gathering model name information
  model_names <- names(models)
  
  #Initializing empty model table
  model_table <- data.frame(model_name = NULL, covariate = NULL, estimate = NULL,
                            std_error = NULL, p_value = NULL, signif = NULL, N = NULL)
  
  #Placing model into model_table
  for(i in (1:length(model_names))){
    one_model <- models[[i]]%>%
      data.frame()
    
    
    one_model <- one_model%>%
      dplyr::filter(covariate == "assignmentTreatment")%>%
      dplyr::select(!(z_statistic))%>% #Removing z statistic
      mutate(model_name = model_names[i])%>%
      dplyr::select(model_name, everything())%>% #moves model_name to front
      mutate(signif = case_when(p_value > 0.10 ~ " ",
                                p_value <= 0.10 & p_value > 0.05 ~ "*",
                                p_value <= 0.05 & p_value > 0.01 ~ "**",
                                p_value <= 0.01 ~ "***"))
    
    #Rounding numbers to 3 digits
    one_model[3:4] <- round(one_model[3:4], digits = 3)
      
    
  #Appending to model_table
    model_table <- rbind(model_table, one_model)
    
  }
  #Formatting Kable to print latex table
  model_table_kbl <- 
    kbl(model_table)%>%
    kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
    add_header_above(c("Regression Results " = 7)) %>%
    row_spec(0, bold = TRUE, color = "black", background = "white") %>%
    column_spec(1, bold = TRUE) %>%
    column_spec(2, width = "75px")
  
  return(model_table_kbl)
  
  }


```



\newpage
# Data Cleaning


```{r Data cleaning R code}

#Calling script to clean loaded data
source(paste0(github_path(),"/3_manuscript/India ILC Pilot - Manuscript Data Cleaning 2024.R"))


```


```{r Pairing BL and EL census data}

#Adding EL classification to the variables in the endline dataset
el_pair <- el%>%
  rename_with(~ paste0(., "_EL"))%>%
  rename(unique_id = "unique_id_EL")


paired <- inner_join(cen, el_pair, by = "unique_id")


```



\newpage
#Analysis


## Desc Stats - Household Characteristics

```{r}




```




## Chlorine Monitoring -- Household Surveys

```{r Chlorine Monitoring -- Surveys}




```


## Chlorine Monitoring -- Weekly

```{r Chlorine Monitoring -- Weekly}



```



## Desc Stats - Microbiological Contamination


```{r Defining functions to calculate stats}

```


###Baseline

```{r Microbiological Contamination - Baseline}

# Calculate descriptive statistics by village
village_stats_bl <- village_stats(idexx)

tc_stats_bl <- tc_stats(idexx)

all_stats_bl <- all_stats(idexx)




#Creating risk level stats for WHO Risk plot
risk_stats_bl <- risk_stats(idexx)


# Print the table
kbl(village_stats_bl)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 7)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats_bl)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 11)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(all_stats_bl)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("Baseline - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")



#Plotting IDEXX E. coli data per village
p1 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p1



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx) + 
  geom_boxplot(aes(x = sample_type, y = ec_log)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Baseline Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p4




#Plotting treatment/control stats on a bar plot
p_ec_bl <- ggplot(data = tc_stats_bl) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "BL - Oct 2023"
       #title = expression(paste(italic("E. coli"), " BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_bl <- ggplot(data = tc_stats_bl) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment",
       title = "BL - Oct 2023"
       #title = expression(paste(" BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_bl + p_ec_bl




#Making WHO risk plot
p_ec_risk_bl <- ggplot(data = risk_stats_bl) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "BL - Oct 2023"
       #title = expression(paste(" BL - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))



```

###Follow-up Surveys

####Need to figure out robust standard errors issues

```{r Microbiological Contamination -- Follow-up R1}


#Removing NA result
idexx_r1 <- idexx_r1%>%
  filter(is.na(ec_mpn) == FALSE)

# Calculate descriptive statistics by village
village_stats_r1 <- village_stats(idexx_r1)

tc_stats_r1 <- tc_stats(idexx_r1)


all_stats_r1 <- all_stats(idexx_r1)


#Creating risk level stats for WHO Risk plot
risk_stats_r1 <- risk_stats(idexx_r1)

# Print the table
kbl(village_stats_r1)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 7)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats_r1)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 11)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


kbl(all_stats_r1)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("R1 - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")




#Plotting chlorine concentrations against e. coli presence/absence
# p1 <- ggplot(data = idexx_r1) + 
#   geom_boxplot(aes(x = ec_pa, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Presence/Absence of E. coli", 
#        y = "Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps and Detection of E. coli")+
#   theme_bw()
# 
# p1


#need to correct
# #p2 <- ggplot(data = idexx_r1) + 
#   geom_col(aes(x = village, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Sample ID", 
#        y = "Average Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps in each village in Odisha")+
#   theme_bw()
# 
# p2


#Plotting IDEXX E. coli data per village
p3 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p3



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = sample_type, y = ec_log, fill = assignment)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Assignment",
       title = expression(paste(italic("E. coli"), " Follow-up 1 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p4


#Plotting IDEXX E. coli data per village
p5 <- ggplot(data = idexx_r1) + 
  geom_boxplot(aes(x = block, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Block", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Sample Type",
       title = expression(paste(italic("E. coli"), " R1 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p5


#Plotting treatment/control stats on a bar plot
p_ec_r1 <- ggplot(data = tc_stats_r1) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "R1 - February 2024"
       #title = expression(paste(italic("E. coli"), " R1 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r1 <- ggplot(data = tc_stats_r1) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment",
       title = "R1 - February 2024"
       #title = expression(paste(" R1 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r1 + p_ec_r1

#Fisher's Exact Test for differences between control and treatment
idexx_r1_stored <- idexx_r1%>%
  filter(sample_type == "Stored")

idexx_r1_tap <- idexx_r1%>%
  filter(sample_type == "Tap")

stored_cf <- fisher.test(x = idexx_r1_stored$assignment, y=idexx_r1_stored$cf_pa)

stored_ec <- fisher.test(x = idexx_r1_stored$assignment, y=idexx_r1_stored$ec_pa)

tap_cf <- fisher.test(x = idexx_r1_tap$assignment, y=idexx_r1_tap$cf_pa)

tap_ec <- fisher.test(x = idexx_r1_tap$assignment, y=idexx_r1_tap$ec_pa)

idexx_r1_signif <- data.frame(stored_cf$p.value, stored_ec$p.value, tap_cf$p.value, tap_ec$p.value)



#Making WHO risk plot
p_ec_risk_r1 <- ggplot(data = risk_stats_r1) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "R1 - February 2024"
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))





```


```{r Microbiological Contamination -- Follow-up R2}


#Removing NA result
idexx_r2 <- idexx_r2%>%
  filter(is.na(ec_mpn) == FALSE)%>%
  filter(sample_type != "Blank")%>% #Removing blanks
  filter(sample_type != "Solar") #Removing solar water samples

# Calculate descriptive statistics by village
village_stats_r2 <- village_stats(idexx_r2)

tc_stats_r2 <- tc_stats(idexx_r2)


all_stats_r2 <- all_stats(idexx_r2)


#Creating risk level stats for WHO Risk plot
risk_stats_r2 <- risk_stats(idexx_r2)

# Print the table
kbl(village_stats_r2)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r2 - Water Quality Test Results " = 7)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats_r2)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r2 - Water Quality Test Results " = 11)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


kbl(all_stats_r2)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r2 - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")




#Plotting chlorine concentrations against e. coli presence/absence
# p1 <- ggplot(data = idexx_r2) + 
#   geom_boxplot(aes(x = ec_pa, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Presence/Absence of E. coli", 
#        y = "Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps and Detection of E. coli")+
#   theme_bw()
# 
# p1


#need to correct
# #p2 <- ggplot(data = idexx_r2) + 
#   geom_col(aes(x = village, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Sample ID", 
#        y = "Average Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps in each village in Odisha")+
#   theme_bw()
# 
# p2


#Plotting IDEXX E. coli data per village
p3 <- ggplot(data = idexx_r2) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p3



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx_r2) + 
  geom_boxplot(aes(x = sample_type, y = ec_log, fill = assignment)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Assignment",
       title = expression(paste(italic("E. coli"), " Follow-up 1 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p4


#Plotting IDEXX E. coli data per village
p5 <- ggplot(data = idexx_r2) + 
  geom_boxplot(aes(x = block, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Block", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Sample Type",
       title = expression(paste(italic("E. coli"), " R2 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p5


#Plotting treatment/control stats on a bar plot
p_ec_r2 <- ggplot(data = tc_stats_r2) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "R2 - March 2024"
       #title = expression(paste(italic("E. coli"), " r2 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r2 <- ggplot(data = tc_stats_r2) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment",
       title = "R2 - March 2024"
       #title = expression(paste(" r2 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r2 + p_ec_r2

#Fisher's Exact Test for differences between control and treatment
idexx_r2_stored <- idexx_r2%>%
  filter(sample_type == "Stored")

idexx_r2_tap <- idexx_r2%>%
  filter(sample_type == "Tap")

stored_cf <- fisher.test(x = idexx_r2_stored$assignment, y=idexx_r2_stored$cf_pa)

stored_ec <- fisher.test(x = idexx_r2_stored$assignment, y=idexx_r2_stored$ec_pa)

tap_cf <- fisher.test(x = idexx_r2_tap$assignment, y=idexx_r2_tap$cf_pa)

tap_ec <- fisher.test(x = idexx_r2_tap$assignment, y=idexx_r2_tap$ec_pa)

idexx_r2_signif <- data.frame(stored_cf$p.value, stored_ec$p.value, tap_cf$p.value, tap_ec$p.value)



#Making WHO risk plot
p_ec_risk_r2 <- ggplot(data = risk_stats_r2) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "R2 - March 2024"
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))



```


```{r Microbiological Contamination -- Follow-up r3}


#Removing NA result
idexx_r3 <- idexx_r3%>%
  filter(is.na(ec_mpn) == FALSE)%>%
  filter(sample_type != "Blank")%>% #Removing blanks
  filter(sample_type != "Solar") #Removing solar water samples

# Calculate descriptive statistics by village
village_stats_r3 <- village_stats(idexx_r3)

tc_stats_r3 <- tc_stats(idexx_r3)


all_stats_r3 <- all_stats(idexx_r3)


#Creating risk level stats for WHO Risk plot
risk_stats_r3 <- risk_stats(idexx_r3)

# Print the table
kbl(village_stats_r3)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r3 - Water Quality Test Results " = 7)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")

kbl(tc_stats_r3)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r3 - Water Quality Test Results " = 11)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")


kbl(all_stats_r3)%>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE) %>%
  add_header_above(c("r3 - Water Quality Test Results " = 6)) %>%
  row_spec(0, bold = TRUE, color = "black", background = "white") %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, width = "75px")




#Plotting chlorine concentrations against e. coli presence/absence
# p1 <- ggplot(data = idexx_r3) + 
#   geom_boxplot(aes(x = ec_pa, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Presence/Absence of E. coli", 
#        y = "Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps and Detection of E. coli")+
#   theme_bw()
# 
# p1


#need to correct
# #p2 <- ggplot(data = idexx_r3) + 
#   geom_col(aes(x = village, y = fc_tap)) +
#   scale_y_continuous(breaks = c(0, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.80, 0.90, 1.00, 1.1),
#                      limits = c(0, 1.0),
#                      expand = c(0,0))+
#   labs(x = "Sample ID", 
#        y = "Average Free Chlorine Concentration (mg/L)",
#        title = "Chlorination of JJM Taps in each village in Odisha")+
#   theme_bw()
# 
# p2


#Plotting IDEXX E. coli data per village
p3 <- ggplot(data = idexx_r3) + 
  geom_boxplot(aes(x = village, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Village", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       title = expression(paste(italic("E. coli"), " Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p3



#Plotting IDEXX E. coli data by sample type
p4 <- ggplot(data = idexx_r3) + 
  geom_boxplot(aes(x = sample_type, y = ec_log, fill = assignment)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Assignment",
       title = expression(paste(italic("E. coli"), " Follow-up 1 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p4


#Plotting IDEXX E. coli data per village
p5 <- ggplot(data = idexx_r3) + 
  geom_boxplot(aes(x = block, y = ec_log, fill = sample_type)) +
  scale_y_continuous(
                     limits = c(0, 4),
                     expand = c(0,0))+
  labs(x = "Block", 
       y = expression(paste("log10(MPN ",italic("E. coli"), "/100 mL)")),
       fill = "Sample Type",
       title = expression(paste(italic("E. coli"), " r3 - Presence in Tap and Stored Drinking Water in Odisha (N = 160)")))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

#p5


#Plotting treatment/control stats on a bar plot
p_ec_r3 <- ggplot(data = tc_stats_r3) + 
  geom_col(aes(x = sample_type, y = `% Positive for E. coli`, fill = assignment), position = "dodge") +
  geom_errorbar(aes(x = sample_type, ymin = `Lower CI - EC`, ymax = `Upper CI - EC`,
                    fill = assignment), position = position_dodge(width = 0.9),
                width = 0.25) +
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for ",italic("E. coli"))),
       fill = "Assignment",
       title = "R3 - April 2024"
       #title = expression(paste(italic("E. coli"), " r3 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r3 <- ggplot(data = tc_stats_r3) + 
  geom_col(aes(x = sample_type, y = `% Positive for Total Coliform`, fill = assignment), position = "dodge") +
    geom_errorbar(aes(x = sample_type, ymin = `Lower CI - TC`, ymax = `Upper CI - TC`,
                      fill = assignment), position = position_dodge(width = 0.9),
                 width = 0.25) +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Sample Type", 
       y = expression(paste("% positive for total coliform")),
       fill = "Assignment",
       title = "R3 - April 2024"
       #title = expression(paste(" r3 - Presence in Tap and Stored Drinking Water in Odisha (N = 166)"))
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

p_cf_r3 + p_ec_r3

#Fisher's Exact Test for differences between control and treatment
idexx_r3_stored <- idexx_r3%>%
  filter(sample_type == "Stored")

idexx_r3_tap <- idexx_r3%>%
  filter(sample_type == "Tap")

stored_cf <- fisher.test(x = idexx_r3_stored$assignment, y=idexx_r3_stored$cf_pa)

stored_ec <- fisher.test(x = idexx_r3_stored$assignment, y=idexx_r3_stored$ec_pa)

tap_cf <- fisher.test(x = idexx_r3_tap$assignment, y=idexx_r3_tap$cf_pa)

tap_ec <- fisher.test(x = idexx_r3_tap$assignment, y=idexx_r3_tap$ec_pa)

idexx_r3_signif <- data.frame(stored_cf$p.value, stored_ec$p.value, tap_cf$p.value, tap_ec$p.value)



#Making WHO risk plot
p_ec_risk_r3 <- ggplot(data = risk_stats_r3) + 
  geom_bar(aes(x = assignment, y = `E. coli Risk Levels %`, fill = ec_risk), position = "stack", stat = "identity") +
  #geom_signif(comparisons = list(c("Control", "Treatment"), map_signif_level = TRUE))+
  scale_y_continuous(
                     limits = c(0, 100),
                     expand = c(0,0))+
  labs(x = "Assignment", 
       y = expression(paste("% for each risk category")),
       fill = expression(paste(italic("E. coli"), " Risk Categories")),
       title = "r3 - March 2024"
       )+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))



```




##Regression Results Table -- Household Surveys

```{r Regression Results -- WASH variables, results='asis', output.dir = "C:/Users/jerem/Dropbox/Apps/Overleaf/India ILC Pilot- analysis"}


#Subsetting datasets with key variables
bl_tab <- bl%>%
  dplyr::select(assignment, unique_id, sample_ID_tap, sample_ID_stored, 
                village, block, panchayat_village,
                prim_source, prim_source_jjm, sec_source, jjm_drinking, water_treat_binary,
                tap_trust_binary, tap_taste_binary, tap_future_binary, 
                fc_tap_avg, fc_stored_avg, fc_tap_binary, fc_stored_binary)%>%
  mutate(data_round = "BL")

r1_tab <- r1%>%
  dplyr::select(assignment, unique_id, sample_ID_tap, sample_ID_stored, 
                village, block, panchayat_village,
                prim_source, prim_source_jjm, sec_source, jjm_drinking, water_treat_binary,
                tap_trust_binary, tap_taste_binary, tap_future_binary, 
                fc_tap_avg, fc_stored_avg, fc_tap_binary, fc_stored_binary)%>%
  mutate(data_round = "R1")

r2_tab <- r2%>%
  dplyr::select(assignment, unique_id, sample_ID_tap, sample_ID_stored, 
                village, block, panchayat_village,
                prim_source, prim_source_jjm, sec_source, jjm_drinking, water_treat_binary,
                tap_trust_binary, tap_taste_binary, tap_future_binary, 
                fc_tap_avg, fc_stored_avg, fc_tap_binary, fc_stored_binary)%>%
  mutate(data_round = "R2")

r3_tab <- r3%>%
  dplyr::select(assignment, unique_id, sample_ID_tap, sample_ID_stored, 
                village, block, panchayat_village,
                prim_source, prim_source_jjm, sec_source, jjm_drinking, water_treat_binary,
                tap_trust_binary, tap_taste_binary, tap_future_binary, 
                fc_tap_avg, fc_stored_avg, fc_tap_binary, fc_stored_binary)%>%
  mutate(data_round = "R3")

#Combining Datasets
all_tab <- rbind(bl_tab, r1_tab, r2_tab, r3_tab)


#Summarizing EL data and running regression models ----

#Selecting outcome variables
binary_vars <- c("prim_source_jjm", "sec_source", "jjm_drinking", "water_treat_binary",
                 "tap_trust_binary", "tap_taste_binary", "tap_future_binary",
                 "fc_tap_binary", "fc_stored_binary")



#GT method
#Summarizing desc stats for each variable
#reset_gtsummary_theme()

desc_stats <- all_tab%>%
  dplyr::select("assignment","data_round","prim_source_jjm", "sec_source", "jjm_drinking", "water_treat_binary","tap_trust_binary", "tap_taste_binary", "tap_future_binary","fc_tap_binary", "fc_stored_binary")%>%
  tbl_strata(
    strata = data_round,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = assignment, 
                    missing = "no",
                    type = c("prim_source_jjm", "sec_source", "jjm_drinking",
                             "water_treat_binary", "tap_trust_binary", "tap_taste_binary",
                             "tap_future_binary","fc_tap_binary",
                             "fc_stored_binary") ~ "continuous",
                    statistic = list(
                      all_continuous() ~ "{mean} ({sd})",
                      all_categorical() ~ "{p}%"),
                    digits = list(all_continuous() ~ 2, 
                                  all_categorical() ~ 0),
                    label = list(prim_source_jjm ~ "Government-provided tap as primary source",
                                 sec_source ~ "Use of a secondary source",
                                 jjm_drinking ~ "Use of government-provided taps for drinking",
                                 water_treat_binary ~ "Water treatment used",
                                 tap_trust_binary ~ "Trust in safety of taps",
                                 tap_taste_binary ~ "Satisfaction with taste from taps",
                                 tap_future_binary ~ "Likelihood of using taps in future",
                                 fc_tap_binary ~ "Presence of free chlorine in taps (>0.1 mg/L)",
                                 fc_stored_binary ~ "Presence of free chlorine in stored water (>0.1 mg/L)"
                                 )
                    )%>%
     modify_footnote(all_stat_cols() ~ "Mean (SD)"),
    .header = "**{strata}**"
  )%>%
  modify_footnote(update =  ~ "Mean (SD); BL - Oct 2023, R1 - February 2024, R2 - March 2024, R3 - April 2024")

desc_stats <- as_gt(desc_stats)%>%
  tab_options(table.font.size = 11)

#desc_stats


#Running regression models for each variable in the dataset

#Variables
outcome_vars <- c("prim_source_jjm", "sec_source", "jjm_drinking", "water_treat_binary", "tap_trust_binary", "tap_taste_binary", "tap_future_binary")

#Running all models
#Logistic regression
all_models <- lapply(outcome_vars, 
                     function(var){ #This functions "subsets" the ilc_glm function
                       ilc_glm(data = bl_tab, var)
                     }
                       )
#linear regression
all_models <- lapply(outcome_vars, 
                     function(var){ #This functions "subsets" the ilc_glm function
                       ilc_lm(data = bl_tab, var)
                     }
                       )

#Assigning names to models
names(all_models) <- outcome_vars

#Making regression table output
ilc_model_table(all_models)


```


##Regression Results Table -- Microbiological Contamination

```{r Regression Results - Microbio contamination}

#Selecting followup survey data only, dropping baseline
 idexx_fu <- idexx_tab%>%
   filter(pooled_round == "FU")




#checking michelle's code for cases of IDEXX tests that do not match ---------
idexx_check <- idexx_mc%>%
  filter(!(unique_id %in% unique(idexx_fu$unique_id)))
#One ID which does match. In Michelle's data it's 1234567, which is not a real ID
#Michelle's data doesn't include sample IDs unfortunately...
idexx_check <- idexx_fu%>%
  filter(!(unique_id %in% unique(idexx_mc$unique_id)))
#No unique household IDs in my data that are not in Michelle's data
#My data has 245 stored water samples and 241 tap samples. There are 4 more stored samples than in Michelle's data. The tap sample seem to align.

#Tables
table(idexx_mc$round)
table(idexx_fu$data_round)
#it looks like michelle has 81 households in R1 and R2. I have 83 in R1 and 80 in R2. R3 has the same
#Looks like 1 sample is Michelle's R2 shouldn't be there

#checking additional cases in R2
idexx_check <- idexx_mc%>%
  filter(village == 10101) #There are 5 households sampled in Nathma 10101 in R2. The 1234567 household doesn't exist and should be removed? Need to check



#Separating stored vs tap water tests ------
idexx_ids <- idexx_tab%>%
  dplyr::select(assignment, village, block, panchayat_village, data_round, sample_ID, bag_ID_tap, bag_ID_stored)

idexx_tab_tap <- idexx_tab%>%
  filter(sample_type == "Tap")%>%
  filter(pooled_round == "FU")%>%
  dplyr::select(sample_ID, assignment, village, block, panchayat_village, data_round, pooled_round, cf_pa_binary, ec_pa_binary, cf_log, ec_log)%>%
  rename(cf_pa_tap = "cf_pa_binary")%>%
  rename(ec_pa_tap = "ec_pa_binary")%>%
  rename(cf_log_tap = "cf_log")%>%
  rename(ec_log_tap = "ec_log")

idexx_tab_stored <- idexx_tab%>%
  filter(sample_type == "Stored")%>%
  filter(pooled_round == "FU")%>%
  dplyr::select(sample_ID, assignment, village, block, panchayat_village, data_round, pooled_round, cf_pa_binary, ec_pa_binary, cf_log, ec_log)%>%
  rename(cf_pa_stored = "cf_pa_binary")%>%
  rename(ec_pa_stored = "ec_pa_binary")%>%
  rename(cf_log_stored = "cf_log")%>%
  rename(ec_log_stored = "ec_log")


#Pivoting wider
# idexx_tab <- idexx_tab%>%
#   dplyr::select(sample_ID, sample_type, assignment, data_round, pooled_round, cf_pa_binary, ec_pa_binary, cf_log, ec_log)
# 
# idexx_tab <- idexx_tab%>%
#   pivot_wider(names_from = sample_type, values_from = c("cf_pa_binary", "ec_pa_binary", "cf_log", "ec_log"))%>%
#   rename(cf_pa_tap = "cf_pa_binary_Tap")%>%
#   rename(ec_pa_tap = "ec_pa_binary_Tap")%>%
#   rename(cf_log_tap = "cf_log_Tap")%>%
#   rename(ec_log_tap = "ec_log_Tap")%>%
#   rename(cf_pa_stored = "cf_pa_binary_Stored")%>%
#   rename(ec_pa_stored = "ec_pa_binary_Stored")%>%
#   rename(cf_log_stored = "cf_log_Stored")%>%
#   rename(ec_log_stored = "ec_log_Stored")


#idexx_tab <- left_join(idexx_ids, idexx_tab_tap, by = c("sample_ID", "bag_ID_tap"))










#Summarizing desc stats --------------------------------------

#Tap water

desc_stats <- idexx_tab_tap%>%
  dplyr::select(assignment, pooled_round, cf_pa_tap, ec_pa_tap, cf_log_tap, ec_log_tap
                )%>%
  tbl_strata(
    strata = pooled_round,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = assignment, 
                    missing = "no",
                    type = c("cf_pa_tap", "ec_pa_tap", "cf_log_tap",
                             "ec_log_tap") ~ "continuous",
                    statistic = list(
                      all_continuous() ~ "{mean} ({sd})",
                      all_categorical() ~ "{p}%"),
                    digits = list(all_continuous() ~ 2, 
                                  all_categorical() ~ 0),
                    label = list(cf_pa_tap ~ "Tap - Presence/Absence of Total Coliform",
                                 ec_pa_tap ~ "Tap - Presence/Absence of E. coli",
                                 cf_log_tap ~ "Tap - Mean Log10 of Total Coliform",
                                 ec_log_tap ~ "Tap - Mean Log10 of E. coli"
                                )
                    )%>%
     modify_footnote(all_stat_cols() ~ "Mean (SD)"),
    .header = "**{strata}**"
  )%>%
  modify_footnote(update =  ~ "Mean (SD); BL - Baseline, FU - Followup")

desc_stats_tap <- as_gt(desc_stats)%>%
  tab_options(table.font.size = 11)

#desc_stats_tap



#Stored water


desc_stats <- idexx_tab_stored%>%
  dplyr::select(assignment, pooled_round, cf_pa_stored, ec_pa_stored, cf_log_stored, ec_log_stored
                )%>%
  tbl_strata(
    strata = pooled_round,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = assignment, 
                    missing = "no",
                    type = c("cf_pa_stored", "ec_pa_stored", "cf_log_stored",
                             "ec_log_stored") ~ "continuous",
                    statistic = list(
                      all_continuous() ~ "{mean} ({sd})",
                      all_categorical() ~ "{p}%"),
                    digits = list(all_continuous() ~ 2, 
                                  all_categorical() ~ 0),
                    label = list(cf_pa_stored ~ "Stored - Presence/Absence of Total Coliform",
                                 ec_pa_stored ~ "Stored - Presence/Absence of E. coli",
                                 cf_log_stored ~ "Stored - Mean Log10 of Total Coliform",
                                 ec_log_stored ~ "Stored - Mean Log10 of E. coli"
                                )
                    )%>%
     modify_footnote(all_stat_cols() ~ "Mean (SD)"),
    .header = "**{strata}**"
  )%>%
  modify_footnote(update =  ~ "Mean (SD); BL - Baseline, FU - Followup")

desc_stats_stored <- as_gt(desc_stats)%>%
  tab_options(table.font.size = 11)

#desc_stats_stored



#Running regression model results --------------------------------------------


#Tap Water
#Variables
outcome_vars <- c("cf_pa_tap", "ec_pa_tap", "cf_log_tap", "ec_log_tap")

#Running all models
#Logistic regression
#all_models <- lapply(outcome_vars, 
 #                    function(var){ #This functions "subsets" the ilc_glm function
  #                     ilc_glm(data = idexx_tab_tap, var)
   #                  }
    #                   )
#linear regression
all_models <- lapply(outcome_vars, 
                     function(var){ #This functions "subsets" the ilc_glm function
                       ilc_lm(data = idexx_tab_tap, var)
                     }
                       )

#Assigning names to models
names(all_models) <- outcome_vars

#Formatting table output
ilc_model_table(all_models)


#Stored Water
#Variables
outcome_vars <- c("cf_pa_stored", "ec_pa_stored", "cf_log_stored", "ec_log_stored")

#Running all models
#Logistic regression
#all_models <- lapply(outcome_vars, 
 #                    function(var){ #This functions "subsets" the ilc_glm function
  #                     ilc_glm(data = idexx_tab_stored, var)
   #                  }
    #                   )
#linear regression
all_models <- lapply(outcome_vars, 
                     function(var){ #This functions "subsets" the ilc_glm function
                       ilc_lm(data = idexx_tab_stored, var)
                     }
                       )

#Assigning names to models
names(all_models) <- outcome_vars


#Formatting table output
ilc_model_table(all_models)
















```


##Regression Results Table -- Baseline and Endline

```{r Regression Results -- Endline, results='asis', output.dir = "C:/Users/jerem/Dropbox/Apps/Overleaf/India ILC Pilot- analysis"}

#Baseline Census------------------------------------------------------------
#Subsetting datasets with key variables

cen_tab <- cen%>%
  dplyr::select(assignment, unique_id, 
                village, block, panchayat_village,
                prim_source, prim_source_jjm, sec_source, jjm_drinking, water_treat_binary
                )%>%
  mutate(data_round = "BL")




#Summarizing BL census data and running regression models ----

#Selecting variables
outcome_vars <- c("prim_source_jjm", "sec_source", "jjm_drinking", "water_treat_binary")


#GT method
#Summarizing desc stats for each variable
desc_stats <- cen_tab%>%
  dplyr::select("assignment", "prim_source_jjm", "sec_source", "jjm_drinking", "water_treat_binary")%>%
  tbl_summary(
  by = assignment,
  statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} / {N} ({p}%)"),
  digits = all_continuous() ~ 2
)%>%
  add_p()



#Running all models
#Logistic regression
#all_models <- lapply(outcome_vars, 
 #                    function(var){ #This functions "subsets" the ilc_glm function
  #                     ilc_glm(data = el_tab, var)
   #                  }
    #                   )
#linear regression
all_models <- lapply(outcome_vars, 
                     function(var){ #This functions "subsets" the ilc_glm function
                       ilc_lm(data = cen_tab, var)
                     }
                       )

#Assigning names to models
names(all_models) <- outcome_vars

#Formatting table output
#ilc_model_table(all_models) #Need to fix






#Endline Census-------------------------------------------------------------
#Subsetting datasets with key variables

el_tab <- el%>%
  dplyr::select(assignment, unique_id, 
                village, block, panchayat_village,
                prim_source, prim_source_jjm, sec_source, jjm_drinking, water_treat_binary
                )%>%
  mutate(data_round = "EL")




#Summarizing EL data and running regression models ----

#Selecting variables
outcome_vars <- c("prim_source_jjm", "sec_source", "jjm_drinking", "water_treat_binary")


#GT method
#Summarizing desc stats for each variable
desc_stats <- el_tab%>%
  dplyr::select("assignment", "prim_source_jjm", "sec_source", "jjm_drinking", "water_treat_binary")%>%
  tbl_summary(
  by = assignment,
  statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} / {N} ({p}%)"),
  digits = all_continuous() ~ 2
)%>%
  add_p()



#Running all models
#Logistic regression
#all_models <- lapply(outcome_vars, 
 #                    function(var){ #This functions "subsets" the ilc_glm function
  #                     ilc_glm(data = el_tab, var)
   #                  }
    #                   )
#linear regression
all_models <- lapply(outcome_vars, 
                     function(var){ #This functions "subsets" the ilc_glm function
                       ilc_lm(data = el_tab, var)
                     }
                       )

#Assigning names to models
names(all_models) <- outcome_vars

#Formatting table output
ilc_model_table(all_models)




```




## Example/test code

```{r old robust standard error code}

#Taken from WASHPaLS analysis


#

#AEL_sandwich <- adjusted%>%
 # vcovCL(cluster = AEL_glm$village.x)

#robust_adjusted <- coeftest(adjusted, vcov. = AEL_sandwich) -- Code formerly used to calculate std errors
#Important to note that the code below already exponentiates the coefficients and std errors


# std.err <- sqrt(diag(AEL_sandwich))
# std.err <- std.err[1:((length(std.err)-4))]
# robust_adjusted <- tibble("pr"= exp(coef(adjusted)), "Std. Error" = exp(std.err),
# "Pr(>|z|)" = 2 * pnorm(abs(coef(adjusted)/std.err), lower.tail=FALSE),
# "LL" = exp(coef(adjusted) - 1.96 * (std.err)),
# "UL" = exp(coef(adjusted) + 1.96 * (std.err)))
# 
# #Creating readable 95% CI based on LL and UL
# robust_adjusted <- tibble(robust_adjusted,
#                            CI = paste("[", as.character(round(robust_adjusted$LL, digits = 3)), ",", as.character(round(robust_adjusted$UL, digits = 3)), "]"))
# 
# 
# #Storing values to final results tibble
# adjusted_pr <- robust_adjusted$pr[1]
# adjusted_ci <- robust_adjusted$CI[1]
# adjusted_p <- robust_adjusted$`Pr(>|z|)`[1]
# 
# 
# 
# outcome_result <- tibble(outcome = outcome,
#                   unadjusted_or = unadjusted_pr,
#                   unadjusted_ci = unadjusted_ci,
#                   unadjusted_p = unadjusted_p,
#                   adjusted_or = adjusted_pr,
#                   adjusted_ci = adjusted_ci,
#                   adjusted_p = adjusted_p,
#                   n = n)
# 






#Stargazer Method ---- 
#Calculating desc stats
#stargazer(el_tab[binary_vars], type = "latex", title = "Descriptive Statistics", out = "Manuscript_endline.tex")


#Running all models
# all_models <- lapply(binary_vars, 
#                      function(var) {
#                        formula <- as.formula(paste(var, "~ assignment + block + panchayat_village"))
#                        glm(formula, data = el_tab, family = "binomial")
# })

#Creating tables
# stargazer(all_models, type = "latex", title = "Regression Results", 
#           dep.var.labels = binary_vars, 
#           covariate.labels = c("Treatment", "Block (fixed effects)", "Panchayat Village (fixed effects)"),
#           omit = c("block", "panchayat_village"),
#           omit.labels = c("Block fixed effects", "Panchayat Village fixed effects"),
#           align = TRUE, no.space = TRUE, out = "manuscript_regression_results.tex")

#Outputting to overleaf








#Test code ------------------------------------------------------------------


#GT method
#Summarizing desc stats for each variable
#reset_gtsummary_theme()

#assignment, pooled_round, cf_pa_binary, ec_pa_binary, cf_log, ec_log
# desc_stats <- idexx_tab%>%
#   dplyr::select(assignment, pooled_round, cf_pa_tap, ec_pa_tap, cf_log_tap, ec_log_tap,
#                 cf_pa_stored, ec_pa_stored, cf_log_stored, ec_log_stored)%>%
#   tbl_strata(
#     strata = pooled_round,
#     .tbl_fun =
#       ~ .x %>%
#         tbl_summary(by = assignment, 
#                     missing = "no",
#                     type = c("cf_pa_tap", "ec_pa_tap", "cf_log_tap", "ec_log_tap",
#                 "cf_pa_stored", "ec_pa_stored", "cf_log_stored", "ec_log_stored") ~ "continuous",
#                     statistic = list(
#                       all_continuous() ~ "{mean} ({sd})",
#                       all_categorical() ~ "{p}%"),
#                     digits = list(all_continuous() ~ 2, 
#                                   all_categorical() ~ 0),
#                     label = list(cf_pa_tap ~ "Tap - Presence/Absence of Total Coliform",
#                                  ec_pa_tap ~ "Tap - Presence/Absence of E. coli",
#                                  cf_log_tap ~ "Tap - Mean Log10 of Total Coliform",
#                                  ec_log_tap ~ "Tap - Mean Log10 of E. coli",
#                                  cf_pa_stored ~ "Stored - Presence/Absence of Total Coliform",
#                                  ec_pa_stored ~ "Stored - Presence/Absence of E. coli",
#                                  cf_log_stored ~ "Stored - Mean Log10 of Total Coliform",
#                                  ec_log_stored ~ "Stored - Mean Log10 of E. coli"
#                                  )
#                     )%>%
#      modify_footnote(all_stat_cols() ~ "Mean (SD)"),
#     .header = "**{strata}**"
#   )%>%
#   modify_footnote(update =  ~ "Mean (SD); BL - Oct 2023, R1 - February 2024, R2 - March 2024, R3 - April 2024")
# 
# desc_stats <- as_gt(desc_stats)%>%
#   tab_options(table.font.size = 11)
# 
# desc_stats
# 



```





## Stata Translation

```{r Akito Stata translation}
# 
# # Load necessary libraries
# library(dplyr)
# library(tidyr)
# library(ggplot2)
# library(broom)
# 
# # Function to generate descriptive tables
# generate_descriptive_tables <- function(data, output_path) {
#   # Number of child-bearing age women
#   child_bearing_age_women <- data %>%
#     filter(R_Cen_a6_hhmember_age_ >= 15 & R_Cen_a6_hhmember_age_ <= 49 & R_Cen_a4_hhmember_gender_ == 2) %>%
#     group_by(village) %>%
#     summarise(count_1 = sum(!is.na(R_Cen_a6_hhmember_age_)))
#   print(summary(child_bearing_age_women$count_1))
#   # Number of children
#   children <- data %>%
#     filter(R_Cen_a6_hhmember_age_ >= 0 & R_Cen_a6_hhmember_age_ <= 14) %>%
#     group_by(village) %>%
#     summarise(count_1 = sum(!is.na(R_Cen_a6_hhmember_age_)))
#   print(summary(children$count_1))
#   # Number of pregnant women on average
#   pregnant_women <- data %>%
#     filter(R_Cen_a23_wom_diarr_day_ != . | R_Cen_a23_wom_diarr_week_ != . | R_Cen_a23_wom_diarr_2week_ != .) %>%
#     group_by(village) %>%
#     summarise(count_1 = sum(!is.na(R_Cen_a23_wom_diarr_day_)),
#               count_2 = sum(R_Cen_a6_hhmember_age_ >= 15 & R_Cen_a6_hhmember_age_ <= 49 & R_Cen_a4_hhmember_gender_ == 2)) %>%
#     mutate(perc_preg_women = count_1 / 192.22)
#   print(summary(pregnant_women$perc_preg_women))
#   # Number of U5 children on average
#   U5_children <- data %>%
#     filter(R_Cen_a6_hhmember_age_ < 5) %>%
#     group_by(village) %>%
#     summarise(count_1 = sum(!is.na(R_Cen_a6_hhmember_age_)),
#               count_2 = sum(R_Cen_a6_hhmember_age_ >= 0 & R_Cen_a6_hhmember_age_ <= 14)) %>%
#     mutate(perc_U5child = count_1 / 192.22)
#   print(summary(U5_children$perc_U5child))
#   # Number and average pregnant women + children <5 years per village
#   pregnant_women_children <- data %>%
#     filter(R_Cen_a23_wom_diarr_day_ != . | R_Cen_a23_wom_diarr_week_ != . | R_Cen_a23_wom_diarr_2week_ != . | R_Cen_a6_hhmember_age_ < 5) %>%
#     group_by(village) %>%
#     summarise(count_1 = sum(!is.na(R_Cen_a23_wom_diarr_day_) | !is.na(R_Cen_a6_hhmember_age_ < 5)),
#               count_2 = sum((R_Cen_a6_hhmember_age_ >= 15 & R_Cen_a6_hhmember_age_ <= 49 & R_Cen_a4_hhmember_gender_ == 2) | (R_Cen_a6_hhmember_age_ >= 0 & R_Cen_a6_hhmember_age_ <= 14))) %>%
#     mutate(perc_total = count_1 / 192.22)
#   print(summary(pregnant_women_children$perc_total))
# }
# # Load data
# data <- read.csv(path_to_data.csv)
# # Generate descriptive tables
# generate_descriptive_tables(data, output_path)
# # Number of HHs with pregnant women and children <5 years per village
# hh_pregnant_children <- data %>%
#   mutate(count1 = 1) %>%
#   rowwise() %>%
#   mutate(C_total_pregnant = sum(c_across(starts_with(R_Cen_a7_pregnant)) == 1, na.rm = TRUE)) %>%
#   ungroup() %>%
#   mutate(count2 = ifelse(C_total_pregnant > 0, 1, 0),
#          count3 = ifelse(R_Cen_screen_u5child == 1, 1, 0),
#          count4 = ifelse(C_Screened == 1, 1, 0)) %>%
#   group_by(R_Cen_village_name) %>%
#   summarise(count1 = sum(count1, na.rm = TRUE),
#             count2 = sum(count2, na.rm = TRUE),
#             count3 = sum(count3, na.rm = TRUE),
#             count4 = sum(count4, na.rm = TRUE)) %>%
#   mutate(perc_hh_preg = count2 / count1,
#          perc_hh_U5 = count3 / count1,
#          perc_hh_screened = count4 / count1)
# print(summary(hh_pregnant_children))
# # JJM access and other main vars - distribution by categories
# jjm_access <- data %>%
#   filter(!village %in% c(50601, 30601)) %>%
#   group_by(village) %>%
#   summarise(across(starts_with("R_Cen_a18"), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE))))
# print(jjm_access)
# # Water sources
# water_sources <- data %>%
#   filter(!village %in% c(50601, 30601)) %>%
#   group_by(village) %>%
#   summarise(across(starts_with(R_Cen_a12_ws_prim), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE))),
#             across(starts_with(R_Cen_a13_ws_sec), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE))))
# print(water_sources)
# # Number of water sources people have
# water_sources_people <- data %>%
#   filter(!village %in% c(50601, 30601)) %>%
#   mutate(count_secondary_sources = rowSums(select(., starts_with(R_Cen_a13_ws_sec)), na.rm = TRUE),
#          count_primary_sources = rowSums(select(., starts_with(R_Cen_a12_ws_prim)), na.rm = TRUE),
#          total_num_sources = count_secondary_sources + count_primary_sources)
# print(water_sources_people)
# # JJM uses
# jjm_uses <- data %>%
#   filter(!village %in% c(50601, 30601)) %>%
#   group_by(village) %>%
#   summarise(across(starts_with(C_Cen_a18_jjm), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE))))
# print(jjm_uses)
# # Water treatment
# water_treatment <- data %>%
#   filter(!village %in% c(50601, 30601)) %>%
#   group_by(village) %>%
#   summarise(across(starts_with(R_Cen_a16_water_treat), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE))),
#             across(starts_with(R_Cen_a17_water_treat_kids), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE))))
# print(water_treatment)
# # Water treatment frequency
# water_treatment_freq <- data %>%
#   filter(!village %in% c(50601, 30601)) %>%
#   group_by(village) %>%
#   summarise(across(starts_with(R_Cen_a16_water_treat_freq), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE))),
#             across(starts_with(R_Cen_a17_treat_kids_freq), list(mean = ~mean(.x, na.rm = TRUE), sd = ~sd(.x, na.rm = TRUE))))
# print(water_treatment_freq)



```



